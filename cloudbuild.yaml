steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: Build Docker Images
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: "gcr.io/cloud-builders/docker"
    id: "build-api"
    args:
      [
        "build",
        "-t",
        "gcr.io/$PROJECT_ID/cis-api:$COMMIT_SHA",
        "-f",
        "Dockerfile.api",
        ".",
      ]

  - name: "gcr.io/cloud-builders/docker"
    id: "build-frontend"
    args:
      [
        "build",
        "--no-cache",
        "-t",
        "gcr.io/$PROJECT_ID/cis-frontend:$COMMIT_SHA",
        "-f",
        "Dockerfile.frontend",
        ".",
      ]

  # Slack: Build complete
  - name: "gcr.io/cloud-builders/curl"
    id: "notify-build-complete"
    entrypoint: "sh"
    secretEnv: ["SLACK_WEBHOOK_URL"]
    args:
      - "-c"
      - |
        curl -X POST $$SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "ğŸ”¨ *Build Complete*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… Docker images built successfully\n*Commit:* `$SHORT_SHA`\n*Branch:* master"
                }
              }
            ]
          }' || echo "Slack notification failed (non-critical)"
    waitFor: ["build-api", "build-frontend"]

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: Push to Container Registry
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: "gcr.io/cloud-builders/docker"
    id: "push-api"
    args: ["push", "gcr.io/$PROJECT_ID/cis-api:$COMMIT_SHA"]
    waitFor: ["build-api"]

  - name: "gcr.io/cloud-builders/docker"
    id: "push-frontend"
    args: ["push", "gcr.io/$PROJECT_ID/cis-frontend:$COMMIT_SHA"]
    waitFor: ["build-frontend"]

  # Slack: Images pushed
  - name: "gcr.io/cloud-builders/curl"
    id: "notify-push-complete"
    entrypoint: "sh"
    secretEnv: ["SLACK_WEBHOOK_URL"]
    args:
      - "-c"
      - |
        curl -X POST $$SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "ğŸ“¦ *Images Pushed to GCR*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… Images pushed to Container Registry\n*Tag:* `$SHORT_SHA`"
                }
              }
            ]
          }' || echo "Slack notification failed (non-critical)"
    waitFor: ["push-api", "push-frontend"]

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: Deploy to Cloud Run
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-api"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "cis-api"
      - "--image=gcr.io/$PROJECT_ID/cis-api:$COMMIT_SHA"
      - "--region=us-central1"
      - "--platform=managed"
      - "--allow-unauthenticated"
      - "--update-secrets=STRIPE_SECRET_KEY=STRIPE_SECRET_KEY:latest"
      - "--update-secrets=STRIPE_PUBLISHABLE_KEY=STRIPE_PUBLISHABLE_KEY:latest"
      - "--update-secrets=STRIPE_PRICE_PRO=STRIPE_PRICE_PRO:latest"
      - "--update-secrets=STRIPE_PRICE_BUSINESS=STRIPE_PRICE_BUSINESS:latest"
      - "--update-secrets=STRIPE_WEBHOOK_SECRET_CIS_PRODUCTION=STRIPE_WEBHOOK_SECRET_CIS_PRODUCTION:latest"
      - "--update-secrets=STRIPE_WEBHOOK_SECRET_ENGAGING_VICTORY=STRIPE_WEBHOOK_SECRET_ENGAGING_VICTORY:latest"
      - "--set-env-vars=GOOGLE_CLOUD_PROJECT=$PROJECT_ID"
    waitFor: ["push-api"]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-frontend"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "cis-frontend"
      - "--image=gcr.io/$PROJECT_ID/cis-frontend:$COMMIT_SHA"
      - "--region=us-central1"
      - "--platform=managed"
      - "--allow-unauthenticated"
    waitFor: ["push-frontend"]

  # Slack: Deployment complete
  - name: "gcr.io/cloud-builders/curl"
    id: "notify-deploy-complete"
    entrypoint: "sh"
    secretEnv: ["SLACK_WEBHOOK_URL"]
    args:
      - "-c"
      - |
        curl -X POST $$SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "ğŸš€ *Deployment Complete*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "âœ… Services deployed to Cloud Run\n*API:* cis-api\n*Frontend:* cis-frontend\n*Commit:* `$SHORT_SHA`"
                }
              }
            ]
          }' || echo "Slack notification failed (non-critical)"
    waitFor: ["deploy-api", "deploy-frontend"]

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: Final Email Notification (Only at the end)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: "gcr.io/cloud-builders/curl"
    id: "notify-email-final"
    entrypoint: "sh"
    secretEnv: ["SENDGRID_API_KEY"]
    args:
      - "-c"
      - |
        curl -X POST https://api.sendgrid.com/v3/mail/send \
          -H "Authorization: Bearer $$SENDGRID_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "personalizations": [{
              "to": [{"email": "${_ADMIN_EMAIL}"}]
            }],
            "from": {"email": "kunalsbhatt@gmail.com", "name": "GNX-CIS Deployment"},
            "subject": "âœ… Deployment Complete - Commit $SHORT_SHA",
            "content": [{
              "type": "text/html",
              "value": "<h2>ğŸ‰ Deployment Successfully Completed</h2><p><strong>Commit:</strong> $SHORT_SHA</p><p><strong>Branch:</strong> master</p><p><strong>Build ID:</strong> $BUILD_ID</p><h3>Deployment Steps:</h3><ul><li>âœ… Docker images built (API + Frontend)</li><li>âœ… Images pushed to GCR</li><li>âœ… API deployed to Cloud Run</li><li>âœ… Frontend deployed to Cloud Run</li></ul><h3>Services:</h3><ul><li><strong>API:</strong> cis-api (us-central1)</li><li><strong>Frontend:</strong> cis-frontend (us-central1)</li></ul><p><strong>View logs:</strong> <a href=\"https://console.cloud.google.com/cloud-build/builds/$BUILD_ID?project=$PROJECT_ID\">Cloud Build</a></p><p><em>Deployment completed at $(date)</em></p>"
            }]
          }' || echo "Email notification failed (non-critical)"
    waitFor: ["deploy-api", "deploy-frontend"]

images:
  - "gcr.io/$PROJECT_ID/cis-api:$COMMIT_SHA"
  - "gcr.io/$PROJECT_ID/cis-frontend:$COMMIT_SHA"

substitutions:
  # Core API Keys
  _GOOGLE_API_KEY: ""
  _OPENAI_API_KEY: ""

  # Authentication (Clerk)
  _CLERK_SECRET_KEY: ""
  _CLERK_PUBLISHABLE_KEY: ""

  # Database (Supabase)
  _SUPABASE_URL: ""
  _SUPABASE_SERVICE_KEY: ""

  # LinkedIn API
  _LINKEDIN_CLIENT_ID: ""
  _LINKEDIN_CLIENT_SECRET: ""

  # Notifications
  _SLACK_WEBHOOK_URL: ""
  _SENDGRID_API_KEY: ""
  _ADMIN_EMAIL: "Kunalsbhatt@gmail.com"

  # Error Tracking
  _SENTRY_DSN: ""

  # Infrastructure
  _API_BASE_URL: "https://cis-api-xxxxxxxxxx-uc.a.run.app"
  _FRONTEND_URL: "https://cis-frontend-xxxxxxxxxx-uc.a.run.app"

options:
  machineType: "E2_HIGHCPU_8"
  logging: CLOUD_LOGGING_ONLY
  logStreamingOption: STREAM_ON

availableSecrets:
  secretManager:
    - versionName: projects/gnx-cis/secrets/SLACK_WEBHOOK_URL/versions/latest
      env: "SLACK_WEBHOOK_URL"
    - versionName: projects/gnx-cis/secrets/SENDGRID_API_KEY/versions/latest
      env: "SENDGRID_API_KEY"
    # Note: Stripe secrets are injected at Cloud Run runtime via --update-secrets
    # They don't need to be in availableSecrets since they're not used during build

timeout: 1800s # 30 minutes
