<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GNX - Content Intelligence System</title>
  
  <!-- Favicon - Inline to prevent 404 -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='50' font-weight='bold' fill='white' text-anchor='middle'%3EG%3C/text%3E%3C/svg%3E">
  
  <!-- Production Tailwind CSS (built via: npm run build:css) -->
  <link href="./dist/output.css" rel="stylesheet">
  
  <!-- DEBUG MODE: Console enabled for troubleshooting -->
  <script>
    // Only suppress specific CDN/dev warnings, keep all other logs
    (function() {
      const originalWarn = console.warn;
      console.warn = function(...args) {
        const msg = String(args[0] || '');
        // Only suppress known CDN warnings
        if (msg.includes('cdn.tailwindcss.com') || msg.includes('Clerk:')) return;
        originalWarn.apply(console, args);
      };
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- 
    TODO PRODUCTION: Replace Clerk test keys with production keys
    Get production keys from: https://dashboard.clerk.com
    
    NOTE: Auto-signin is EXPECTED BEHAVIOR, not a security issue.
    Clerk uses secure, encrypted cookies to persist sessions (like Google/Apple SSO).
    User sessions are validated on every page load via JWT.
  -->
  
  <!-- Clerk Configuration - MUST be set BEFORE Clerk.js loads -->
  <script>
    // Set Clerk publishable key before the script loads
    // TODO PRODUCTION: Replace with 'pk_live_...' key
    window.__clerk_publishable_key = 'pk_test_bmV3LWFhcmR2YXJrLTMzLmNsZXJrLmFjY291bnRzLmRldiQ';
  </script>
  
  <!-- Clerk.js SDK for Production Authentication -->
  <script 
    data-clerk-publishable-key="pk_test_bmV3LWFhcmR2YXJrLTMzLmNsZXJrLmFjY291bnRzLmRldiQ"
    src="https://unpkg.com/@clerk/clerk-js@latest/dist/clerk.browser.js"
    crossorigin="anonymous"
    async>
  </script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes text-gradient-animation {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: #E0E0E0;
      background-color: #0a0a1a;
      background-image:
        radial-gradient(at 20% 20%, hsla(212, 90%, 50%, 0.405) 0px, transparent 50%),
        radial-gradient(at 80% 20%, hsla(282, 90%, 50%, 0.25) 0px, transparent 50%),
        radial-gradient(at 20% 80%, hsla(332, 90%, 50%, 0.25) 0px, transparent 50%),
        radial-gradient(at 80% 80%, hsla(182, 90%, 50%, 0.25) 0px, transparent 50%);
      font-family: 'Inter', system-ui, sans-serif;
      background-size: 200% 200%;
      animation: gradient-animation 30s ease infinite;
      min-height: 100vh;
    }

    .animated-gradient-text {
      background-image: linear-gradient(90deg, #a78bfa, #f472b6, #a78bfa);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: text-gradient-animation 4s linear infinite;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(139, 92, 246, 0.15);
      border-color: rgba(139, 92, 246, 0.3);
    }

    .gradient-button {
      background-image: linear-gradient(to right, #4f46e5, #9333ea, #4f46e5);
      background-size: 200% auto;
      transition: all 0.5s ease;
      border: none;
      cursor: pointer;
    }

    .gradient-button:hover {
      background-position: right center;
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
      transform: translateY(-2px);
    }

    .gradient-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .gradient-border-button {
      background-color: transparent;
      border: 1px solid transparent;
      background-image: linear-gradient(rgba(10, 10, 26, 0.8), rgba(10, 10, 26, 0.8)), linear-gradient(to right, #4f46e5, #9333ea);
      background-origin: border-box;
      background-clip: content-box, border-box;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .gradient-border-button:hover {
      background-image: linear-gradient(to right, #4f46e5, #9333ea), linear-gradient(to right, #4f46e5, #9333ea);
      background-clip: padding-box, border-box;
      box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
    }

    .animate-fade-in-up {
      opacity: 0;
      animation: fade-in-up 0.6s ease-out forwards;
    }

    .shake-error { animation: shake 0.5s ease-in-out; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Hide sections */
    .hidden { display: none !important; }

    /* Input styles */
    input, textarea, select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      padding: 12px 16px;
      width: 100%;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    /* Checkbox inputs should NOT be 100% width */
    input[type="checkbox"] {
      width: auto;
      padding: 0;
    }

    /* Dynamic auto-resize textarea */
    textarea.auto-resize {
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      resize: vertical;
      line-height: 1.6;
    }
    
    /* Word counter styling */
    .word-counter {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
      text-align: right;
      margin-top: 4px;
    }
    
    .word-counter.warning { color: #fbbf24; }
    .word-counter.limit { color: #ef4444; }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Status badges */
    .status-published { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-draft { background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3); }
    .status-scheduled { background: rgba(14, 165, 233, 0.2); color: #7dd3fc; border: 1px solid rgba(14, 165, 233, 0.3); }

    /* Select dropdown fix for contrast */
    select {
      background-color: rgba(30, 30, 50, 0.95) !important;
      color: white !important;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a78bfa'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    select option {
      background-color: #1e1e32 !important;
      color: white !important;
      padding: 12px;
    }

    select:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body class="antialiased">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN PAGE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="login-page" class="min-h-screen grid grid-cols-1 md:grid-cols-2 items-center gap-16 p-8">
    <!-- Left Hero Section -->
    <div class="hidden md:flex flex-col items-start text-left pl-12">
      <div class="flex items-center gap-3 mb-4">
        <svg class="w-10 h-10 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
        </svg>
        <span class="text-xl font-bold text-white">GNX Content Intelligence</span>
      </div>
      <h1 class="text-5xl lg:text-6xl font-black text-white leading-tight">
        Ignite Your <br>
        <span class="animated-gradient-text">Creativity</span>
      </h1>
      <p class="mt-6 text-lg text-gray-300 max-w-md">
        Unlock the power of AI to generate compelling LinkedIn content with viral potential, all with a single click.
      </p>
    </div>

    <!-- Right Login Form -->
    <div class="w-full max-w-sm mx-auto">
      <div class="glass-card rounded-2xl p-8 shadow-2xl">
        <h2 class="text-3xl font-bold text-center text-white mb-2">Welcome Back</h2>
        <p class="text-center text-violet-300 mb-8">Sign in to access your dashboard</p>
        
        <form id="login-form" onsubmit="handleLogin(event)">
          <div class="space-y-6">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Email Address</label>
              <input type="email" id="login-email" placeholder="your@email.com" required>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">Password</label>
              <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
          </div>

          <div id="login-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert" aria-live="polite" data-testid="login-error">
            Invalid email or password.
          </div>

          <button type="submit" id="login-btn" class="w-full mt-8 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
            <span id="login-btn-text">Sign In</span>
            <svg id="login-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </form>
        
        <!-- Signup Form (initially hidden) -->
        <form id="signup-form" onsubmit="handleSignup(event)" class="hidden">
          <div class="space-y-6">
            <div>
              <label class="block text-sm text-gray-400 mb-2">First Name</label>
              <input type="text" id="signup-firstname" placeholder="John" required>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">Email Address</label>
              <input type="email" id="signup-email" placeholder="your@email.com" required>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-2">Password</label>
              <input type="password" id="signup-password" placeholder="Min 8 characters" required minlength="8">
              <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters and numbers</p>
            </div>
          </div>

          <div id="signup-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert" aria-live="polite" data-testid="signup-error">
            Error creating account.
          </div>

          <button type="submit" id="signup-btn" class="w-full mt-8 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
            <span id="signup-btn-text">Create Account</span>
            <svg id="signup-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </form>

        <!-- Email Verification Form (initially hidden) -->
        <form id="verify-form" onsubmit="handleVerifyCode(event)" class="hidden">
          <div class="text-center mb-6">
            <svg class="w-16 h-16 mx-auto text-violet-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <h3 class="text-xl font-semibold text-white mb-2">Check Your Email</h3>
            <p class="text-sm text-gray-400">We sent a 6-digit code to <span id="verify-email-display" class="text-violet-400"></span></p>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Verification Code</label>
              <input type="text" id="verify-code" placeholder="Enter 6-digit code" required maxlength="6" pattern="[0-9]{6}"
                     class="text-center text-2xl tracking-widest font-mono">
            </div>
          </div>

          <div id="verify-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert">
            Invalid verification code.
          </div>

          <button type="submit" id="verify-btn" class="w-full mt-6 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
            <span id="verify-btn-text">Verify & Continue</span>
            <svg id="verify-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
          
          <button type="button" onclick="resendVerificationCode()" class="w-full mt-3 py-2 text-sm text-gray-400 hover:text-white transition-colors">
            Didn't receive code? Resend
          </button>
        </form>

        <!-- Auth Toggle Button -->
        <div id="auth-toggle-container" class="mt-6 text-center">
          <button type="button" id="auth-toggle-btn" onclick="toggleAuthForm()" class="text-sm text-violet-400 hover:text-violet-300 transition-colors">
            Don't have an account? <span class="font-semibold">Sign up</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD PAGE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="dashboard-page" class="hidden flex flex-col min-h-screen">
    
    <!-- Header -->
    <header class="sticky top-0 z-10 glass-card p-4">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <svg class="w-8 h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
          </svg>
          <div class="text-xl font-bold text-white">GNX CIS</div>
        </div>

        <nav>
          <ul class="flex items-center gap-6">
            <li><a id="nav-dashboard" class="font-bold text-white text-sm cursor-pointer" onclick="showSection('dashboard')" data-testid="nav-dashboard">Dashboard</a></li>
            <li><a id="nav-generate" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('generate')" data-testid="nav-generate">Generate</a></li>
            <li><a id="nav-history" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('history')" data-testid="nav-history">History</a></li>
            <li><a id="nav-settings" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('settings')" data-testid="nav-settings">âš™ï¸ Settings</a></li>
          </ul>
        </nav>

        <div class="flex items-center gap-4">
          <div class="text-right">
            <p class="text-white font-semibold text-sm" id="user-name">User</p>
            <p class="text-gray-400 text-xs" id="user-email">user@example.com</p>
          </div>
          <button id="logout-btn" onclick="handleLogout()" class="px-4 py-2 text-sm font-medium text-white rounded-lg gradient-border-button" data-testid="logout-btn">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="container mx-auto">
        
        <!-- Dashboard Section -->
        <div id="section-dashboard">
          <h1 class="text-3xl font-bold text-white mb-8">Dashboard</h1>
          
          <!-- Dashboard Error (BLOCKER 7) -->
          <div id="dashboard-error" role="alert" aria-live="assertive" data-testid="dashboard-error" class="hidden mb-6 p-4 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400">
            <span class="font-semibold">âš ï¸ Error:</span> <span id="dashboard-error-text">Failed to load dashboard data.</span>
          </div>
          
          <!-- Metrics Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 0ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Posts Generated</p>
                  <p class="text-3xl font-bold text-white" id="metric-posts">0</p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-violet-500/20">
                  <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                </div>
              </div>
              <p class="text-xs text-green-400">This session</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 100ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Average Score</p>
                  <p class="text-3xl font-bold text-white" id="metric-avg-score">0</p>
                </div>
                <div id="avg-trend" class="hidden flex items-center gap-1 px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-medium">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                  </svg>
                  <span id="avg-trend-value">+0</span>
                </div>
              </div>
              <!-- Mini Sparkline -->
              <svg id="score-sparkline" class="w-full h-8 opacity-50" viewBox="0 0 100 20">
                <polyline id="sparkline-path" points="0,15" fill="none" stroke="currentColor" stroke-width="1.5" class="text-violet-400"/>
              </svg>
              <p class="text-xs text-violet-400">Last 10 posts</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 200ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Best Score</p>
                  <p class="text-3xl font-bold text-white" id="metric-best-score">0</p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500/20">
                  <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                  </svg>
                </div>
              </div>
              <p class="text-xs text-green-400">Highest achieved</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 300ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">API Status</p>
                  <p class="text-3xl font-bold text-white" id="metric-api-status">...</p>
                </div>
                <div id="api-status-icon" class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-500/20">
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                  </svg>
                </div>
              </div>
              <div class="w-full bg-white/10 rounded-full h-2.5">
                <div id="api-status-bar" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <!-- Recent Posts -->
          <h2 class="text-2xl font-bold text-white mb-6">Recent Posts</h2>
          <div id="recent-posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="glass-card rounded-xl p-6 text-center text-gray-400">
              <p>No posts yet. Generate your first post!</p>
              <button onclick="showSection('generate')" class="mt-4 px-6 py-2 gradient-button rounded-lg text-white font-semibold">
                Generate Post
              </button>
            </div>
          </div>
        </div>

        <!-- Generate Section -->
        <div id="section-generate" class="hidden">
          <h1 class="text-3xl font-bold text-white mb-8">Generate Content</h1>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form -->
            <div class="glass-card rounded-xl p-6">
              <h3 class="text-xl font-semibold text-white mb-6">Create New Post</h3>
              
              <form id="generate-form" onsubmit="handleGenerate(event)">
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm text-gray-400 mb-2">Topic / Content *</label>
                    <textarea 
                      id="topic-input" 
                      class="auto-resize" 
                      placeholder="What do you want to write about? e.g., SAP S/4HANA migration tips...&#10;&#10;You can also paste existing content here to improve it." 
                      required
                      oninput="autoResizeTextarea(this); updateWordCount(this);"
                    ></textarea>
                    <div id="word-counter" class="word-counter">0 / 2000 words</div>
                  </div>
                  
                  <div>
                    <label class="block text-sm text-gray-400 mb-2">Style</label>
                    <select id="style-select">
                      <option value="professional">Professional - Polished & authoritative</option>
                      <option value="technical">Technical - Data-driven with metrics</option>
                      <option value="inspirational">Inspirational - Motivating & empowering</option>
                      <option value="thought_leadership">Thought Leadership - Bold & contrarian</option>
                      <option value="storytelling">Storytelling - Narrative with anecdotes</option>
                    </select>
                  </div>
                  
                  <!-- Admin Persona Toggle (hidden from non-admin users) -->
                  <div id="admin-persona-section" class="hidden" data-testid="admin-persona-section">
                    <label id="persona-mode-label" class="block text-sm text-gray-400 mb-2">ğŸ­ Admin Persona</label>
                    <div class="flex items-center gap-4 p-3 glass-card rounded-lg">
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="persona-toggle" class="sr-only peer" checked aria-checked="true" data-testid="persona-toggle" aria-label="Enable Kunal Persona">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-violet-300/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                      </label>
                      <div id="persona-mode-label">
                        <span class="text-white font-medium">Kunal Persona</span>
                        <p class="text-xs text-gray-400">Using your profile & audience insights</p>
                      </div>
                    </div>
                    <div id="persona-details" class="mt-2 text-xs text-gray-500">
                      <span>SAP PM | IT Services & Consulting | Toronto, Delhi</span>
                    </div>
                  </div>
                  
                  <!-- Regular Persona Input (for non-admin users) -->
                  <div id="regular-persona-section" data-testid="regular-persona-section">
                    <label class="block text-sm text-gray-400 mb-2">Persona (Optional)</label>
                    <input type="text" id="persona-input" placeholder="e.g., SAP Consultant with 10 years experience">
                  </div>
                </div>

                <!-- Image Generation Toggle -->
                <div class="mt-4">
                  <label for="generate-image-toggle" class="flex items-center gap-2 cursor-pointer" style="white-space: nowrap;">
                    <input type="checkbox" id="generate-image-toggle" class="rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500 cursor-pointer" style="width: 16px; height: 16px; flex-shrink: 0;">
                    <span class="text-sm text-gray-300">Generate AI Image</span>
                  </label>
                </div>

                <button type="submit" id="generate-btn" class="w-full mt-6 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
                  <span id="generate-btn-text">Generate Post</span>
                  <svg id="generate-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
                
                <!-- Generate status/error messages for E2E tests -->
                <div id="generate-status" class="hidden mt-4 p-3 rounded-lg bg-blue-500/20 text-blue-400 text-sm" role="status" aria-live="polite" data-testid="generate-status"></div>
                <div id="generate-error" class="hidden mt-4 p-3 rounded-lg bg-red-500/20 text-red-400 text-sm shake-error" role="alert" aria-live="assertive" data-testid="generate-error"></div>
              </form>
            </div>

            <!-- Result Preview -->
            <div id="result-panel" class="glass-card rounded-xl p-6">
              <h3 class="text-xl font-semibold text-white mb-6">Generated Post</h3>
              
              <div id="result-empty" class="text-center text-gray-400 py-12">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <p>Your generated content will appear here</p>
              </div>

              <!-- Agent Progress Indicator -->
              <div id="agent-progress" class="hidden">
                <div class="text-center mb-6">
                  <div class="inline-flex items-center gap-3 px-6 py-3 glass-card rounded-full">
                    <svg class="animate-spin h-5 w-5 text-violet-400" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="current-agent" class="text-white font-semibold">Initializing...</span>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <div id="step-content" class="flex items-center gap-3 p-3 rounded-lg bg-white/5">
                    <div id="step-content-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">1</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ContentAgent</p>
                      <p class="text-xs text-gray-400">Generating viral content...</p>
                    </div>
                    <div id="step-content-status" class="text-gray-400">â³</div>
                  </div>
                  
                  <div id="step-virality" class="flex items-center gap-3 p-3 rounded-lg bg-white/5 opacity-50">
                    <div id="step-virality-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">2</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ViralityAgent</p>
                      <p class="text-xs text-gray-400">Scoring engagement potential...</p>
                    </div>
                    <div id="step-virality-status" class="text-gray-400">â³</div>
                  </div>
                  
                  <div id="step-image" class="flex items-center gap-3 p-3 rounded-lg bg-white/5 opacity-50">
                    <div id="step-image-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">3</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ImageGenerator</p>
                      <p class="text-xs text-gray-400">Creating branded visual...</p>
                    </div>
                    <div id="step-image-status" class="text-gray-400">â³</div>
                  </div>
                </div>
              </div>

              <div id="result-content" class="hidden">
                <div class="flex items-center justify-between mb-4">
                  <span class="text-sm text-gray-400">Virality Score</span>
                  <span id="result-score" class="text-2xl font-bold text-green-400">0/100</span>
                </div>
                
                <div class="bg-white/5 rounded-lg p-4 mb-4">
                  <p id="result-text" class="text-white whitespace-pre-wrap"></p>
                </div>

                <div class="mt-4">
                  <h4 class="text-sm font-semibold text-gray-400 mb-2">Suggestions</h4>
                  <ul id="result-suggestions" class="list-disc list-inside text-sm text-gray-300 space-y-1"></ul>
                </div>

                <!-- Image Container (for generated or deferred images) -->
                <div id="result-image-container"></div>

                <div class="flex gap-4 mt-6">
                  <button onclick="copyToClipboard()" class="flex-1 py-2 px-4 gradient-border-button rounded-lg text-white font-semibold">
                    ğŸ“‹ Copy
                  </button>
                  <button onclick="editCurrentPost()" class="flex-1 py-2 px-4 gradient-border-button rounded-lg text-white font-semibold">
                    âœï¸ Edit
                  </button>
                  <button onclick="improvePost()" class="flex-1 py-2 px-4 gradient-button rounded-lg text-white font-semibold">
                    âœ¨ Improve
                  </button>
                </div>
                
                <!-- Admin LinkedIn Actions (only visible to admins) -->
                <div id="admin-linkedin-actions" class="hidden mt-6 pt-6 border-t border-white/10">
                  <h4 class="text-sm font-semibold text-violet-400 mb-3">ğŸ­ Admin Actions</h4>
                  <div class="flex gap-3 flex-wrap">
                    <button onclick="publishToLinkedIn()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                      Publish Now
                    </button>
                    <button onclick="showScheduleModal()" class="px-4 py-2 bg-violet-600 hover:bg-violet-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      ğŸ“… Schedule
                    </button>
                    <button onclick="saveAsDraft()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      ğŸ’¾ Save Draft
                    </button>
                  </div>
                  <p id="linkedin-action-status" class="mt-3 text-sm text-gray-400 hidden"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- History Section -->
        <div id="section-history" class="hidden">
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
            <h1 class="text-3xl font-bold text-white">Post History</h1>
            <div class="flex flex-wrap items-center gap-3">
              <input 
                type="text" 
                id="history-search" 
                placeholder="ğŸ” Search posts..." 
                oninput="updateHistoryGrid()"
                class="px-4 py-2 rounded-lg text-sm w-48">
              <select id="history-filter-score" onchange="updateHistoryGrid()" class="px-4 py-2 rounded-lg text-sm">
                <option value="all">All Scores</option>
                <option value="90">90+ (Excellent)</option>
                <option value="70">70-89 (Good)</option>
                <option value="below">Below 70</option>
              </select>
              <select id="history-sort" onchange="updateHistoryGrid()" class="px-4 py-2 rounded-lg text-sm">
                <option value="recent">Recent First</option>
                <option value="oldest">Oldest First</option>
                <option value="highest">Highest Score</option>
                <option value="lowest">Lowest Score</option>
              </select>
            </div>
          </div>
          <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="glass-card rounded-xl p-6 text-center text-gray-400">
              <p>No posts in history yet.</p>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="section-settings" class="hidden">
          <h1 class="text-3xl font-bold text-white mb-8">âš™ï¸ Settings</h1>
          
          <!-- LinkedIn Connection (Admin-only feature) -->
          <div id="linkedin-settings-section" class="glass-card rounded-xl p-6 mb-6 max-w-2xl hidden" data-testid="linkedin-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              LinkedIn Connection
            </h2>
            
            <div id="linkedin-status-display" class="mb-4">
              <div class="flex items-center gap-3 mb-2">
                <div id="linkedin-connection-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="linkedin-connection-text" class="text-gray-300">Not Connected</span>
              </div>
            </div>
            
            <p class="text-gray-400 text-sm mb-4">
              Connect your LinkedIn account to enable direct posting from the dashboard.
            </p>
            
            <button onclick="connectLinkedIn()" id="linkedin-connect-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold transition-colors flex items-center gap-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              Connect LinkedIn Account
            </button>
            
            <div id="linkedin-connect-status" class="mt-3 text-sm hidden"></div>
          </div>
          
          <!-- Admin Status (only for admins) -->
          <div id="admin-settings-section" class="glass-card rounded-xl p-6 max-w-2xl hidden" data-testid="admin-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              ğŸ­ Admin Status
            </h2>
            <div class="flex items-center gap-3">
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
              <span class="text-green-400">Admin Access Active</span>
            </div>
            <p class="text-gray-400 text-sm mt-2">
              You have access to direct LinkedIn publishing, scheduling, and drafts.
            </p>
          </div>
          
          <!-- Regular User Settings (visible when not admin) -->
          <div id="regular-settings-section" class="glass-card rounded-xl p-6 max-w-2xl hidden" data-testid="regular-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              ğŸ‘¤ User Preferences
            </h2>
            <p class="text-gray-400 text-sm">
              Basic account settings. LinkedIn publishing features require admin access.
            </p>
            <div class="mt-4 text-gray-500 text-sm">
              <p>â€¢ Default writing style: Professional</p>
              <p class="mt-1">â€¢ Content saved to your account</p>
            </div>
          </div>
        </div>

      </div>
    </main>

    </footer>
  </div>

  <!-- Schedule Post Modal -->
  <div id="schedule-modal" role="dialog" aria-modal="true" aria-labelledby="schedule-modal-title" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center" data-testid="schedule-modal">
    <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 id="schedule-modal-title" class="text-2xl font-bold text-white mb-6">ğŸ“… Schedule Post</h3>
      
      <div class="space-y-4">
        <div>
          <label for="schedule-date" class="block text-sm text-gray-400 mb-2">Date</label>
          <input type="date" id="schedule-date" class="w-full" aria-required="true">
        </div>
        <div>
          <label for="schedule-time" class="block text-sm text-gray-400 mb-2">Time</label>
          <input type="time" id="schedule-time" class="w-full" aria-required="true">
        </div>
        <div>
          <label for="schedule-timezone" class="block text-sm text-gray-400 mb-2">Timezone</label>
          <select id="schedule-timezone" class="w-full">
            <option value="America/New_York">Eastern Time (ET)</option>
            <option value="America/Chicago">Central Time (CT)</option>
            <option value="America/Denver">Mountain Time (MT)</option>
            <option value="America/Los_Angeles">Pacific Time (PT)</option>
            <option value="UTC">UTC</option>
            <option value="Asia/Kolkata">India (IST)</option>
          </select>
        </div>
        
        <div id="schedule-preview" class="mt-4 p-3 bg-white/5 rounded-lg text-sm text-gray-300 hidden" role="status" aria-live="polite">
          Scheduled for: <span id="schedule-preview-text" class="text-white font-semibold"></span>
        </div>
        
        <div id="schedule-error" class="mt-2 text-red-400 text-sm hidden" role="alert"></div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button id="schedule-modal-close" onclick="hideScheduleModal()" class="flex-1 py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition-colors" aria-label="Close schedule dialog">
          Cancel
        </button>
        <button onclick="confirmSchedule()" class="flex-1 py-2 px-4 gradient-button rounded-lg text-white font-semibold">
          Schedule
        </button>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RUNTIME CONFIGURATION
    // These values can be injected at build/deploy time via window.__RUNTIME_CONFIG__
    // or replaced during CI/CD build step
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const RUNTIME_CONFIG = window.__RUNTIME_CONFIG__ || {};
    
    // Production detection
    const IS_PRODUCTION = RUNTIME_CONFIG.IS_PRODUCTION || 
                          (window.location.hostname !== 'localhost' && 
                           window.location.hostname !== '127.0.0.1');
    
    // DEBUG MODE: Logging enabled for troubleshooting
    // Change to silent functions for production
    const logger = {
      log: console.log.bind(console),
      warn: console.warn.bind(console),
      error: console.error.bind(console),
      info: console.info.bind(console)
    };
    
    // API Configuration - defaults to localhost for dev, override in production
    const API_BASE = RUNTIME_CONFIG.API_BASE || 
                     (window.location.hostname === 'localhost' ? 'http://localhost:8000' : 
                      window.location.origin);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLERK AUTHENTICATION - PRODUCTION AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let clerkInstance = null;
    const CLERK_PUBLISHABLE_KEY = RUNTIME_CONFIG.CLERK_PUBLISHABLE_KEY || 
      'pk_test_bmV3LWFhcmR2YXJrLTMzLmNsZXJrLmFjY291bnRzLmRldiQ';
    
    async function initializeClerk() {
      try {
        // Wait for Clerk script to load
        let attempts = 0;
        while (!window.Clerk && attempts < 50) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }
        
        if (window.Clerk) {
          await window.Clerk.load({
            publishableKey: CLERK_PUBLISHABLE_KEY
          });
          clerkInstance = window.Clerk;
          logger.log('[Auth] Clerk initialized successfully');
          
          // Check if user is already signed in from previous session
          if (clerkInstance.user) {
            currentUser = {
              email: clerkInstance.user.emailAddresses[0]?.emailAddress,
              name: clerkInstance.user.firstName || clerkInstance.user.emailAddresses[0]?.emailAddress.split('@')[0],
              clerk_id: clerkInstance.user.id,
              image_url: clerkInstance.user.imageUrl
            };
            logger.log('[Auth] User already signed in:', currentUser.email);
            showDashboard();
          }
        } else {
          logger.error('[Auth] Clerk failed to load after timeout');
        }
      } catch (err) {
        logger.error('[Auth] Clerk initialization error:', err);
      }
    }
    
    // State
    let currentUser = null;
    let posts = [];
    let currentPost = null;
    let selectedPostIndex = null;
    let improvingPost = null;  // Track post being improved (for hybrid history pattern)
    
    // Admin Persona Configuration
    // NOTE: Admin status is determined by server response (user.role = 'admin')
    // DO NOT hardcode admin emails in client-side code
    const ADMIN_PERSONA_ID = 'persona_admin_kunal';
    
    // Check if we're in development mode (localhost)
    const IS_DEV_MODE = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
    
    function isAdminUser() {
      // E2E test hook - ONLY available in development mode
      if (IS_DEV_MODE) {
        const testRole = localStorage.getItem('gnx_test_role');
        if (testRole) return testRole === 'admin';
      }
      
      // Primary: explicit role on user object (from server)
      if (currentUser && currentUser.role) {
        return currentUser.role.toLowerCase() === 'admin';
      }
      
      // Fallback for legacy users without role: check server-verified email
      // This should match ADMIN_EMAILS on the server, but ultimate authority is server
      if (currentUser && currentUser.email) {
        // Only the exact admin email, and only as fallback
        return currentUser.email.toLowerCase() === 'kunalsbhatt@gmail.com';
      }
      
      return false;
    }
    
    function updatePersonaUI() {
      const adminSection = document.getElementById('admin-persona-section');
      const regularSection = document.getElementById('regular-persona-section');
      const personaToggle = document.getElementById('persona-toggle');
      
      // Debug logging for E2E troubleshooting
      logger.log('[PersonaUI] updatePersonaUI called');
      logger.log('[PersonaUI] currentUser:', currentUser);
      logger.log('[PersonaUI] isAdminUser():', isAdminUser());
      logger.log('[PersonaUI] adminSection found:', !!adminSection);
      
      if (isAdminUser()) {
        logger.log('[PersonaUI] Setting admin mode');
        if (adminSection) {
          // Force visibility with multiple methods to override CSS
          adminSection.style.display = 'block';
          adminSection.classList.remove('hidden');
          adminSection.hidden = false;
        }
        if (regularSection) {
          regularSection.style.display = 'none';
          regularSection.classList.add('hidden');
          regularSection.hidden = true;
        }
        // Sync toggle state
        if (personaToggle) {
          personaToggle.checked = true;
          personaToggle.setAttribute('aria-checked', 'true');
        }
      } else {
        logger.log('[PersonaUI] Setting user mode');
        if (adminSection) {
          adminSection.style.display = 'none';
          adminSection.classList.add('hidden');
          adminSection.hidden = true;
        }
        if (regularSection) {
          regularSection.style.display = 'block';
          regularSection.classList.remove('hidden');
          regularSection.hidden = false;
        }
      }
    }
    
    function getActivePersonaId() {
      if (!isAdminUser()) return null;
      const toggle = document.getElementById('persona-toggle');
      return toggle?.checked ? ADMIN_PERSONA_ID : null;
    }
    
    // Robust visibility helpers for CSS override
    function ensureVisible(el) {
      if (!el) return;
      el.hidden = false;
      el.classList.remove('hidden');
      el.style.display = 'block';
      el.setAttribute('aria-hidden', 'false');
    }
    
    function ensureHidden(el) {
      if (!el) return;
      el.hidden = true;
      el.classList.add('hidden');
      el.style.display = 'none';
      el.setAttribute('aria-hidden', 'true');
    }
    
    // Update admin LinkedIn actions visibility (called after content generation)
    function updateAdminLinkedInUI() {
      logger.log('>>> [AdminUI] updateAdminLinkedInUI STARTING <<<');
      
      const adminActionsEl = document.getElementById('admin-linkedin-actions');
      const adminSettingsEl = document.getElementById('admin-settings-section');
      const linkedinSettingsEl = document.getElementById('linkedin-settings-section');
      const regularSettingsEl = document.getElementById('regular-settings-section');
      
      logger.log('[AdminUI] isAdminUser():', isAdminUser());
      logger.log('[AdminUI] Elements found:', {
        adminActions: !!adminActionsEl,
        adminSettings: !!adminSettingsEl,
        linkedinSettings: !!linkedinSettingsEl,
        regularSettings: !!regularSettingsEl
      });
      
      if (isAdminUser()) {
        logger.log('[AdminUI] ADMIN MODE - Showing admin sections');
        if (adminActionsEl) { ensureVisible(adminActionsEl); logger.log('[AdminUI] adminActions visible'); }
        if (adminSettingsEl) { ensureVisible(adminSettingsEl); logger.log('[AdminUI] adminSettings visible'); }
        if (linkedinSettingsEl) { ensureVisible(linkedinSettingsEl); logger.log('[AdminUI] linkedinSettings visible'); }
        if (regularSettingsEl) { ensureHidden(regularSettingsEl); logger.log('[AdminUI] regularSettings hidden'); }
      } else {
        logger.log('[AdminUI] USER MODE - Showing regular section');
        if (adminActionsEl) { ensureHidden(adminActionsEl); }
        if (adminSettingsEl) { ensureHidden(adminSettingsEl); }
        if (linkedinSettingsEl) { ensureHidden(linkedinSettingsEl); }
        if (regularSettingsEl) { ensureVisible(regularSettingsEl); logger.log('[AdminUI] regularSettings visible'); }
      }
      
      logger.log('>>> [AdminUI] updateAdminLinkedInUI DONE <<<');
    }

    // Image placeholders for posts (using Unsplash API for beautiful images)
    const postImages = [
      'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1518770660439-4636190af475?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=400&h=300&fit=crop'
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEXTAREA AUTO-RESIZE & WORD COUNTER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const WORD_LIMIT = 2000;
    
    function autoResizeTextarea(textarea) {
      // Reset height to auto to get proper scrollHeight
      textarea.style.height = 'auto';
      
      // Set new height based on scrollHeight, respecting min/max from CSS
      const newHeight = Math.min(Math.max(textarea.scrollHeight, 100), 400);
      textarea.style.height = newHeight + 'px';
    }
    
    function updateWordCount(textarea) {
      const text = textarea.value.trim();
      const wordCount = text ? text.split(/\s+/).length : 0;
      
      const counterEl = document.getElementById('word-counter');
      if (counterEl) {
        counterEl.textContent = `${wordCount} / ${WORD_LIMIT} words`;
        
        // Update styling based on count
        counterEl.classList.remove('warning', 'limit');
        if (wordCount >= WORD_LIMIT) {
          counterEl.classList.add('limit');
        } else if (wordCount >= WORD_LIMIT * 0.8) {
          counterEl.classList.add('warning');
        }
      }
      
      // Optional: Prevent exceeding limit (soft limit - just warn)
      // To enforce hard limit, uncomment below:
      // if (wordCount > WORD_LIMIT) {
      //   const words = text.split(/\s+/).slice(0, WORD_LIMIT);
      //   textarea.value = words.join(' ');
      // }
    }
    
    // Initialize textarea on page load
    function initTextarea() {
      const textarea = document.getElementById('topic-input');
      if (textarea) {
        autoResizeTextarea(textarea);
        updateWordCount(textarea);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUPABASE CLIENT & PERSISTENCE
    // Anon key is safe for client-side use (RLS policies protect data)
    // Configure via window.__RUNTIME_CONFIG__ for different environments
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SUPABASE_URL = RUNTIME_CONFIG.SUPABASE_URL || 'https://ijwmgwirhorksepabgpj.supabase.co';
    const SUPABASE_ANON_KEY = RUNTIME_CONFIG.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqd21nd2lyaG9ya3NlcGFiZ3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTAwMjksImV4cCI6MjA3NjM4NjAyOX0.edZFY_LyMzNhKbYSdA95lvu7hRuWu3Dqf03oy4bJnYc';
    
    let supabase = null;
    let supabaseEnabled = false;

    // Initialize Supabase client
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      supabaseEnabled = true;
      logger.log('âœ… Supabase connected');
    } catch (error) {
      logger.warn('âš ï¸ Supabase not available:', error);
      supabaseEnabled = false;
    }

    // Save post to Supabase
    async function savePostToSupabase(post) {
      if (!supabaseEnabled || !currentUser) return null;
      
      try {
        // Get or create user in database
        const userEmail = currentUser.email;
        
        // Check if user exists
        let { data: existingUser } = await supabase
          .from('users')
          .select('id')
          .eq('email', userEmail)
          .single();
        
        let userId;
        if (!existingUser) {
          // Create new user
          const { data: newUser, error: createError } = await supabase
            .from('users')
            .insert({
              email: userEmail,
              full_name: currentUser.name,
              clerk_id: `dashboard_${Date.now()}` // Temporary clerk_id for dashboard users
            })
            .select()
            .single();
          
          if (createError) throw createError;
          userId = newUser.id;
        } else {
          userId = existingUser.id;
        }

        // Save post
        const { data, error } = await supabase
          .from('posts')
          .insert({
            user_id: userId,
            content: post.content,
            topic: post.topic,
            virality_score: post.virality_score,
            suggestions: post.suggestions || [],
            image_url: post.imageUrl,
            style: post.style,
            persona: post.persona,
            status: 'draft',
            generated_at: new Date().toISOString()
          })
          .select()
          .single();

        if (error) throw error;
        
        logger.log('âœ… Post saved to Supabase:', data.id);
        return data;
      } catch (error) {
        logger.error('âŒ Failed to save post to Supabase:', error);
        return null;
      }
    }

    // Load all posts for current user from Supabase
    async function loadPostsFromSupabase() {
      if (!supabaseEnabled || !currentUser) return [];
      
      try {
        // Get user
        const { data: user } = await supabase
          .from('users')
          .select('id')
          .eq('email', currentUser.email)
          .single();
        
        if (!user) return [];

        // Load posts
        const { data: loadedPosts, error } = await supabase
          .from('posts')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Transform to dashboard format
        const transformedPosts = loadedPosts.map(p => {
          // Fix image URL: prepend API_BASE if it's a relative path
          // Also fix old URLs that have wrong port (8080 instead of 8000)
          let imageUrl = p.image_url;
          if (imageUrl) {
            if (imageUrl.startsWith('/')) {
              imageUrl = API_BASE + imageUrl;
            } else if (imageUrl.includes('localhost:8080')) {
              // Fix old URLs with wrong port
              imageUrl = imageUrl.replace('localhost:8080', 'localhost:8000');
            }
          }
          
          return {
            id: p.id,  // Required for improve flow
            content: p.content,
            topic: p.topic,
            virality_score: p.virality_score || 0,
            suggestions: p.suggestions || [],
            imageUrl: imageUrl,
            style: p.style,
            persona: p.persona,
            timestamp: p.generated_at || p.created_at,
            // Hybrid history pattern fields
            version: p.version || 1,
            improvement_count: p.improvement_count || 0,
            previous_score: p.previous_score
          };
        });

        // Debug: Show raw scores from Supabase
        logger.log('ğŸ“¦ [Supabase] Raw scores from DB:', loadedPosts.map(p => p.virality_score));
        logger.log(`âœ… Loaded ${transformedPosts.length} posts from Supabase`);
        return transformedPosts;
      } catch (error) {
        logger.error('âŒ Failed to load posts from Supabase:', error);
        return [];
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH - REAL CLERK AUTHENTICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value?.trim() || '';
      const password = document.getElementById('login-password').value || '';
      
      // Clear previous errors
      document.getElementById('login-error').classList.add('hidden');
      
      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('login-error').textContent = 'Please enter a valid email address.';
        document.getElementById('login-error').classList.remove('hidden');
        return;
      }
      
      // Validate password is provided
      if (!password || password.length < 1) {
        document.getElementById('login-error').textContent = 'Please enter your password.';
        document.getElementById('login-error').classList.remove('hidden');
        return;
      }
      
      // Show loading
      document.getElementById('login-btn').disabled = true;
      document.getElementById('login-btn-text').textContent = 'Signing In...';
      document.getElementById('login-spinner').classList.remove('hidden');
      
      try {
        if (!clerkInstance) {
          throw new Error('Authentication system loading. Please wait a moment and try again.');
        }
        
        // Real Clerk sign in
        const signInAttempt = await clerkInstance.client.signIn.create({
          identifier: email,
          password: password,
        });
        
        if (signInAttempt.status === 'complete') {
          // Set the active session
          await clerkInstance.setActive({ session: signInAttempt.createdSessionId });
          
          // Get user data
          const user = clerkInstance.user;
          currentUser = {
            email: user.emailAddresses[0]?.emailAddress || email,
            name: user.firstName || email.split('@')[0],
            clerk_id: user.id,
            image_url: user.imageUrl
          };
          
          logger.log('[Auth] Login successful:', currentUser.email);
          showDashboard();
          await loadPostsFromSupabase();
          
        } else {
          throw new Error('Sign in incomplete. Please verify your email first.');
        }
        
      } catch (err) {
        logger.error('[Auth] Login error:', err);
        let errorMessage = 'Invalid email or password.';
        
        if (err.errors && err.errors.length > 0) {
          errorMessage = err.errors[0].longMessage || err.errors[0].message;
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        document.getElementById('login-error').textContent = errorMessage;
        document.getElementById('login-error').classList.remove('hidden');
      } finally {
        document.getElementById('login-btn').disabled = false;
        document.getElementById('login-btn-text').textContent = 'Sign In';
        document.getElementById('login-spinner').classList.add('hidden');
      }
    }
    
    async function handleSignup(event) {
      event.preventDefault();
      const firstName = document.getElementById('signup-firstname')?.value?.trim() || '';
      const email = document.getElementById('signup-email').value?.trim() || '';
      const password = document.getElementById('signup-password').value || '';
      
      // Clear previous errors
      document.getElementById('signup-error').classList.add('hidden');
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CLIENT-SIDE VALIDATION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Validate first name
      if (!firstName || firstName.length < 2) {
        document.getElementById('signup-error').textContent = 'Please enter your first name (at least 2 characters).';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('signup-error').textContent = 'Please enter a valid email address (e.g., name@example.com).';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Block obviously fake/test emails
      const blockedDomains = ['test.com', 'fake.com', 'example.com', 'temp.com', 'mailinator.com'];
      const emailDomain = email.split('@')[1]?.toLowerCase();
      if (blockedDomains.includes(emailDomain)) {
        document.getElementById('signup-error').textContent = 'Please use a real email address, not a test/temporary email.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Validate password strength
      if (password.length < 8) {
        document.getElementById('signup-error').textContent = 'Password must be at least 8 characters long.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      if (!hasLetter || !hasNumber) {
        document.getElementById('signup-error').textContent = 'Password must contain both letters and numbers.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Check for common weak passwords
      const weakPasswords = ['password', '12345678', 'password1', 'qwerty123', 'letmein1'];
      if (weakPasswords.includes(password.toLowerCase())) {
        document.getElementById('signup-error').textContent = 'This password is too common. Please choose a stronger password.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // VALIDATION PASSED - PROCEED WITH SIGNUP
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Show loading
      document.getElementById('signup-btn').disabled = true;
      document.getElementById('signup-btn-text').textContent = 'Creating Account...';
      document.getElementById('signup-spinner').classList.remove('hidden');
      
      try {
        if (!clerkInstance) {
          throw new Error('Authentication system loading. Please wait a moment and try again.');
        }
        
        // Real Clerk sign up
        logger.log('[Auth] Attempting signup for:', email);
        const signUpAttempt = await clerkInstance.client.signUp.create({
          emailAddress: email,
          password: password,
          firstName: firstName
        });
        
        logger.log('[Auth] Signup response status:', signUpAttempt.status);
        logger.log('[Auth] Signup response:', signUpAttempt);
        
        if (signUpAttempt.status === 'complete') {
          // Auto sign in after signup
          await clerkInstance.setActive({ session: signUpAttempt.createdSessionId });
          
          const user = clerkInstance.user;
          currentUser = {
            email: user.emailAddresses[0]?.emailAddress || email,
            name: user.firstName || firstName || email.split('@')[0],
            clerk_id: user.id,
            image_url: user.imageUrl,
            isFirstTimeUser: true
          };
          
          logger.log('[Auth] Signup successful:', currentUser.email);
          showDashboard();
          
        } else if (signUpAttempt.status === 'missing_requirements') {
          // Need to send email verification
          logger.log('[Auth] Email verification required, preparing verification...');
          
          // Prepare and send verification email
          await signUpAttempt.prepareEmailAddressVerification({ strategy: 'email_code' });
          logger.log('[Auth] Verification email sent!');
          
          // Store the signup attempt for later verification
          window.pendingSignUp = signUpAttempt;
          window.pendingEmail = email;
          
          // Show verification form
          document.getElementById('signup-form').classList.add('hidden');
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('verify-form').classList.remove('hidden');
          document.getElementById('auth-toggle-container').classList.add('hidden');
          document.getElementById('verify-email-display').textContent = email;
          
          // Update title
          const authTitle = document.querySelector('#login-page h2');
          if (authTitle) authTitle.textContent = 'Verify Email';
          
          logger.log('[Auth] Verification form shown');
          
        } else {
          logger.log('[Auth] Unexpected signup status:', signUpAttempt.status);
          document.getElementById('signup-error').textContent = 
            'Signup incomplete. Status: ' + signUpAttempt.status;
          document.getElementById('signup-error').classList.remove('hidden');
        }
        
      } catch (err) {
        logger.error('[Auth] Signup error:', err);
        let errorMessage = 'Error creating account. Please try again.';
        
        if (err.errors && err.errors.length > 0) {
          const error = err.errors[0];
          if (error.code === 'form_identifier_exists') {
            errorMessage = 'An account with this email already exists. Please sign in.';
          } else {
            errorMessage = error.longMessage || error.message;
          }
        }
        
        document.getElementById('signup-error').textContent = errorMessage;
        document.getElementById('signup-error').classList.remove('hidden');
      } finally {
        document.getElementById('signup-btn').disabled = false;
        document.getElementById('signup-btn-text').textContent = 'Create Account';
        document.getElementById('signup-spinner').classList.add('hidden');
      }
    }
    
    // Handle OTP verification
    async function handleVerifyCode(event) {
      event.preventDefault();
      const code = document.getElementById('verify-code').value?.trim();
      
      if (!code || code.length !== 6) {
        document.getElementById('verify-error').textContent = 'Please enter the 6-digit code from your email.';
        document.getElementById('verify-error').classList.remove('hidden');
        return;
      }
      
      // Show loading
      document.getElementById('verify-btn').disabled = true;
      document.getElementById('verify-btn-text').textContent = 'Verifying...';
      document.getElementById('verify-spinner').classList.remove('hidden');
      document.getElementById('verify-error').classList.add('hidden');
      
      try {
        if (!window.pendingSignUp) {
          throw new Error('No pending signup. Please start over.');
        }
        
        logger.log('[Auth] Verifying code:', code);
        
        // Verify the code
        const completeSignUp = await window.pendingSignUp.attemptEmailAddressVerification({
          code: code
        });
        
        logger.log('[Auth] Verification result:', completeSignUp.status);
        
        if (completeSignUp.status === 'complete') {
          // Set active session
          await clerkInstance.setActive({ session: completeSignUp.createdSessionId });
          
          const user = clerkInstance.user;
          currentUser = {
            email: user.emailAddresses[0]?.emailAddress || window.pendingEmail,
            name: user.firstName || window.pendingEmail?.split('@')[0],
            clerk_id: user.id,
            image_url: user.imageUrl,
            isFirstTimeUser: true
          };
          
          logger.log('[Auth] Email verified! User signed in:', currentUser.email);
          
          // Clear pending state
          window.pendingSignUp = null;
          window.pendingEmail = null;
          
          // Show dashboard
          showDashboard();
          
        } else {
          throw new Error('Verification incomplete. Please try again.');
        }
        
      } catch (err) {
        logger.error('[Auth] Verification error:', err);
        let errorMessage = 'Invalid verification code. Please try again.';
        
        if (err.errors && err.errors.length > 0) {
          errorMessage = err.errors[0].longMessage || err.errors[0].message;
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        document.getElementById('verify-error').textContent = errorMessage;
        document.getElementById('verify-error').classList.remove('hidden');
      } finally {
        document.getElementById('verify-btn').disabled = false;
        document.getElementById('verify-btn-text').textContent = 'Verify & Continue';
        document.getElementById('verify-spinner').classList.add('hidden');
      }
    }
    
    // Resend verification code
    async function resendVerificationCode() {
      if (!window.pendingSignUp) {
        alert('Session expired. Please start over.');
        toggleAuthForm();
        return;
      }
      
      try {
        await window.pendingSignUp.prepareEmailAddressVerification({ strategy: 'email_code' });
        alert('New verification code sent! Check your email.');
      } catch (err) {
        logger.error('[Auth] Resend error:', err);
        alert('Failed to resend code. Please try again.');
      }
    }

    async function handleLogout() {
      try {
        if (clerkInstance) {
          await clerkInstance.signOut();
        }
      } catch (err) {
        logger.error('[Auth] Logout error:', err);
      }
      
      currentUser = null;
      posts = [];
      currentPost = null;
      document.getElementById('dashboard-page').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
      
      // Clear forms
      if (document.getElementById('login-email')) {
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
      }
    }
    
    function toggleAuthForm() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const authTitle = document.querySelector('#login-page h2');
      const authSubtitle = document.querySelector('#login-page .text-violet-300');
      const toggleBtn = document.getElementById('auth-toggle-btn');
      
      if (signupForm.classList.contains('hidden')) {
        // Show signup
        loginForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        if (authTitle) authTitle.textContent = 'Create Account';
        if (authSubtitle) authSubtitle.textContent = 'Join GNX to start generating content';
        if (toggleBtn) toggleBtn.innerHTML = 'Already have an account? <span class="font-semibold">Sign in</span>';
      } else {
        // Show login
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        if (authTitle) authTitle.textContent = 'Welcome Back';
        if (authSubtitle) authSubtitle.textContent = 'Sign in to access your dashboard';
        if (toggleBtn) toggleBtn.innerHTML = 'Don\'t have an account? <span class="font-semibold">Sign up</span>';
      }
      
      // Clear errors
      document.getElementById('login-error')?.classList.add('hidden');
      document.getElementById('signup-error')?.classList.add('hidden');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FORGOT PASSWORD / FIRST-TIME USER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showForgotPassword() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('forgot-password-form').classList.remove('hidden');
      document.getElementById('reset-success').classList.add('hidden');
      document.getElementById('reset-error').classList.add('hidden');
      
      // Pre-fill email if entered in login form
      const loginEmail = document.getElementById('login-email').value;
      if (loginEmail) {
        document.getElementById('reset-email').value = loginEmail;
      }
    }
    
    function hideForgotPassword() {
      document.getElementById('forgot-password-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
    
    async function handleForgotPassword() {
      const email = document.getElementById('reset-email').value;
      
      if (!email) {
        document.getElementById('reset-error').textContent = 'âŒ Please enter your email address.';
        document.getElementById('reset-error').classList.remove('hidden');
        return;
      }
      
      // Generate temporary password (in production, send via email)
      const tempPassword = generateTempPassword();
      
      // Store in localStorage for demo (in prod, this would be server-side + email)
      const tempUsers = JSON.parse(localStorage.getItem('temp_passwords') || '{}');
      tempUsers[email.toLowerCase()] = {
        password: tempPassword,
        created: Date.now(),
        expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
      };
      localStorage.setItem('temp_passwords', JSON.stringify(tempUsers));
      
      // Show success message with temp password (in prod, this would be hidden and sent via email)
      document.getElementById('reset-success').innerHTML = `
        âœ… Temporary password created!<br>
        <span class="text-white font-mono mt-2 block bg-white/10 p-2 rounded">${tempPassword}</span>
        <span class="text-xs mt-1 block">Valid for 24 hours. In production, this would be sent to your email.</span>
      `;
      document.getElementById('reset-success').classList.remove('hidden');
      document.getElementById('reset-error').classList.add('hidden');
      
      logger.log(`ğŸ”‘ Temporary password for ${email}: ${tempPassword}`);
    }
    
    function generateTempPassword() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
      let password = '';
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return password;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMIN LINKEDIN ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // NOTE: updateAdminLinkedInUI() defined earlier (around line 839) - handles both admin actions AND settings visibility
    
    function showLinkedInStatus(message, isError = false) {
      const statusEl = document.getElementById('linkedin-action-status');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
        statusEl.classList.add(isError ? 'text-red-400' : 'text-green-400');
        
        // Auto-hide after 5 seconds
        setTimeout(() => statusEl.classList.add('hidden'), 5000);
      }
    }
    
    async function publishToLinkedIn() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('âŒ No post to publish. Generate a post first.', true);
        return;
      }
      
      if (!isAdminUser()) {
        showLinkedInStatus('âŒ Admin access required.', true);
        return;
      }
      
      // SECURITY NOTE: Direct publishing now requires JWT authentication
      // The demo dashboard uses localStorage auth which is not secure enough
      // for LinkedIn publishing. Users should:
      // 1. Use the LinkedIn share URL (opens LinkedIn with pre-filled content)
      // 2. Or use the authenticated Clerk-based app for direct publishing
      
      // For now, open LinkedIn share dialog as a safe alternative
      const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.origin)}`;
      const shareText = encodeURIComponent(currentPost.content);
      
      // Copy content to clipboard and show instructions
      try {
        await navigator.clipboard.writeText(currentPost.content);
        showLinkedInStatus('ğŸ“‹ Post copied! Opening LinkedIn... Paste your content there.', false);
        
        // Open LinkedIn compose (they'll need to paste)
        setTimeout(() => {
          window.open('https://www.linkedin.com/feed/', '_blank');
        }, 1000);
      } catch (err) {
        showLinkedInStatus('ğŸ“‹ Copy failed. Please manually copy your post content.', true);
      }
    }
    
    async function saveAsDraft() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('âŒ No post to save. Generate a post first.', true);
        return;
      }
      
      showLinkedInStatus('ğŸ’¾ Saving as draft...');
      
      try {
        // Save to Supabase with draft status
        const saved = await savePostToSupabase({
          ...currentPost,
          status: 'draft',
          savedAt: new Date().toISOString()
        });
        
        if (saved) {
          showLinkedInStatus('âœ… Saved as draft!');
        } else {
          // Fallback to localStorage
          const drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
          drafts.push({
            ...currentPost,
            id: `draft_${Date.now()}`,
            status: 'draft',
            savedAt: new Date().toISOString()
          });
          localStorage.setItem('post_drafts', JSON.stringify(drafts));
          showLinkedInStatus('âœ… Saved as local draft!');
        }
      } catch (error) {
        logger.error('Save draft error:', error);
        showLinkedInStatus('âŒ Failed to save draft.', true);
      }
    }
    
    function showScheduleModal() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('âŒ No post to schedule. Generate a post first.', true);
        return;
      }
      
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('schedule-date').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('schedule-time').value = '09:00';
      document.getElementById('schedule-error').classList.add('hidden');
      document.getElementById('schedule-preview').classList.add('hidden');
      
      document.getElementById('schedule-modal').classList.remove('hidden');
      
      // Add event listeners for preview
      document.getElementById('schedule-date').addEventListener('change', updateSchedulePreview);
      document.getElementById('schedule-time').addEventListener('change', updateSchedulePreview);
      updateSchedulePreview();
    }
    
    function hideScheduleModal() {
      document.getElementById('schedule-modal').classList.add('hidden');
    }
    
    function updateSchedulePreview() {
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const timezone = document.getElementById('schedule-timezone').value;
      
      if (date && time) {
        const dateObj = new Date(`${date}T${time}`);
        const formatted = dateObj.toLocaleString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        document.getElementById('schedule-preview-text').textContent = `${formatted} (${timezone})`;
        document.getElementById('schedule-preview').classList.remove('hidden');
      }
    }
    
    async function confirmSchedule() {
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const timezone = document.getElementById('schedule-timezone').value;
      
      if (!date || !time) {
        document.getElementById('schedule-error').textContent = 'Please select both date and time.';
        document.getElementById('schedule-error').classList.remove('hidden');
        return;
      }
      
      const scheduledAt = new Date(`${date}T${time}`);
      const now = new Date();
      
      if (scheduledAt <= now) {
        document.getElementById('schedule-error').textContent = 'Scheduled time must be in the future.';
        document.getElementById('schedule-error').classList.remove('hidden');
        return;
      }
      
      try {
        // Save to Supabase with scheduled status
        const postData = {
          ...currentPost,
          status: 'scheduled',
          scheduled_at: scheduledAt.toISOString(),
          timezone: timezone
        };
        
        const response = await fetch(`${API_BASE}/api/posts/schedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });
        
        if (response.ok) {
          hideScheduleModal();
          showLinkedInStatus(`âœ… Post scheduled for ${scheduledAt.toLocaleDateString()}`);
          
          // Also save locally
          const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
          scheduled.push(postData);
          localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
        } else {
          // Fallback to local storage
          const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
          scheduled.push(postData);
          localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
          
          hideScheduleModal();
          showLinkedInStatus(`âœ… Post scheduled locally for ${scheduledAt.toLocaleDateString()}`);
        }
      } catch (error) {
        logger.error('Schedule error:', error);
        
        // Fallback to local storage
        const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
        scheduled.push({
          ...currentPost,
          status: 'scheduled',
          scheduled_at: scheduledAt.toISOString(),
          timezone: timezone
        });
        localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
        
        hideScheduleModal();
        showLinkedInStatus(`âœ… Post scheduled locally for ${scheduledAt.toLocaleDateString()}`);
      }
    }
    
    async function updatePostStatus(postId, status) {
      if (!supabaseEnabled) return false;
      
      try {
        const { error } = await supabase
          .from('posts')
          .update({ status: status, updated_at: new Date().toISOString() })
          .eq('id', postId);
        
        return !error;
      } catch (e) {
        logger.error('Update post status error:', e);
        return false;
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LINKEDIN CONNECTION (SETTINGS)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function checkLinkedInStatus() {
      const indicator = document.getElementById('linkedin-connection-indicator');
      const text = document.getElementById('linkedin-connection-text');
      const btn = document.getElementById('linkedin-connect-btn');
      
      try {
        const email = currentUser?.email || '';
        const response = await fetch(`${API_BASE}/auth/linkedin/status?user_email=${encodeURIComponent(email)}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.status === 'connected') {
            indicator.classList.remove('bg-red-500');
            indicator.classList.add('bg-green-500');
            text.textContent = 'Connected';
            text.classList.remove('text-gray-300');
            text.classList.add('text-green-400');
            btn.textContent = 'âœ“ LinkedIn Connected';
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-green-600', 'cursor-default');
            btn.disabled = true;
          }
        }
      } catch (e) {
        logger.log('LinkedIn status check:', e);
      }
    }
    
    async function connectLinkedIn() {
      // Show connecting status
      const statusEl = document.getElementById('linkedin-connect-status');
      statusEl.textContent = 'ğŸ”„ Getting LinkedIn authorization...';
      statusEl.classList.remove('hidden', 'text-red-400');
      statusEl.classList.add('text-blue-400');
      
      try {
        // Get the LinkedIn OAuth URL from our backend
        const email = currentUser?.email || '';
        const response = await fetch(`${API_BASE}/auth/linkedin/authorize?user_email=${encodeURIComponent(email)}`);
        const data = await response.json();
        
        if (!data.auth_url) {
          statusEl.textContent = 'âŒ Failed to get LinkedIn authorization URL';
          statusEl.classList.remove('text-blue-400');
          statusEl.classList.add('text-red-400');
          return;
        }
        
        statusEl.textContent = 'ğŸ”„ Opening LinkedIn...';
        
        // Open LinkedIn auth in new window
        const popup = window.open(data.auth_url, 'LinkedIn Connect', 'width=600,height=700,scrollbars=yes');
        
        if (!popup) {
          // Fallback to redirect if popup blocked
          window.location.href = data.auth_url;
        } else {
          // Poll for completion
          const checkPopup = setInterval(() => {
            try {
              if (popup.closed) {
                clearInterval(checkPopup);
                statusEl.textContent = 'âœ… Check if connection was successful.';
                statusEl.classList.remove('text-blue-400');
                statusEl.classList.add('text-green-400');
                checkLinkedInStatus();
              }
            } catch (e) {
              // Cross-origin error, popup still open
            }
          }, 1000);
        }
      } catch (error) {
        logger.error('LinkedIn connect error:', error);
        statusEl.textContent = 'âŒ Error connecting to LinkedIn';
        statusEl.classList.remove('text-blue-400');
        statusEl.classList.add('text-red-400');
      }
    }
    
    // NOTE: updateAdminSettingsUI removed - now handled by updateAdminLinkedInUI()

    async function showDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-email').textContent = currentUser.email;
      checkApiStatus();
      
      // Update persona UI based on admin status
      updatePersonaUI();
      updateAdminLinkedInUI();  // Show admin LinkedIn actions if admin
      
      // Load posts from Supabase
      logger.log('ğŸ“¡ Attempting to load posts from Supabase...');
      const loadedPosts = await loadPostsFromSupabase();
      logger.log('ğŸ“Š Loaded posts count:', loadedPosts ? loadedPosts.length : 0);
      
      if (loadedPosts && loadedPosts.length > 0) {
        posts = loadedPosts;
        logger.log(`ğŸ“¥ Restored ${posts.length} posts from Supabase`);
      } else {
        logger.warn('âš ï¸ No posts loaded from Supabase');
        // Initialize empty posts array
        posts = posts || [];
      }
      
      logger.log('ğŸ”„ Updating metrics and UI...');
      updateMetrics();
      updateRecentPosts();
      updateHistoryGrid();
      logger.log('âœ… Dashboard loaded');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showSection(section) {
      document.getElementById('section-dashboard').classList.add('hidden');
      document.getElementById('section-generate').classList.add('hidden');
      document.getElementById('section-history').classList.add('hidden');
      document.getElementById('section-settings')?.classList.add('hidden');
      document.getElementById('section-' + section).classList.remove('hidden');
      
      // Update navigation active states
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(link => {
        link.classList.remove('font-bold', 'text-white');
        link.classList.add('text-gray-400');
      });
      
      const activeLink = Array.from(navLinks).find(link => 
        link.getAttribute('onclick')?.includes(`'${section}'`)
      );
      if (activeLink) {
        activeLink.classList.add('font-bold', 'text-white');
        activeLink.classList.remove('text-gray-400');
      }
      
      // Update history when switching to history view
      if (section === 'history') {
        updateHistoryGrid();
      }
      
      // Update generate section with persona controls
      if (section === 'generate') {
        updatePersonaUI();  // Ensure admin controls are visible for admin users
      }
      
      // Update settings when switching to settings view
      if (section === 'settings') {
        logger.log('>>> SETTINGS BLOCK ENTERED <<<');
        logger.log('About to call updateAdminLinkedInUI...');
        updateAdminLinkedInUI();  // Show/hide admin-only settings sections FIRST
        logger.log('updateAdminLinkedInUI completed');
        try {
          if (typeof checkLinkedInStatus === 'function') {
            checkLinkedInStatus();
          }
        } catch (e) {
          logger.warn('[Settings] checkLinkedInStatus error:', e);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function checkApiStatus() {
      const statusEl = document.getElementById('metric-api-status');
      const iconEl = document.getElementById('api-status-icon');
      const barEl = document.getElementById('api-status-bar');
      
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          statusEl.textContent = 'Online';
          statusEl.classList.remove('text-red-400');
          statusEl.classList.add('text-green-400');
          barEl.style.width = '100%';
          barEl.className = 'bg-gradient-to-r from-green-500 to-emerald-500 h-2.5 rounded-full transition-all duration-500';
          
          // Update icon
          if (iconEl) {
            iconEl.classList.remove('bg-gray-500/20', 'bg-red-500/20');
            iconEl.classList.add('bg-green-500/20');
            const svg = iconEl.querySelector('svg');
            if (svg) {
              svg.classList.remove('text-gray-400', 'text-red-400');
              svg.classList.add('text-green-400');
            }
          }
        } else {
          throw new Error('API unavailable');
        }
      } catch (e) {
        statusEl.textContent = 'Offline';
        statusEl.classList.remove('text-green-400');
        statusEl.classList.add('text-red-400');
        barEl.style.width = '0%';
        
        // Update icon
        if (iconEl) {
          iconEl.classList.remove('bg-gray-500/20', 'bg-green-500/20');
          iconEl.classList.add('bg-red-500/20');
          const svg = iconEl.querySelector('svg');
          if (svg) {
            svg.classList.remove('text-gray-400', 'text-green-400');
            svg.classList.add('text-red-400');
          }
        }
      }
    }

    async function handleGenerate(event) {
      event.preventDefault();
      
      const topic = document.getElementById('topic-input').value;
      const style = document.getElementById('style-select').value;
      const generateImage = document.getElementById('generate-image-toggle').checked;
      
      // Get persona: either admin persona_id or free-text persona input
      const activePersonaId = getActivePersonaId();
      const personaInput = document.getElementById('persona-input')?.value;

      // Show loading and agent progress
      document.getElementById('generate-btn').disabled = true;
      document.getElementById('generate-btn-text').textContent = 'Generating...';
      document.getElementById('generate-spinner').classList.remove('hidden');
      document.getElementById('result-empty').classList.add('hidden');
      document.getElementById('result-content').classList.add('hidden');
      document.getElementById('agent-progress').classList.remove('hidden');
      
      // Clear any previous error/status messages
      document.getElementById('generate-error').classList.add('hidden');
      document.getElementById('generate-status').classList.add('hidden');
      
      // Reset agent progress
      resetAgentProgress();
      
      // Start agent progress simulation
      await simulateAgentProgress('content', 'ContentAgent generating content...');

      try {
        // Build request body
        const requestBody = { 
          topic, 
          style, 
          persona: personaInput || null,
          persona_id: activePersonaId,  // Admin persona injection
          generate_image: generateImage,  // Pass the toggle value
          user_email: currentUser?.email || null  // User identification
        };
        
        // If improving existing post, add post_id and version (hybrid history pattern)
        if (improvingPost && improvingPost.post_id) {
          requestBody.post_id = improvingPost.post_id;
          requestBody.expected_version = improvingPost.version;
          logger.log('ğŸ“ [Generate] Improving post:', improvingPost.post_id, 'v' + improvingPost.version);
        }
        
        const response = await fetch(`${API_BASE}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (response.ok) {
          // Mark content done, start virality
          completeAgentStep('content');
          await simulateAgentProgress('virality', 'ViralityAgent scoring post...');
          
          const data = await response.json();
          
          // Mark virality done
          completeAgentStep('virality');
          
          // Only show image progress if generating image
          if (generateImage) {
            await simulateAgentProgress('image', 'ImageGenerator creating visual...');
            
            // Use API-generated branded image if available
            if (data.image_url) {
              data.imageUrl = API_BASE + data.image_url;
            } else {
              data.imageUrl = postImages[posts.length % postImages.length];
            }
            completeAgentStep('image');
          } else {
            // Skip image step - mark as skipped
            const imageStepEl = document.getElementById('step-image');
            if (imageStepEl) {
              const statusText = imageStepEl.querySelector('.text-gray-400');
              if (statusText) statusText.textContent = 'Skipped (deferred)';
            }
            data.imageUrl = null;
            data.imageDeferred = true;  // Flag for showing "Generate Image" button later
          }
          
          
          await delay(500);
          await delay(500);
          
          // Ensure data has required fields
          data.timestamp = data.timestamp || new Date().toISOString();
          data.topic = data.topic || topic;
          
          currentPost = data;
          
          // Handle improve vs new post (hybrid history pattern)
          if (improvingPost && improvingPost.post_id) {
            // UPDATE existing post in posts array
            const postIndex = posts.findIndex(p => 
              (p.id === improvingPost.post_id) || (p.post_id === improvingPost.post_id)
            );
            if (postIndex >= 0) {
              // Update existing post with new data
              data.id = improvingPost.post_id;
              data.improvement_count = (posts[postIndex].improvement_count || 0) + 1;
              data.previous_score = improvingPost.original_score;
              data.version = (improvingPost.version || 1) + 1;
              posts[postIndex] = { ...posts[postIndex], ...data };
              logger.log('âœ… [Improve] Updated existing post in array:', postIndex);
            } else {
              // Post not found in local array - add it (shouldn't happen normally)
              posts.unshift(data);
              logger.warn('âš ï¸ [Improve] Post not found in local array, added as new');
            }
            // Clear improving state
            improvingPost = null;
          } else {
            // NEW post - add to beginning of array
            // Ensure it has ID from API response for future improvements
            data.id = data.post_id || data.id;
            data.version = data.version || 1;
            data.improvement_count = data.improvement_count || 0;
            posts.unshift(data);
            logger.log('âœ… [Generate] Added new post to array, id:', data.id);
          }
          
          // Note: Don't call savePostToSupabase - backend already saved/updated it
          
          // Hide progress, show result
          document.getElementById('agent-progress').classList.add('hidden');
          displayResult(data);
          updateMetrics();
          updateRecentPosts();
          updateHistoryGrid();
        } else {
          document.getElementById('agent-progress').classList.add('hidden');
          const error = await response.json();
          
          // Display error in generate-error element
          const errorEl = document.getElementById('generate-error');
          const statusEl = document.getElementById('generate-status');
          
          // Check for rate limit (429)
          if (response.status === 429) {
            statusEl.textContent = 'â³ Rate limit exceeded. Please wait ' + (error.retry_after || 60) + ' seconds.';
            statusEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
          } else {
            errorEl.textContent = 'âŒ ' + (error.detail || error.error || 'Failed to generate content');
            errorEl.classList.remove('hidden');
            statusEl.classList.add('hidden');
          }
        }
      } catch (e) {
        document.getElementById('agent-progress').classList.add('hidden');
        
        // Display error in generate-error element
        const errorEl = document.getElementById('generate-error');
        errorEl.textContent = 'âŒ Error connecting to API: ' + e.message;
        errorEl.classList.remove('hidden');
        document.getElementById('generate-status').classList.add('hidden');
      }

      document.getElementById('generate-btn').disabled = false;
      document.getElementById('generate-btn-text').textContent = 'Generate Post';
      document.getElementById('generate-spinner').classList.add('hidden');
    }

    // Agent progress helper functions
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function resetAgentProgress() {
      ['content', 'virality', 'image'].forEach(step => {
        document.getElementById(`step-${step}`).classList.remove('opacity-50');
        document.getElementById(`step-${step}`).classList.add('opacity-50');
        document.getElementById(`step-${step}-icon`).classList.remove('bg-violet-500', 'bg-green-500');
        document.getElementById(`step-${step}-icon`).classList.add('bg-gray-700');
        document.getElementById(`step-${step}-status`).textContent = 'â³';
      });
      document.getElementById('step-content').classList.remove('opacity-50');
    }

    async function simulateAgentProgress(step, message) {
      document.getElementById('current-agent').textContent = message;
      document.getElementById(`step-${step}`).classList.remove('opacity-50');
      document.getElementById(`step-${step}-icon`).classList.remove('bg-gray-700');
      document.getElementById(`step-${step}-icon`).classList.add('bg-violet-500');
      document.getElementById(`step-${step}-status`).textContent = 'ğŸ”„';
      await delay(300);
    }

    function completeAgentStep(step) {
      document.getElementById(`step-${step}-icon`).classList.remove('bg-violet-500');
      document.getElementById(`step-${step}-icon`).classList.add('bg-green-500');
      document.getElementById(`step-${step}-status`).textContent = 'âœ…';
    }

    function displayResult(data) {
      document.getElementById('result-empty').classList.add('hidden');
      document.getElementById('result-content').classList.remove('hidden');
      
      document.getElementById('result-score').textContent = data.virality_score + '/100';
      document.getElementById('result-text').textContent = data.content;
      
      const scoreColor = data.virality_score >= 80 ? 'text-green-400' : 
                         data.virality_score >= 60 ? 'text-yellow-400' : 'text-red-400';
      document.getElementById('result-score').className = 'text-2xl font-bold ' + scoreColor;

      const suggestionsList = document.getElementById('result-suggestions');
      const suggestionsSection = suggestionsList?.parentElement;
      suggestionsList.innerHTML = '';
      
      logger.log('ğŸ“‹ Suggestions from API:', data.suggestions);
      
      const suggestions = data.suggestions || [];
      if (suggestions.length > 0) {
        suggestionsSection.classList.remove('hidden');
        suggestions.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          suggestionsList.appendChild(li);
        });
      } else {
        suggestionsSection.classList.add('hidden');
      }
      
      // Handle image display or deferred generation button
      const imageContainer = document.getElementById('result-image-container');
      if (imageContainer) {
        if (data.imageUrl) {
          // Show the generated image with prominent save button
          imageContainer.innerHTML = `
            <div class="mt-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-gray-300">Generated Image:</h4>
                <button onclick="saveImage('${data.imageUrl}')" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-violet-600 hover:bg-violet-700 text-white rounded-lg transition-all shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                  ğŸ’¾ Save Image (PNG)
                </button>
              </div>
              <img src="${data.imageUrl}" alt="Generated post image" class="rounded-lg max-w-full h-auto shadow-lg border border-white/10">
            </div>
          `;
        } else if (data.imageDeferred) {
          // Show button to generate image later
          imageContainer.innerHTML = `
            <div class="mt-4 p-4 glass-card rounded-lg text-center">
              <p class="text-gray-400 mb-3">Image generation was deferred. Ready to create your final image?</p>
              <button onclick="generateDeferredImage()" class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
                Generate AI Image Now
              </button>
            </div>
          `;
        } else {
          imageContainer.innerHTML = '';
        }
      }
    }

    // Handle deferred image generation
    async function generateDeferredImage() {
      if (!currentPost) return;
      
      const imageContainer = document.getElementById('result-image-container');
      imageContainer.innerHTML = `
        <div class="mt-4 p-4 glass-card rounded-lg text-center">
          <p class="text-gray-400">ğŸ¨ Generating AI image...</p>
          <div class="mt-2 flex justify-center">
            <svg class="animate-spin h-8 w-8 text-violet-500" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </div>
      `;
      
      try {
        const response = await fetch(`${API_BASE}/api/generate-image`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            content: currentPost.content,
            style: currentPost.style || 'professional'
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          currentPost.imageUrl = API_BASE + result.image_url;
          currentPost.imageDeferred = false;
          
          imageContainer.innerHTML = `
            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm text-gray-400">Generated Image:</h4>
                <button onclick="saveImage('${currentPost.imageUrl}')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-violet-600/20 hover:bg-violet-600/40 text-violet-300 rounded-lg transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                  Save Image
                </button>
              </div>
              <img src="${currentPost.imageUrl}" alt="Generated post image" class="rounded-lg max-w-full h-auto shadow-lg">
            </div>
          `;
        } else {
          const error = await response.json();
          imageContainer.innerHTML = `
            <div class="mt-4 p-4 glass-card rounded-lg text-center">
              <p class="text-red-400 mb-3">Failed to generate image: ${error.detail || 'Unknown error'}</p>
              <button onclick="generateDeferredImage()" class="px-4 py-2 bg-violet-600 text-white rounded-lg">
                Retry
              </button>
            </div>
          `;
        }
      } catch (error) {
        imageContainer.innerHTML = `
          <div class="mt-4 p-4 glass-card rounded-lg text-center">
            <p class="text-red-400 mb-3">Error: ${error.message}</p>
            <button onclick="generateDeferredImage()" class="px-4 py-2 bg-violet-600 text-white rounded-lg">
              Retry
            </button>
          </div>
        `;
      }
    }


    function updateMetrics() {
      document.getElementById('metric-posts').textContent = posts.length;
      
      // Filter posts with valid virality scores
      const validPosts = posts.filter(p => p.virality_score && !isNaN(p.virality_score));
      
      if (validPosts.length > 0) {
        // Use last 10 posts for average (matches sparkline), posts are newest-first
        const recentPosts = validPosts.slice(0, 10);
        const avgScore = recentPosts.reduce((sum, p) => sum + (p.virality_score || 0), 0) / recentPosts.length;
        document.getElementById('metric-avg-score').textContent = avgScore.toFixed(0);
        
        const bestScore = Math.max(...validPosts.map(p => p.virality_score || 0));
        document.getElementById('metric-best-score').textContent = bestScore;
        
        // Update sparkline
        updateSparkline();
        
        // Update trend indicator: newest post vs average of previous 9 posts
        // Posts are newest-first, so validPosts[0] is the NEWEST post
        if (recentPosts.length >= 2) {
          const newestScore = recentPosts[0].virality_score || 0;
          const prevPosts = recentPosts.slice(1); // Previous 9 (or fewer) posts
          const prevAvg = prevPosts.reduce((sum, p) => sum + (p.virality_score || 0), 0) / prevPosts.length;
          const diff = newestScore - prevAvg;
          
          logger.log('ğŸ“ˆ [Trend] Newest score:', newestScore, 'Previous avg:', prevAvg.toFixed(1), 'Diff:', diff.toFixed(1));
          
          const trendEl = document.getElementById('avg-trend');
          const trendValueEl = document.getElementById('avg-trend-value');
          const arrowSvg = trendEl.querySelector('svg');
          
          if (Math.abs(diff) >= 0.5) {
            trendEl.classList.remove('hidden');
            trendEl.classList.add('flex');
            
            if (diff > 0) {
              // Positive: green, arrow up
              trendEl.classList.remove('bg-red-500/20', 'text-red-400');
              trendEl.classList.add('bg-green-500/20', 'text-green-400');
              arrowSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>';
              trendValueEl.textContent = `+${diff.toFixed(0)}`;
            } else {
              // Negative: red, arrow down
              trendEl.classList.remove('bg-green-500/20', 'text-green-400');
              trendEl.classList.add('bg-red-500/20', 'text-red-400');
              arrowSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>';
              trendValueEl.textContent = diff.toFixed(0);
            }
          } else {
            trendEl.classList.add('hidden');
          }
        }
      }
    }  
    
    function updateSparkline() {
      const sparklinePath = document.getElementById('sparkline-path');
      if (!sparklinePath) {
        logger.log('ğŸ“Š [Sparkline] Element not found');
        return;
      }
      
      // Filter posts with valid virality scores
      const validPosts = posts.filter(p => p.virality_score && !isNaN(p.virality_score));
      logger.log('ğŸ“Š [Sparkline] Total posts:', posts.length, 'Valid posts:', validPosts.length);
      
      if (validPosts.length > 0) {
        logger.log('ğŸ“Š [Sparkline] Sample scores:', validPosts.slice(-5).map(p => p.virality_score));
      }
      
      if (validPosts.length < 2) {
        // Show flat line at average if only 1 post or no posts
        const avgScore = validPosts.length === 1 ? validPosts[0].virality_score : 50;
        const normalizedY = 20 - ((avgScore / 100) * 20);
        const flatPoints = `0,${normalizedY} 100,${normalizedY}`;
        logger.log('ğŸ“Š [Sparkline] Flat line (< 2 posts):', flatPoints);
        sparklinePath.setAttribute('points', flatPoints);
        return;
      }
      
      // Get RECENT 10 scores (posts are newest-first, so slice first 10 and reverse for chronological order)
      const recentPosts = validPosts.slice(0, 10).reverse(); // oldest-to-newest for proper graph direction
      const scores = recentPosts.map(p => p.virality_score || 0);
      const max = Math.max(...scores);
      const min = Math.min(...scores);
      const range = max - min || 1;
      
      logger.log('ğŸ“Š [Sparkline] Recent scores (oldestâ†’newest):', scores);
      logger.log('ğŸ“Š [Sparkline] Range:', min, '-', max, '(diff:', range, ')');
      
      const width = 100;
      const height = 20;
      const points = scores.map((score, i) => {
        const x = scores.length === 1 ? 50 : (i / (scores.length - 1)) * width;
        const y = height - ((score - min) / range) * (height - 2) - 1;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');
      
      logger.log('ğŸ“Š [Sparkline] Points:', points);
      sparklinePath.setAttribute('points', points);
    }

    function updateRecentPosts() {
      const grid = document.getElementById('recent-posts-grid');
      if (posts.length === 0) return;
      
      // Posts are already newest-first from Supabase, so take first 6
      grid.innerHTML = posts.slice(0, 6).map((post, i) => {
        const postIndex = i; // Posts are already in correct order
        
        // Clean content for preview (remove "Improve this post:" prefix)
        let cleanText = (post.content || '').replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
        cleanText = cleanText.substring(0, 100);
        
        // Clean topic for display (with null check)
        let displayTopic = post.topic || 'Generated Post';
        if (displayTopic.toLowerCase().startsWith('improve this post')) {
          displayTopic = cleanText.substring(0, 50) + '...';
        }
        
        return `
        <div class="glass-card rounded-xl overflow-hidden cursor-pointer group animate-fade-in-up" 
             style="animation-delay: ${i * 80}ms"
             onclick="viewPost(${postIndex})">
          <img src="${post.imageUrl || postImages[postIndex % postImages.length]}" 
               alt="${displayTopic}" 
               class="w-full h-40 object-cover group-hover:scale-105 transition-transform duration-300">
          <div class="p-4">
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs px-2 py-1 rounded-full ${post.virality_score >= 80 ? 'status-published' : 'status-draft'}">
                Score: ${post.virality_score}
              </span>
              <span class="text-xs text-gray-400">${new Date(post.timestamp).toLocaleTimeString()}</span>
            </div>
            <h3 class="font-semibold text-white mb-2">${displayTopic.substring(0, 50)}${displayTopic.length > 50 ? '...' : ''}</h3>
            <p class="text-gray-400 text-sm line-clamp-2">${cleanText}...</p>
          </div>
        </div>
      `}).join('');
    }

    function updateHistoryGrid() {
      const grid = document.getElementById('history-grid');
      
      if (posts.length === 0) {
        grid.innerHTML = `
          <div class="glass-card rounded-xl p-12 text-center col-span-full">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-violet-500/20 mb-4">
              <svg class="w-8 h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Ready to Create Viral Content?</h3>
            <p class="text-gray-400 mb-6">Your first post is just a click away</p>
            <button onclick="showSection('generate')" class="px-6 py-3 gradient-button rounded-lg text-white font-semibold">
              Start Generating
            </button>
          </div>
        `;
        return;
      }
      
      // Get filter and sort values
      const filterEl = document.getElementById('history-filter-score');
      const sortEl = document.getElementById('history-sort');
      const searchEl = document.getElementById('history-search');
      
      const filter = filterEl ? filterEl.value : 'all';
      const sort = sortEl ? sortEl.value : 'recent';
      const searchTerm = searchEl ? searchEl.value.toLowerCase().trim() : '';
      
      // Filter posts
      let filteredPosts = posts.map((post, idx) => ({ ...post, originalIndex: idx }));
      
      // Apply search filter
      if (searchTerm) {
        filteredPosts = filteredPosts.filter(p => {
          const content = p.content.replace(/^Improve this post[^:]*:\s*\n*/i, '').toLowerCase();
          const topic = p.topic.toLowerCase();
          return content.includes(searchTerm) || topic.includes(searchTerm);
        });
      }
      
      // Apply score filter
      if (filter === '90') {
        filteredPosts = filteredPosts.filter(p => p.virality_score >= 90);
      } else if (filter === '70') {
        filteredPosts = filteredPosts.filter(p => p.virality_score >= 70 && p.virality_score < 90);
      } else if (filter === 'below') {
        filteredPosts = filteredPosts.filter(p => p.virality_score < 70);
      }
      
      // Sort posts
      if (sort === 'recent') {
        filteredPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      } else if (sort === 'oldest') {
        filteredPosts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      } else if (sort === 'highest') {
        filteredPosts.sort((a, b) => b.virality_score - a.virality_score);
      } else if (sort === 'lowest') {
        filteredPosts.sort((a, b) => a.virality_score - b.virality_score);
      }
      
      if (filteredPosts.length === 0) {
        grid.innerHTML = `
          <div class="glass-card rounded-xl p-8 text-center col-span-full text-gray-400">
            <p class="mb-4">No posts match your filters</p>
            <button onclick="document.getElementById('history-search').value=''; document.getElementById('history-filter-score').value='all'; updateHistoryGrid();" 
                    class="px-4 py-2 gradient-border-button rounded-lg text-white text-sm">
              Clear Filters
            </button>
          </div>
        `;
        return;
      }
      
      // Compact card layout (no large images)
      grid.innerHTML = filteredPosts.map((post, i) => {
        const scoreClass = post.virality_score >= 90 ? 'bg-green-500/20 text-green-400 border-green-500/30' : 
                          post.virality_score >= 70 ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30' : 
                          'bg-red-500/20 text-red-400 border-red-500/30';
        
        // Clean content for preview (remove "Improve this post:" prefix) - with null check
        let previewContent = (post.content || '').replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
        previewContent = previewContent.replace(/\n/g, ' ').substring(0, 100);
        
        // Clean topic for display (with null check)
        let displayTopic = post.topic || 'Generated Post';
        if (displayTopic.toLowerCase().startsWith('improve this post')) {
          displayTopic = previewContent.substring(0, 50) + '...';
        }
        
        return `
        <div class="glass-card rounded-xl overflow-hidden cursor-pointer hover:border-violet-500/40 transition-all duration-300" 
             onclick="viewPost(${post.originalIndex})">
          
          <!-- Compact Header with Key Info -->
          <div class="p-4 border-b border-white/5">
            <div class="flex items-start justify-between gap-3 mb-2">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <h3 class="font-semibold text-white text-base line-clamp-1">${displayTopic}</h3>
                ${post.improvement_count > 0 ? `<span class="shrink-0 text-xs px-2 py-0.5 rounded-full bg-violet-500/20 text-violet-400 border border-violet-500/30">v${post.version}</span>` : ''}
              </div>
              <span class="text-sm px-2.5 py-1 rounded-full font-bold ${scoreClass} border backdrop-blur-sm shrink-0">
                ${post.virality_score}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <p class="text-xs text-gray-400">${new Date(post.timestamp).toLocaleDateString()} â€¢ ${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
              ${post.improvement_count > 0 ? `<span class="text-xs text-violet-400">â€¢ ${post.improvement_count}x improved</span>` : ''}
            </div>
          </div>
          
          <!-- Content Preview (Reduced) -->
          <div class="p-4">
            <p class="text-gray-400 text-sm line-clamp-2 leading-relaxed mb-3">
              ${previewContent}...
            </p>
            
            <!-- Action Row -->
            <div class="flex items-center justify-between text-xs">
              <button onclick="event.stopPropagation(); viewPost(${post.originalIndex})" class="text-violet-400 hover:text-violet-300 transition-colors flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span class="group-hover:underline">View Full</span>
              </button>
              <button onclick="event.stopPropagation(); copyPost(${post.originalIndex})" class="text-gray-500 hover:text-gray-300 transition-colors flex items-center gap-1">
                ğŸ“‹ Copy
              </button>
            </div>
          </div>
        </div>
      `}).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POST ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Helper to clean content (remove "Improve this post:" prefix)
    function cleanContent(text) {
      if (!text) return '';
      return text.replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
    }
    
    // Helper to get clean topic
    function cleanTopic(post) {
      if (!post.topic) return 'Untitled';
      if (post.topic.toLowerCase().startsWith('improve this post')) {
        return cleanContent(post.content).substring(0, 50) + '...';
      }
      return post.topic;
    }
    
    function viewPost(index) {
      const post = posts[index];
      if (!post) return;
      
      selectedPostIndex = index;
      currentPost = post;
      
      // Clean content for display
      const displayContent = cleanContent(post.content);
      const displayTopic = cleanTopic(post);
      
      const modal = document.createElement('div');
      modal.id = 'post-modal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in-up';
      modal.style.background = 'rgba(0,0,0,0.85)';
      modal.style.backdropFilter = 'blur(8px)';
      
      modal.innerHTML = `
        <div class="glass-card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-white pr-4">${displayTopic}</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
          </div>
          
          ${post.imageUrl ? `
            <img src="${post.imageUrl}" 
                 alt="${displayTopic}" 
                 class="w-full h-48 object-cover rounded-lg mb-4">
          ` : ''}
          
          <div class="flex items-center gap-4 mb-4 flex-wrap">
            <span class="text-2xl font-bold ${post.virality_score >= 80 ? 'text-green-400' : post.virality_score >= 60 ? 'text-yellow-400' : 'text-red-400'}">
              ${post.virality_score}/100
            </span>
            <span class="text-gray-400 text-sm">${new Date(post.timestamp).toLocaleString()}</span>
            ${post.improvement_count > 0 ? `
              <span class="px-2 py-1 text-xs rounded-full bg-violet-500/20 text-violet-400 border border-violet-500/30">
                v${post.version || 2} â€¢ ${post.improvement_count}x improved
              </span>
              ${post.previous_score ? `<span class="text-xs text-gray-500">was ${post.previous_score}/100</span>` : ''}
            ` : ''}
          </div>
          
          ${post.improvement_count > 0 && post.id ? `
            <button onclick="viewPostHistory('${post.id}')" class="w-full mb-4 py-2 px-4 bg-violet-500/10 hover:bg-violet-500/20 border border-violet-500/30 rounded-lg text-violet-300 text-sm font-medium transition-all flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              View Original (Before Improvement)
            </button>
          ` : ''}
          
          <div class="bg-white/5 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto">
            <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${displayContent}</p>
          </div>
          
          ${post.suggestions && post.suggestions.length > 0 ? `
            <div class="mb-4 bg-violet-500/10 border border-violet-500/20 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-violet-300 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                Suggestions to Improve Score
              </h4>
              <ul class="list-disc list-inside text-sm text-gray-300 space-y-1.5">
                ${post.suggestions.map(s => `<li class="leading-relaxed">${s}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          ${post.imageUrl ? `
            <div class="mb-4">
              <button onclick="saveImage('${post.imageUrl}')" class="w-full py-2.5 px-4 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/30 rounded-lg text-white font-semibold text-sm transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                ğŸ’¾ Save Image (PNG)
              </button>
            </div>
          ` : ''}
          
          <div class="flex gap-3">
            <button id="copy-btn-${index}" onclick="copyPost(${index})" class="flex-1 py-2.5 px-4 gradient-border-button rounded-lg text-white font-semibold text-sm hover:scale-105 transition-transform">
              ğŸ“‹ Copy to Clipboard
            </button>
            <button onclick="editPost(${index}); closeModal();" class="flex-1 py-2.5 px-4 gradient-button rounded-lg text-white font-semibold text-sm hover:scale-105 transition-transform">
              âœ¨ Improve Post
            </button>
          </div>
        </div>
      `;
      
      // Click backdrop to close
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      const modal = document.getElementById('post-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 200);
      }
    }
    
    // View post history (original version before improvement)
    async function viewPostHistory(postId) {
      if (!postId) return;
      
      try {
        // Fetch history from Supabase RPC
        const { data: history, error } = await supabase.rpc('get_post_history', { 
          p_post_id: postId 
        });
        
        if (error) throw error;
        
        if (!history || history.length === 0) {
          alert('No history available for this post.');
          return;
        }
        
        // Get the most recent history entry (the original before improvement)
        const original = history[0];
        
        // Create history comparison modal
        const historyModal = document.createElement('div');
        historyModal.id = 'history-modal';
        historyModal.className = 'fixed inset-0 z-[60] flex items-center justify-center p-4 animate-fade-in-up';
        historyModal.style.background = 'rgba(0,0,0,0.9)';
        historyModal.style.backdropFilter = 'blur(8px)';
        
        historyModal.innerHTML = `
          <div class="glass-card rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
              <h2 class="text-2xl font-bold text-white">ğŸ“œ Post History</h2>
              <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Original Version -->
              <div class="bg-white/5 rounded-lg p-4 border border-gray-700">
                <div class="flex items-center gap-2 mb-3">
                  <span class="px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">
                    Original v${original.version}
                  </span>
                  <span class="text-xs text-gray-500">${new Date(original.created_at).toLocaleString()}</span>
                </div>
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-lg font-bold text-yellow-400">${original.previous_score}/100</span>
                  <span class="text-xs text-gray-500">score before</span>
                </div>
                <div class="max-h-64 overflow-y-auto">
                  <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed">${original.original_content || 'Content not available'}</p>
                </div>
              </div>
              
              <!-- Current Version -->
              <div class="bg-green-500/5 rounded-lg p-4 border border-green-500/30">
                <div class="flex items-center gap-2 mb-3">
                  <span class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                    Current v${currentPost.version || original.version + 1}
                  </span>
                  <span class="text-xs text-green-500">improved</span>
                </div>
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-lg font-bold text-green-400">${currentPost.virality_score}/100</span>
                  <span class="text-xs text-gray-500">score after</span>
                  <span class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">
                    +${currentPost.virality_score - (original.previous_score || 0)}
                  </span>
                </div>
                <div class="max-h-64 overflow-y-auto">
                  <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${cleanContent(currentPost.content)}</p>
                </div>
              </div>
            </div>
            
            <div class="mt-4 text-center">
              <button onclick="closeHistoryModal()" class="px-6 py-2 gradient-button rounded-lg text-white font-semibold">
                Close History
              </button>
            </div>
          </div>
        `;
        
        historyModal.onclick = (e) => {
          if (e.target === historyModal) closeHistoryModal();
        };
        
        document.body.appendChild(historyModal);
        
      } catch (err) {
        logger.error('Failed to load post history:', err);
        alert('Failed to load post history: ' + err.message);
      }
    }
    
    function closeHistoryModal() {
      const modal = document.getElementById('history-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function copyPost(index) {
      const post = posts[index];
      if (post) {
        const cleanText = cleanContent(post.content);
        navigator.clipboard.writeText(cleanText).then(() => {
          // Visual feedback
          const btn = document.getElementById(`copy-btn-${index}`);
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… Copied!';
            btn.classList.add('bg-green-500/20');
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove('bg-green-500/20');
            }, 2000);
          } else {
            // Fallback for history cards
            alert('Copied to clipboard!');
          }
        }).catch(err => {
          alert('Failed to copy: ' + err.message);
        });
      }
    }

    function editPost(index) {
      const post = posts[index];
      if (post) {
        currentPost = post;
        showSection('generate');
        
        // Clean content - remove any existing "Improve this post:" prefix
        const cleanText = cleanContent(post.content);
        document.getElementById('topic-input').value = 'Improve this post to score 90+:\n\n' + cleanText;
        
        setTimeout(() => {
          document.getElementById('topic-input').focus();
          document.getElementById('topic-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }

    function copyToClipboard() {
      if (currentPost) {
        const cleanText = cleanContent(currentPost.content);
        navigator.clipboard.writeText(cleanText).then(() => {
          const btn = event.target;
          const originalText = btn.innerHTML;
          btn.innerHTML = 'âœ… Copied!';
          btn.disabled = true;
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        });
      }
    }

    function improvePost() {
      if (currentPost) {
        // Set the improving post context (for hybrid history pattern)
        // This tells handleGenerate to UPDATE instead of INSERT
        improvingPost = {
          post_id: currentPost.id || currentPost.post_id,
          version: currentPost.version || 1,
          original_score: currentPost.virality_score
        };
        logger.log('ğŸ“ [Improve] Setting improvingPost:', improvingPost);
        
        showSection('generate');
        
        // Clean content - remove any existing "Improve this post:" prefix
        const cleanText = cleanContent(currentPost.content);
        document.getElementById('topic-input').value = 'Improve this post to score 90+:\n\n' + cleanText;
        
        setTimeout(() => {
          document.getElementById('topic-input').focus();
          document.getElementById('topic-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }
    
    // Edit the current post content directly
    function editCurrentPost() {
      if (!currentPost) return;
      
      // Create an editable modal for the post
      const modal = document.createElement('div');
      modal.id = 'edit-modal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in-up';
      modal.style.background = 'rgba(0,0,0,0.85)';
      modal.style.backdropFilter = 'blur(8px)';
      
      modal.innerHTML = `
        <div class="glass-card rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-white">âœï¸ Edit Post</h2>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
          </div>
          
          <textarea id="edit-post-content" class="w-full h-80 bg-white/5 border border-white/20 rounded-lg p-4 text-white resize-none focus:border-violet-500 focus:outline-none">${currentPost.content.replace(/`/g, '\\`')}</textarea>
          
          <div class="flex gap-4 mt-6">
            <button onclick="closeEditModal()" class="flex-1 py-3 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition-colors">
              Cancel
            </button>
            <button onclick="saveEditedPost()" class="flex-1 py-3 px-4 gradient-button rounded-lg text-white font-semibold">
              ğŸ’¾ Save Changes
            </button>
          </div>
        </div>
      `;
      
      // Click backdrop to close
      modal.onclick = (e) => {
        if (e.target === modal) closeEditModal();
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Focus the textarea
      setTimeout(() => document.getElementById('edit-post-content')?.focus(), 100);
    }
    
    function closeEditModal() {
      const modal = document.getElementById('edit-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 200);
      }
    }
    
    function saveEditedPost() {
      const textarea = document.getElementById('edit-post-content');
      if (textarea && currentPost) {
        currentPost.content = textarea.value;
        
        // Update the display
        document.getElementById('result-text').textContent = textarea.value;
        
        // Update post in posts array if it exists
        const postIndex = posts.findIndex(p => p.content === currentPost.content || p.timestamp === currentPost.timestamp);
        if (postIndex >= 0) {
          posts[postIndex].content = textarea.value;
        }
        
        // Save to Supabase
        savePostToSupabase(currentPost);
        
        closeEditModal();
        
        // Show success message
        const statusEl = document.getElementById('generate-status');
        if (statusEl) {
          statusEl.textContent = 'âœ… Post updated successfully!';
          statusEl.classList.remove('hidden');
          setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }
      }
    }

    // Save/Download generated image as PNG
    // Uses direct link to backend endpoint which sets Content-Disposition header
    async function saveImage(imageUrl) {
      try {
        // Extract filename from URL
        let originalFilename;
        try {
          const url = new URL(imageUrl, window.location.origin);
          originalFilename = url.pathname.split('/').pop();
        } catch (e) {
          originalFilename = imageUrl.split('/').pop();
        }
        originalFilename = decodeURIComponent(originalFilename);
        
        // Create user-friendly download filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const downloadFilename = `gnx-post-image-${timestamp}.png`;
        
        logger.log('ğŸ“¥ Original file:', originalFilename);
        logger.log('ğŸ“¥ Download as:', downloadFilename);
        
        // Build download URL with custom filename parameter
        // The backend will set Content-Disposition: attachment; filename="gnx-post-image-xxx.png"
        const downloadUrl = `${API_BASE}/api/download-image/${encodeURIComponent(originalFilename)}?download_as=${encodeURIComponent(downloadFilename)}`;
        
        logger.log('ğŸ“¥ Download URL:', downloadUrl);
        
        // Create an invisible iframe to trigger download without leaving the page
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;
        document.body.appendChild(iframe);
        
        // Remove iframe after download starts
        setTimeout(() => {
          document.body.removeChild(iframe);
          logger.log('âœ… Download initiated:', downloadFilename);
        }, 2000);
        
        // Show success feedback
        const statusEl = document.getElementById('generate-status');
        if (statusEl) {
          statusEl.textContent = `âœ… Downloading: ${downloadFilename}`;
          statusEl.classList.remove('hidden');
          setTimeout(() => statusEl.classList.add('hidden'), 4000);
        }
        
      } catch (error) {
        logger.error('âŒ Download failed:', error);
        
        // Fallback: open image in new tab
        const fullUrl = imageUrl.startsWith('/') ? API_BASE + imageUrl : imageUrl;
        window.open(fullUrl, '_blank');
        alert('Auto-download failed. Image opened in new tab - right-click to save.');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT & KEYBOARD SHORTCUTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Session timeout configuration (30 minutes = 1800000ms)
    const SESSION_TIMEOUT_MS = 30 * 60 * 1000;
    let sessionTimeoutId = null;
    let lastActivityTime = Date.now();
    
    // Reset session timeout on user activity
    function resetSessionTimeout() {
      lastActivityTime = Date.now();
      
      if (sessionTimeoutId) {
        clearTimeout(sessionTimeoutId);
      }
      
      if (currentUser) {
        sessionTimeoutId = setTimeout(() => {
          // Check if user is still logged in and inactive
          if (currentUser && (Date.now() - lastActivityTime >= SESSION_TIMEOUT_MS)) {
            alert('Your session has expired due to inactivity. Please log in again.');
            handleLogout();
          }
        }, SESSION_TIMEOUT_MS);
      }
    }
    
    // Track user activity for session management
    ['click', 'keypress', 'scroll', 'mousemove'].forEach(eventType => {
      document.addEventListener(eventType, () => {
        if (currentUser) {
          lastActivityTime = Date.now();
        }
      }, { passive: true });
    });
    
    document.addEventListener('DOMContentLoaded', () => {
      // SECURITY: No test logins or backdoors
      // All authentication must go through Clerk
      
      // Wire up persona toggle change listener
      const personaToggle = document.getElementById('persona-toggle');
      if (personaToggle) {
        personaToggle.addEventListener('change', () => {
          if (currentUser) {
            currentUser.role = personaToggle.checked ? 'admin' : 'user';
            updatePersonaUI();
            updateAdminLinkedInUI();
          }
        });
      }
      
      // Initialize textarea auto-resize and word counter
      initTextarea();
      
      // Start session timeout monitoring
      resetSessionTimeout();
    });

    // Keyboard shortcuts for power users
    document.addEventListener('keydown', (e) => {
      // Only if logged in
      if (!currentUser) return;
      
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'g':
            e.preventDefault();
            showSection('generate');
            setTimeout(() => document.getElementById('topic-input').focus(), 100);
            break;
          case 'h':
            e.preventDefault();
            showSection('history');
            break;
          case 'd':
            e.preventDefault();
            showSection('dashboard');
            break;
        }
      }
      
      // Escape to close modal
      if (e.key === 'Escape') {
        closeModal();
      }
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZE CLERK AUTH ON PAGE LOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    initializeClerk();
  </script>

</body>
</html>
