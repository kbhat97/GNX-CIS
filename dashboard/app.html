<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GNX - Content Intelligence System | AI That Remembers You</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="CIS is an AI-powered content creation platform with persistent memory. Generate LinkedIn posts in your unique voice. The AI learns from every post you create, getting smarter over time.">
  <meta name="keywords" content="AI content creation, LinkedIn posts, content intelligence, AI writing assistant, personalized AI, content marketing">
  <meta name="author" content="GNX Automation">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cis.gnxautomation.com/">
  <meta property="og:title" content="GNX CIS - AI That Remembers You">
  <meta property="og:description" content="Stop re-explaining yourself to AI. CIS learns your voice in 5 questions and gets smarter with every post.">
  <meta property="og:image" content="https://cis.gnxautomation.com/gnx-logo.jpg">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="GNX CIS - AI That Remembers You">
  <meta name="twitter:description" content="Stop re-explaining yourself to AI. CIS learns your voice in 5 questions.">
  
  <!-- Preconnect to critical origins (reduces connection latency) -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- DNS Prefetch for API endpoints -->
  <link rel="dns-prefetch" href="https://api.cis.gnxautomation.com">
  <link rel="dns-prefetch" href="https://ijwmgwirhorksepabgpj.supabase.co">
  
  <!-- Favicon - Inline to prevent 404 -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='50' font-weight='bold' fill='white' text-anchor='middle'%3EG%3C/text%3E%3C/svg%3E">
  
  <!-- Tailwind CSS - CDN with defer for non-blocking load -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Wait for Tailwind to be available before configuring
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Poppins', 'system-ui', 'sans-serif'],
            },
          }
        }
      }
    }
  </script>
  
  <!-- Custom CSS enhancement (optional, may not load in production) -->
  <link href="/dist/output.css" rel="stylesheet" onerror="console.log('Using CDN Tailwind - local CSS not available')">
  
  <!-- Console Log Filter: Suppress known CDN/SDK warnings in production -->
  <script>
    // Only suppress specific CDN/dev warnings, keep all other logs
    (function() {
      const originalWarn = console.warn;
      console.warn = function(...args) {
        const msg = String(args[0] || '');
        // Only suppress known CDN warnings
        if (msg.includes('cdn.tailwindcss.com') || msg.includes('Clerk:')) return;
        originalWarn.apply(console, args);
      };
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  
  <!-- 
    TODO PRODUCTION: Replace Clerk test keys with production keys
    Get production keys from: https://dashboard.clerk.com
    
    NOTE: Auto-signin is EXPECTED BEHAVIOR, not a security issue.
    Clerk uses secure, encrypted cookies to persist sessions (like Google/Apple SSO).
    User sessions are validated on every page load via JWT.
  -->
  
  <!-- Clerk Configuration - MUST be set BEFORE Clerk.js loads -->
  <script>
    // Set Clerk publishable key before the script loads
    // Production key for cis.gnxautomation.com
    window.__clerk_publishable_key = 'pk_live_Y2xlcmsuY2lzLmdueGF1dG9tYXRpb24uY29tJA';
  </script>
  
  <!-- Clerk.js SDK for Production Authentication -->
  <script 
    data-clerk-publishable-key="pk_live_Y2xlcmsuY2lzLmdueGF1dG9tYXRpb24uY29tJA"
    src="https://unpkg.com/@clerk/clerk-js@latest/dist/clerk.browser.js"
    crossorigin="anonymous"
    async>
  </script>
  
  <!-- Fonts - Using preload to prevent render blocking -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ANIMATIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes text-gradient-animation {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    @keyframes fade-in-up {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    * { box-sizing: border-box; }

    html {
      width: 100%;
      min-width: 320px;
    }

    body {
      margin: 0;
      width: 100%;
      min-width: 320px;
      color: #E0E0E0;
      background-color: #0a0a1a;
      background-image:
        radial-gradient(at 20% 20%, hsla(212, 90%, 50%, 0.405) 0px, transparent 50%),
        radial-gradient(at 80% 20%, hsla(282, 90%, 50%, 0.25) 0px, transparent 50%),
        radial-gradient(at 20% 80%, hsla(332, 90%, 50%, 0.25) 0px, transparent 50%),
        radial-gradient(at 80% 80%, hsla(182, 90%, 50%, 0.25) 0px, transparent 50%);
      font-family: 'Inter', system-ui, sans-serif;
      background-size: cover;
      background-attachment: fixed;
      animation: gradient-animation 30s ease infinite;
      min-height: 100vh;
    }

    /* Responsive container fix */
    .container, .max-w-7xl, .max-w-6xl, .max-w-4xl, .max-w-2xl, .max-w-xl {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
    }

    .animated-gradient-text {
      background-image: linear-gradient(90deg, #22d3ee, #3b82f6, #22d3ee);
      background-size: 200% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: text-gradient-animation 4s linear infinite;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .gradient-button {
      background-image: linear-gradient(to right, #0ea5e9, #3b82f6, #0ea5e9);
      background-size: 200% auto;
      transition: all 0.5s ease;
      border: none;
      cursor: pointer;
    }

    .gradient-button:hover {
      background-position: right center;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .gradient-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .gradient-border-button {
      background-color: transparent;
      border: 1px solid transparent;
      background-image: linear-gradient(rgba(10, 10, 26, 0.8), rgba(10, 10, 26, 0.8)), linear-gradient(to right, #4f46e5, #9333ea);
      background-origin: border-box;
      background-clip: content-box, border-box;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .gradient-border-button:hover {
      background-image: linear-gradient(to right, #4f46e5, #9333ea), linear-gradient(to right, #4f46e5, #9333ea);
      background-clip: padding-box, border-box;
      box-shadow: 0 0 15px rgba(147, 51, 234, 0.4);
    }

    .animate-fade-in-up {
      opacity: 0;
      animation: fade-in-up 0.6s ease-out forwards;
    }

    .shake-error { animation: shake 0.5s ease-in-out; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Hide sections */
    .hidden { display: none !important; }

    /* Input styles */
    input, textarea, select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      padding: 12px 16px;
      width: 100%;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    /* Checkbox inputs should NOT be 100% width */
    input[type="checkbox"] {
      width: auto;
      padding: 0;
    }

    /* Dynamic auto-resize textarea */
    textarea.auto-resize {
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
      resize: vertical;
      line-height: 1.6;
    }
    
    /* Word counter styling */
    .word-counter {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
      text-align: right;
      margin-top: 4px;
    }
    
    .word-counter.warning { color: #fbbf24; }
    .word-counter.limit { color: #ef4444; }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Status badges */
    .status-published { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-draft { background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3); }
    .status-scheduled { background: rgba(14, 165, 233, 0.2); color: #7dd3fc; border: 1px solid rgba(14, 165, 233, 0.3); }

    /* Select dropdown fix for contrast */
    select {
      background-color: rgba(30, 30, 50, 0.95) !important;
      color: white !important;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a78bfa'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    select option {
      background-color: #1e1e32 !important;
      color: white !important;
      padding: 12px;
    }

    select:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
    }
  </style>
</head>
<body class="antialiased">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LANDING PAGE - Full Marketing + Login
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="login-page">
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 1: HERO
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="min-h-screen flex flex-col items-center justify-center p-4 md:p-8 text-center">
      <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-center gap-2 mb-6">
          <img src="/gnx-logo.jpg" alt="GNX Logo" class="w-10 h-10 rounded-lg object-cover" onerror="this.onerror=null; this.src='./gnx-logo.jpg';">
          <span class="text-lg font-bold text-cyan-400">GNX Content Intelligence System</span>
        </div>
        
        <h1 class="text-5xl md:text-6xl lg:text-7xl font-black text-white leading-tight mb-6">
          AI That <span class="animated-gradient-text">Remembers You</span>
        </h1>
        
        <p class="text-xl md:text-2xl text-gray-300 mb-4 max-w-2xl mx-auto">
          Stop re-explaining yourself to AI every time.
        </p>
        <p class="text-lg text-gray-400 mb-8 max-w-2xl mx-auto">
          CIS learns who you are in 5 questions. The more you post, the smarter it gets.
        </p>
        
        <a href="#signup-section" class="inline-flex items-center gap-2 px-8 py-4 gradient-button rounded-xl text-white font-bold text-lg shadow-lg hover:shadow-cyan-500/25 transition-all">
          Start Free - No Credit Card
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
        </a>
        
        <p class="mt-4 text-sm text-gray-500">Join content creators saving 2+ hours per week</p>
      </div>
      
      <!-- Scroll indicator -->
      <div class="absolute bottom-8 animate-bounce">
        <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
        </svg>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 2: HOW IT WORKS
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="py-20 px-4 md:px-8 bg-gradient-to-b from-transparent to-white/5">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-4">How CIS Works</h2>
        <p class="text-gray-400 text-center mb-12 max-w-xl mx-auto">Three simple steps to content that sounds like you</p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="glass-card rounded-2xl p-6 text-center">
            <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-gradient-to-r from-cyan-500/20 to-blue-500/20 flex items-center justify-center"><svg class="w-7 h-7 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></div>
            <h3 class="text-xl font-bold text-white mb-2">Answer 5 Questions</h3>
            <p class="text-gray-400 text-sm">Tell us about yourself, your goals, and your style. Takes 2 minutes.</p>
          </div>
                    
          <div class="glass-card rounded-2xl p-6 text-center">
            <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500/20 to-violet-500/20 flex items-center justify-center"><svg class="w-7 h-7 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></div>
            <h3 class="text-xl font-bold text-white mb-2">Generate Smart Content</h3>
            <p class="text-gray-400 text-sm">CIS remembers who you are. Generates posts in YOUR voice, not generic AI.</p>
          </div>
                    
          <div class="glass-card rounded-2xl p-6 text-center">
            <div class="w-14 h-14 mx-auto mb-4 rounded-full bg-gradient-to-r from-violet-500/20 to-fuchsia-500/20 flex items-center justify-center"><svg class="w-7 h-7 text-fuchsia-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
            <h3 class="text-xl font-bold text-white mb-2">It Gets Smarter</h3>
            <p class="text-gray-400 text-sm">Every post you create improves our learning agent. After 20 posts, personalization is unstoppable.</p>
          </div>
        </div>
        
        <p class="text-center mt-12 text-lg text-cyan-400 font-medium">Your AI finally knows what you actually want</p>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 3: WHY CIS VS OTHER AI
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="py-20 px-4 md:px-8">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-4">Why CIS vs ChatGPT/Claude?</h2>
        <p class="text-gray-400 text-center mb-12 max-w-2xl mx-auto">The difference is <span class="text-cyan-400 font-semibold">persistent memory</span>. Other AI tools start fresh every time. CIS builds a permanent understanding of YOU.</p>
        
        <div class="space-y-6">
          <!-- Comparison 1: Memory -->
          <div class="glass-card rounded-xl p-6">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">ğŸ§  Context & Memory</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-red-500/10 rounded-lg border border-red-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âŒ</span>
                  <p class="text-white font-semibold">ChatGPT / Claude</p>
                </div>
                <p class="text-gray-400 text-sm">"Who are you again? Tell me everything about your company, audience, and goals..."</p>
                <p class="text-red-400/80 text-xs mt-2 italic">Every conversation starts from zero. You waste time repeating context.</p>
              </div>
              <div class="p-4 bg-green-500/10 rounded-lg border border-green-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âœ…</span>
                  <p class="text-white font-semibold">CIS</p>
                </div>
                <p class="text-cyan-400 text-sm">"I remember you're a SaaS founder targeting CTOs. Let's create your post."</p>
                <p class="text-green-400/80 text-xs mt-2 italic">Your profile, style, and preferences are saved permanently.</p>
              </div>
            </div>
          </div>
          
          <!-- Comparison 2: Learning -->
          <div class="glass-card rounded-xl p-6">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">ğŸ“ˆ Continuous Learning</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-red-500/10 rounded-lg border border-red-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âŒ</span>
                  <p class="text-white font-semibold">Other AI Tools</p>
                </div>
                <p class="text-gray-400 text-sm">Same generic output every time, regardless of how many prompts you've written.</p>
                <p class="text-red-400/80 text-xs mt-2 italic">No improvement. Post #100 is the same quality as post #1.</p>
              </div>
              <div class="p-4 bg-green-500/10 rounded-lg border border-green-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âœ…</span>
                  <p class="text-white font-semibold">CIS</p>
                </div>
                <p class="text-cyan-400 text-sm">Gets better with every post. Our learning agent analyzes your style patterns.</p>
                <p class="text-green-400/80 text-xs mt-2 italic">After 20 posts, CIS knows your voice better than you do.</p>
              </div>
            </div>
          </div>
          
          <!-- Comparison 3: LinkedIn Specific -->
          <div class="glass-card rounded-xl p-6">
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">ğŸ’¼ Built for LinkedIn</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-red-500/10 rounded-lg border border-red-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âŒ</span>
                  <p class="text-white font-semibold">General AI</p>
                </div>
                <p class="text-gray-400 text-sm">Generic writing for any platform. Doesn't understand LinkedIn's unique algorithm.</p>
                <p class="text-red-400/80 text-xs mt-2 italic">Your posts look AI-generated and get low engagement.</p>
              </div>
              <div class="p-4 bg-green-500/10 rounded-lg border border-green-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">âœ…</span>
                  <p class="text-white font-semibold">CIS</p>
                </div>
                <p class="text-cyan-400 text-sm">Trained specifically for LinkedIn. Virality scoring, hook optimization, engagement patterns.</p>
                <p class="text-green-400/80 text-xs mt-2 italic">Posts that perform because they're designed for the platform.</p>
              </div>
            </div>
          </div>
        </div>
        
        <p class="text-center mt-10 text-lg text-gray-400">Bottom line: <span class="text-white font-semibold">CIS is the AI that actually knows you.</span></p>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 4: FEATURES AT A GLANCE
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="py-20 px-4 md:px-8 bg-gradient-to-b from-white/5 to-transparent">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-4">What You Get</h2>
        <p class="text-gray-400 text-center mb-12">Everything you need to create content that converts</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">Persistent Memory</h3>
              <p class="text-gray-400 text-sm">AI remembers who you are across all sessions</p>
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-violet-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">5 Writing Styles</h3>
              <p class="text-gray-400 text-sm">Professional, Technical, Inspirational, Storytelling, Thought Leadership</p>
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-fuchsia-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-fuchsia-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">Image Generation</h3>
              <p class="text-gray-400 text-sm">AI-powered visuals for your posts (Pro tier+)</p>
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">Post History & Scores</h3>
              <p class="text-gray-400 text-sm">Track what works with virality scoring</p>
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">LinkedIn Publishing</h3>
              <p class="text-gray-400 text-sm">Direct one-click posting (Business tier)</p>
            </div>
          </div>
          
          <div class="glass-card rounded-xl p-5 flex items-start gap-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <div>
              <h3 class="text-white font-semibold mb-1">Learning Agent</h3>
              <p class="text-gray-400 text-sm">Gets smarter with every post (20 post minimum)</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 5: PRICING PREVIEW
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="py-20 px-4 md:px-8">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-4">Simple Pricing</h2>
        <p class="text-gray-400 text-center mb-12">Start free, upgrade when you're ready</p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Free -->
          <div class="glass-card rounded-2xl p-6 text-center">
            <h3 class="text-xl font-bold text-white mb-2">Free</h3>
            <div class="text-4xl font-black text-white mb-1">$0</div>
            <p class="text-gray-500 text-sm mb-6">/month</p>
            <ul class="text-left text-gray-400 text-sm space-y-2 mb-6">
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 5 posts/month</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 3 writing styles</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Persona setup</li>
              <li class="flex items-center gap-2"><span class="text-gray-600">âœ—</span> No images</li>
            </ul>
            <a href="#signup-section" class="block w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-semibold transition-colors">Get Started</a>
          </div>
          
          <!-- Pro (Featured) -->
          <div class="glass-card rounded-2xl p-6 text-center border-2 border-cyan-500/50 relative transform md:-translate-y-4">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full text-white text-xs font-bold">BEST VALUE</div>
            <h3 class="text-xl font-bold text-white mb-2 mt-2">Pro</h3>
            <div class="text-4xl font-black text-cyan-400 mb-1">$49</div>
            <p class="text-gray-500 text-sm mb-6">/month</p>
            <ul class="text-left text-gray-400 text-sm space-y-2 mb-6">
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 30 posts/month</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> All 5 styles</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Image generation</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Smart learning</li>
            </ul>
            <a href="#signup-section" class="block w-full py-2 px-4 gradient-button rounded-lg text-white font-semibold">Start 30-Day Free Trial</a>
          </div>
          
          <!-- Business -->
          <div class="glass-card rounded-2xl p-6 text-center">
            <h3 class="text-xl font-bold text-white mb-2">Business</h3>
            <div class="text-4xl font-black text-white mb-1">$199</div>
            <p class="text-gray-500 text-sm mb-6">/month</p>
            <ul class="text-left text-gray-400 text-sm space-y-2 mb-6">
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> 200 posts/month</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> LinkedIn publishing</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Full analytics</li>
              <li class="flex items-center gap-2"><span class="text-green-400">âœ“</span> Priority support</li>
            </ul>
            <a href="#signup-section" class="block w-full py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-semibold transition-colors">Start 30-Day Free Trial</a>
          </div>
        </div>
        
        <p class="text-center mt-8">
          <a href="/pricing.html" class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors">View Full Pricing & Compare Plans â†’</a>
        </p>
      </div>
    </section>

    <!-- Testimonials section removed - will add real testimonials when available -->

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 7: FAQ
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="py-20 px-4 md:px-8">
      <div class="max-w-3xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white text-center mb-4">Common Questions</h2>
        <p class="text-gray-400 text-center mb-12">Everything you need to know</p>
        
        <div class="space-y-4">
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">What's the 20 post minimum for learning?</h3>
            <p class="text-gray-400 text-sm">After 20 posts, our learning agent has enough data about your voice, style, and goals. Before that, it's learning. After 20, it's magic.</p>
          </div>
          
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">Can I try for free first?</h3>
            <p class="text-gray-400 text-sm">Yes! Free tier gives 5 posts/month forever. Pro and Business get a 30-day free trial. No credit card needed to start.</p>
          </div>
          
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">Do you save my data?</h3>
            <p class="text-gray-400 text-sm">Yes, in Supabase. Your persona data is encrypted and only used to improve your content. We never share or sell it.</p>
          </div>
          
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">Can I cancel anytime?</h3>
            <p class="text-gray-400 text-sm">Yes. Cancel your subscription anytime, no questions asked. Your data stays available on the free tier.</p>
          </div>
          
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">Is my LinkedIn account safe?</h3>
            <p class="text-gray-400 text-sm">Yes. We use OAuth (official LinkedIn login). You control what CIS can access. We never store your LinkedIn password.</p>
          </div>
          
          <div class="glass-card rounded-xl p-5">
            <h3 class="text-white font-semibold mb-2">What payment methods do you accept?</h3>
            <p class="text-gray-400 text-sm">Credit cards (Visa, Mastercard, Amex) via Stripe. Secure and encrypted.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION 8: SIGNUP / LOGIN FORM
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="signup-section" class="py-20 px-4 md:px-8 bg-gradient-to-b from-white/5 to-transparent">
      <div class="max-w-md mx-auto">
        <div class="glass-card rounded-2xl p-6 md:p-8 shadow-2xl">
          <h2 class="text-3xl font-bold text-center text-white mb-2">Get Started Free</h2>
          <p class="text-center text-gray-400 mb-8">No credit card required</p>
          
          <form id="login-form" onsubmit="handleLogin(event)">
            <div class="space-y-6">
              <div>
                <label class="block text-sm text-gray-400 mb-2">Email Address</label>
                <input type="email" id="login-email" placeholder="your@email.com" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">Password</label>
                <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
              </div>
            </div>

            <!-- Forgot Password Link -->
            <div class="text-right mt-2">
              <a href="#" onclick="forgotPassword(event)" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">
                Forgot Password?
              </a>
            </div>

            <div id="login-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert" aria-live="polite" data-testid="login-error">
              Invalid email or password.
            </div>
            
            <!-- Show this when user is already signed in -->
            <div id="already-signed-in" class="hidden mt-4 text-center">
              <p class="text-cyan-400 text-sm mb-3">You're already signed in.</p>
              <button type="button" onclick="continueToExistingSession()" class="w-full py-2 px-4 bg-violet-600 hover:bg-violet-700 rounded-lg text-white font-medium transition-colors">
                Continue to Dashboard â†’
              </button>
            </div>

            <button type="submit" id="login-btn" class="w-full mt-8 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
              <span id="login-btn-text">Sign In</span>
              <svg id="login-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>
          
          <!-- Signup Form (initially hidden) -->
          <form id="signup-form" onsubmit="handleSignup(event)" class="hidden">
            <div class="space-y-6">
              <div>
                <label class="block text-sm text-gray-400 mb-2">First Name</label>
                <input type="text" id="signup-firstname" placeholder="John" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">Email Address</label>
                <input type="email" id="signup-email" placeholder="your@email.com" required>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">Password</label>
                <input type="password" id="signup-password" placeholder="Min 8 characters" required minlength="8">
                <p class="text-xs text-gray-500 mt-1">Must be at least 8 characters with letters and numbers</p>
              </div>
            </div>

            <div id="signup-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert" aria-live="polite" data-testid="signup-error">
              Error creating account.
            </div>

            <button type="submit" id="signup-btn" class="w-full mt-8 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
              <span id="signup-btn-text">Start Free - No Credit Card</span>
              <svg id="signup-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>

          <!-- Email Verification Form (initially hidden) -->
          <form id="verify-form" onsubmit="handleVerifyCode(event)" class="hidden">
            <div class="text-center mb-6">
              <svg class="w-16 h-16 mx-auto text-violet-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
              <h3 class="text-xl font-semibold text-white mb-2">Check Your Email</h3>
              <p class="text-sm text-gray-400">We sent a 6-digit code to <span id="verify-email-display" class="text-violet-400"></span></p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-400 mb-2">Verification Code</label>
                <input type="text" id="verify-code" placeholder="Enter 6-digit code" required maxlength="6" pattern="[0-9]{6}"
                       class="text-center text-2xl tracking-widest font-mono">
              </div>
            </div>

            <div id="verify-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert">
              Invalid verification code.
            </div>

            <button type="submit" id="verify-btn" class="w-full mt-6 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
              <span id="verify-btn-text">Verify & Continue</span>
              <svg id="verify-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
            
            <button type="button" onclick="resendVerificationCode()" class="w-full mt-3 py-2 text-sm text-gray-400 hover:text-white transition-colors">
              Didn't receive code? Resend
            </button>
          </form>

          <!-- Password Reset Form (initially hidden) -->
          <form id="reset-password-form" onsubmit="handleResetPassword(event)" class="hidden">
            <div class="text-center mb-6">
              <svg class="w-16 h-16 mx-auto text-cyan-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
              </svg>
              <h3 class="text-xl font-semibold text-white mb-2">Reset Your Password</h3>
              <p class="text-sm text-gray-400">Enter the 6-digit code sent to <span id="reset-email-display" class="text-cyan-400"></span></p>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-400 mb-2">Reset Code</label>
                <input type="text" id="reset-code" placeholder="Enter 6-digit code" required maxlength="6" pattern="[0-9]{6}"
                       class="text-center text-2xl tracking-widest font-mono">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">New Password</label>
                <input type="password" id="reset-new-password" placeholder="Min 8 characters" required minlength="8">
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-2">Confirm New Password</label>
                <input type="password" id="reset-confirm-password" placeholder="Confirm password" required minlength="8">
              </div>
            </div>

            <div id="reset-error" class="hidden mt-4 text-center text-red-400 text-sm shake-error" role="alert">
              Error resetting password.
            </div>
            
            <div id="reset-success" class="hidden mt-4 text-center text-green-400 text-sm" role="status">
              Password reset successfully! You can now sign in.
            </div>

            <button type="submit" id="reset-btn" class="w-full mt-6 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
              <span id="reset-btn-text">Reset Password</span>
              <svg id="reset-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
            
            <button type="button" onclick="backToLogin()" class="w-full mt-3 py-2 text-sm text-gray-400 hover:text-white transition-colors">
              â† Back to Sign In
            </button>
          </form>

          <!-- Auth Toggle Button -->
          <div id="auth-toggle-container" class="mt-6 text-center">
            <button type="button" id="auth-toggle-btn" onclick="toggleAuthForm()" class="text-sm text-violet-400 hover:text-violet-300 transition-colors">
              Don't have an account? <span class="font-semibold">Sign up</span>
            </button>
          </div>
        </div>
        
        <!-- Trust badges -->
        <div class="flex items-center justify-center gap-6 mt-8 text-gray-500 text-xs">
          <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg> SSL Encrypted</span>
          <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Fast Setup</span>
          <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg> Secure Data</span>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-8 px-4 text-center text-gray-500 text-sm border-t border-white/5">
      <p>Â© 2025 GNX Automation. All rights reserved.</p>
      <p class="mt-2">
        <a href="/pricing.html" class="text-gray-400 hover:text-white transition-colors">Pricing</a>
        <span class="mx-2">â€¢</span>
        <a href="mailto:support@gnxautomation.com" class="text-gray-400 hover:text-white transition-colors">Support</a>
      </p>
    </footer>
    
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ONBOARDING PAGE (Split-Screen: Questions + Paste Content)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="onboarding-page" class="hidden min-h-screen flex items-center justify-center p-4 md:p-8">
    <div class="w-full max-w-5xl">
      <!-- Header -->
      <div class="text-center mb-10">
        <div class="flex items-center justify-center gap-3 mb-4">
          <img src="/gnx-logo.jpg" alt="GNX Logo" class="w-10 h-10 rounded-lg object-cover" onerror="this.onerror=null; this.src='./gnx-logo.jpg';">
          <span class="text-lg font-semibold text-cyan-400">GNX CIS</span>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">Let's Personalize Your Experience</h1>
        <p class="text-gray-400 text-base">Help us understand your voice so we can generate content that sounds like you</p>
        
        <!-- Progress Steps -->
        <div class="flex items-center justify-center gap-4 mt-6">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-violet-600 flex items-center justify-center text-white text-sm font-bold">1</div>
            <span class="text-white text-sm font-medium hidden md:inline">Your Profile</span>
          </div>
          <div class="w-8 md:w-16 h-0.5 bg-gray-700"></div>
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-sm font-bold">2</div>
            <span class="text-gray-400 text-sm hidden md:inline">Start Creating</span>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Side: 5 Questions -->
        <div class="glass-card rounded-2xl p-6 md:p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
              ğŸ“ Quick Questions
            </h2>
            <span class="text-xs text-red-400 font-medium px-2 py-1 bg-red-500/10 rounded-full">Required</span>
          </div>
          
          <form id="onboarding-form" class="space-y-5">
            <!-- Question 1: Industry -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">1. What industry are you in?</label>
              <select id="onboarding-industry" required class="w-full h-12">
                <option value="">Select your industry...</option>
                <optgroup label="Technology & Computing">
                  <option value="Computer Software">Computer Software</option>
                  <option value="Information Technology & Services">Information Technology & Services</option>
                  <option value="Internet">Internet</option>
                  <option value="Artificial Intelligence">Artificial Intelligence</option>
                  <option value="Telecommunications">Telecommunications</option>
                </optgroup>
                <optgroup label="Finance & Business">
                  <option value="Financial Services">Financial Services</option>
                  <option value="Banking">Banking</option>
                  <option value="Management Consulting">Management Consulting</option>
                  <option value="Venture Capital & Private Equity">Venture Capital & Private Equity</option>
                </optgroup>
                <optgroup label="Healthcare & Life Sciences">
                  <option value="Hospital & Health Care">Hospital & Health Care</option>
                  <option value="Pharmaceuticals">Pharmaceuticals</option>
                  <option value="Biotechnology">Biotechnology</option>
                </optgroup>
                <optgroup label="Professional Services">
                  <option value="Marketing & Advertising">Marketing & Advertising</option>
                  <option value="Legal Services">Legal Services</option>
                  <option value="Human Resources Services">Human Resources Services</option>
                </optgroup>
                <optgroup label="Manufacturing & Energy">
                  <option value="Manufacturing">Manufacturing</option>
                  <option value="Automotive">Automotive</option>
                  <option value="Oil & Energy">Oil & Energy</option>
                  <option value="Renewables & Environment">Renewables & Environment</option>
                </optgroup>
                <optgroup label="Education & Non-Profit">
                  <option value="Higher Education">Higher Education</option>
                  <option value="Professional Training & Coaching">Professional Training & Coaching</option>
                  <option value="Non-Profit Organization">Non-Profit Organization</option>
                </optgroup>
                <optgroup label="Other Industries">
                  <option value="Real Estate">Real Estate</option>
                  <option value="Retail">Retail</option>
                  <option value="E-commerce">E-commerce</option>
                  <option value="Media Production">Media Production</option>
                  <option value="Government Administration">Government Administration</option>
                  <option value="Other">Other</option>
                </optgroup>
              </select>
            </div>
            
            <!-- Question 2: Target Audience -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">2. Who is your target audience?</label>
              <input type="text" id="onboarding-audience" class="w-full h-12" placeholder="e.g., CTOs, HR professionals, startup founders..." required>
            </div>
            
            <!-- Question 3: Content Style -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-3">3. Your preferred content style</label>
              <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center justify-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer border border-white/10 hover:border-violet-500/50 transition-all has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/15 text-center">
                  <input type="radio" name="onboarding-style" value="Professional" required class="w-4 h-4 text-violet-500 bg-gray-700 border-gray-600 focus:ring-violet-500 accent-violet-500">
                  <span class="text-white text-sm font-medium">Professional</span>
                </label>
                <label class="flex items-center justify-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer border border-white/10 hover:border-violet-500/50 transition-all has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/15 text-center">
                  <input type="radio" name="onboarding-style" value="Storytelling" class="w-4 h-4 text-violet-500 bg-gray-700 border-gray-600 focus:ring-violet-500 accent-violet-500">
                  <span class="text-white text-sm font-medium">Storytelling</span>
                </label>
                <label class="flex items-center justify-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer border border-white/10 hover:border-violet-500/50 transition-all has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/15 text-center">
                  <input type="radio" name="onboarding-style" value="Technical" class="w-4 h-4 text-violet-500 bg-gray-700 border-gray-600 focus:ring-violet-500 accent-violet-500">
                  <span class="text-white text-sm font-medium">Technical</span>
                </label>
                <label class="flex items-center justify-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer border border-white/10 hover:border-violet-500/50 transition-all has-[:checked]:border-violet-500 has-[:checked]:bg-violet-500/15 text-center">
                  <input type="radio" name="onboarding-style" value="Inspirational" class="w-4 h-4 text-violet-500 bg-gray-700 border-gray-600 focus:ring-violet-500 accent-violet-500">
                  <span class="text-white text-sm font-medium">Inspirational</span>
                </label>
              </div>
            </div>
            
            <!-- Question 4: Topics -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">4. Topics you focus on</label>
              <input type="text" id="onboarding-topics" class="w-full h-12" placeholder="e.g., Leadership, AI, Product Management..." required>
              <p class="text-xs text-gray-500 mt-1.5">Separate multiple topics with commas</p>
            </div>
            
            <!-- Question 5: Primary Goal -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">5. Your primary goal</label>
              <select id="onboarding-goal" required class="w-full h-12">
                <option value="">Select your goal...</option>
                <option value="Thought Leadership">ğŸ¯ Thought Leadership</option>
                <option value="Brand Awareness">ğŸ“¢ Brand Awareness</option>
                <option value="Lead Generation">ğŸ’¼ Lead Generation</option>
                <option value="Career Opportunities">ğŸš€ Career Opportunities</option>
                <option value="Community Building">ğŸ¤ Community Building</option>
              </select>
            </div>
          </form>
        </div>
        
        <!-- Right Side: Paste Content -->
        <div class="glass-card rounded-2xl p-6 md:p-8 flex flex-col">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
              ğŸ“‹ Share Your Content
            </h2>
            <span class="text-xs text-gray-500 font-medium px-2 py-1 bg-gray-700/50 rounded-full">Optional</span>
          </div>
          
          <p class="text-gray-400 text-sm mb-3">Paste any content that helps us understand your voice:</p>
          
          <ul class="text-gray-500 text-sm mb-4 space-y-1.5 pl-1">
            <li class="flex items-center gap-2"><span class="text-violet-400">â€¢</span> Your best LinkedIn posts</li>
            <li class="flex items-center gap-2"><span class="text-violet-400">â€¢</span> Your LinkedIn bio/headline</li>
            <li class="flex items-center gap-2"><span class="text-violet-400">â€¢</span> Posts you admire from others</li>
          </ul>
          
          <textarea 
            id="onboarding-content" 
            class="w-full flex-1 min-h-[200px] resize-none rounded-xl" 
            placeholder="Paste your content here...

Example:
My LinkedIn headline: Digital transformation leader | 15+ years in enterprise software

My best post:
ğŸš€ Just led my team through a 6-month SAP migration that saved $2M annually..."></textarea>
          
          <div class="mt-4 p-3 bg-gradient-to-r from-violet-500/10 to-cyan-500/10 rounded-xl border border-violet-500/20">
            <p class="text-gray-300 text-sm flex items-start gap-2">
              <span class="text-lg">ğŸ’¡</span>
              <span><strong class="text-violet-300">Pro tip:</strong> The more examples you provide, the better we can match your unique voice!</span>
            </p>
          </div>
        </div>
      </div>
      
      <!-- Submit Button -->
      <div class="mt-8 text-center">
        <button onclick="handleOnboardingSubmit()" id="onboarding-submit-btn" class="px-10 py-4 gradient-button rounded-xl text-white font-bold text-base inline-flex items-center justify-center gap-3 shadow-lg hover:shadow-violet-500/25 transition-shadow">
          <span id="onboarding-btn-text">Complete Setup & Start Creating</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
          </svg>
          <svg id="onboarding-spinner" class="hidden animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
        <p id="onboarding-error" class="hidden mt-4 text-red-400 text-sm"></p>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD PAGE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="dashboard-page" class="hidden flex flex-col min-h-screen">
    
    <!-- Header -->
    <header class="sticky top-0 z-10 glass-card p-4">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
          <svg class="w-8 h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
          </svg>
          <div class="text-xl font-bold text-white">GNX CIS</div>
        </div>

        <nav>
          <ul class="flex items-center gap-6">
            <li><a id="nav-dashboard" class="font-bold text-white text-sm cursor-pointer" onclick="showSection('dashboard')" data-testid="nav-dashboard">Dashboard</a></li>
            <li><a id="nav-generate" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('generate')" data-testid="nav-generate">Generate</a></li>
            <li><a id="nav-history" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('history')" data-testid="nav-history">History</a></li>
            <li><a id="nav-settings" class="text-gray-400 hover:text-white transition-colors text-sm cursor-pointer" onclick="showSection('settings')" data-testid="nav-settings">âš™ï¸ Settings</a></li>
          </ul>
        </nav>

        <div class="flex items-center gap-4">
          <div class="text-right">
            <div class="flex items-center gap-2 justify-end">
              <p class="text-white font-semibold text-sm" id="user-name">User</p>
              <span id="current-plan-badge" class="px-2 py-0.5 text-xs font-bold rounded-full bg-gray-600/30 text-gray-300">ğŸ†“ Free</span>
              <span id="current-plan-name" class="hidden">Free</span>
            </div>
            <p class="text-gray-400 text-xs" id="user-email">user@example.com</p>
          </div>
          <button id="logout-btn" onclick="handleLogout()" class="px-4 py-2 text-sm font-medium text-white rounded-lg gradient-border-button" data-testid="logout-btn">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="container mx-auto">
        
        <!-- Dashboard Section -->
        <div id="section-dashboard">
          <h1 class="text-3xl font-bold text-white mb-8">Dashboard</h1>
          
          <!-- Dashboard Error (BLOCKER 7) -->
          <div id="dashboard-error" role="alert" aria-live="assertive" data-testid="dashboard-error" class="hidden mb-6 p-4 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400">
            <span class="font-semibold">âš ï¸ Error:</span> <span id="dashboard-error-text">Failed to load dashboard data.</span>
          </div>
          
          <!-- Metrics Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 0ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Posts Generated</p>
                  <p class="text-3xl font-bold text-white" id="metric-posts">0</p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-violet-500/20">
                  <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                </div>
              </div>
              <p class="text-xs text-green-400">This session</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 100ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Average Score</p>
                  <p class="text-3xl font-bold text-white" id="metric-avg-score">0</p>
                </div>
                <div id="avg-trend" class="hidden flex items-center gap-1 px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-medium">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                  </svg>
                  <span id="avg-trend-value">+0</span>
                </div>
              </div>
              <!-- Mini Sparkline -->
              <svg id="score-sparkline" class="w-full h-8 opacity-50" viewBox="0 0 100 20">
                <polyline id="sparkline-path" points="0,15" fill="none" stroke="currentColor" stroke-width="1.5" class="text-violet-400"/>
              </svg>
              <p class="text-xs text-violet-400">Last 10 posts</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 200ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">Best Score</p>
                  <p class="text-3xl font-bold text-white" id="metric-best-score">0</p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500/20">
                  <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                  </svg>
                </div>
              </div>
              <p class="text-xs text-green-400">Highest achieved</p>
            </div>
            
            <div class="glass-card rounded-xl p-6 animate-fade-in-up" style="animation-delay: 300ms">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="text-sm text-gray-400 mb-1">API Status</p>
                  <p class="text-3xl font-bold text-white" id="metric-api-status">...</p>
                </div>
                <div id="api-status-icon" class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-500/20">
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                  </svg>
                </div>
              </div>
              <div class="w-full bg-white/10 rounded-full h-2.5">
                <div id="api-status-bar" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <!-- Learning Progress Card (hidden for admin users) -->
          <div id="learning-progress-card" class="glass-card rounded-xl p-6 mb-8 animate-fade-in-up" style="animation-delay: 400ms">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-r from-cyan-500/20 to-violet-500/20">
                  <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                </div>
                <div>
                  <h3 class="text-lg font-bold text-white">Learning Progress</h3>
                  <p id="learning-status-text" class="text-sm text-gray-400">Generate posts to unlock personalization</p>
                </div>
              </div>
              
              <div class="flex-1 max-w-md">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm text-gray-400">Posts Generated</span>
                  <span class="text-sm font-semibold">
                    <span id="learning-post-count" class="text-cyan-400">0</span>
                    <span class="text-gray-500">/ 20</span>
                  </span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-3">
                  <div id="learning-progress-bar" class="bg-gradient-to-r from-cyan-500 to-violet-500 h-3 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
                <p id="learning-milestone-text" class="text-xs text-gray-500 mt-2">20 posts until personalization unlocks</p>
              </div>
            </div>
            
            <!-- Unlocked State (hidden by default) -->
            <div id="learning-unlocked-banner" class="hidden mt-4 p-3 bg-gradient-to-r from-green-500/20 to-cyan-500/20 rounded-lg border border-green-500/30">
              <p class="text-green-400 text-sm font-medium flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span>Personalization Unlocked! Your AI now knows your voice and style.</span>
              </p>
            </div>
            
            <!-- Voice Profile Section (hidden by default, shown when personalization unlocked) -->
            <div id="voice-profile-section" class="hidden mt-4">
              <button onclick="toggleVoiceProfile()" class="flex items-center gap-2 text-cyan-400 hover:text-cyan-300 text-sm font-medium transition-colors mb-3">
                <svg id="voice-profile-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                <span>View Your Voice Profile</span>
              </button>
              
              <div id="voice-profile-content" class="hidden p-4 bg-gradient-to-r from-cyan-500/5 to-violet-500/5 rounded-lg border border-cyan-500/20">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-violet-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <div>
                      <p class="text-gray-400 text-xs">Industry</p>
                      <p id="profile-industry" class="text-white font-medium">Loading...</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-cyan-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <div>
                      <p class="text-gray-400 text-xs">Target Audience</p>
                      <p id="profile-audience" class="text-white font-medium">Loading...</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-emerald-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    <div>
                      <p class="text-gray-400 text-xs">Writing Style</p>
                      <p id="profile-style" class="text-white font-medium">Loading...</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-amber-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                    <div>
                      <p class="text-gray-400 text-xs">Key Topics</p>
                      <p id="profile-topics" class="text-white font-medium">Loading...</p>
                    </div>
                  </div>
                </div>
                <p class="text-gray-500 text-xs mt-4 italic">This profile is built from your onboarding and 20+ generated posts.</p>
              </div>
            </div>
          </div>

          <!-- Recent Posts -->
          <h2 class="text-2xl font-bold text-white mb-6">Recent Posts</h2>
          <div id="recent-posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="glass-card rounded-xl p-6 text-center text-gray-400">
              <p>No posts yet. Generate your first post!</p>
              <button onclick="showSection('generate')" class="mt-4 px-6 py-2 gradient-button rounded-lg text-white font-semibold">
                Generate Post
              </button>
            </div>
          </div>
        </div>

        <!-- Generate Section -->
        <div id="section-generate" class="hidden">
          <h1 class="text-3xl font-bold text-white mb-8">Generate Content</h1>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form -->
            <div class="glass-card rounded-xl p-6">
              <h3 class="text-xl font-semibold text-white mb-6">Create New Post</h3>
              
              <form id="generate-form" onsubmit="handleGenerate(event)">
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm text-gray-400 mb-2">Topic / Content *</label>
                    <textarea 
                      id="topic-input" 
                      class="auto-resize" 
                      placeholder="What do you want to write about? e.g., SAP S/4HANA migration tips...&#10;&#10;You can also paste existing content here to improve it." 
                      required
                      oninput="autoResizeTextarea(this); updateWordCount(this);"
                    ></textarea>
                    <div id="word-counter" class="word-counter">0 / 2000 words</div>
                  </div>
                  
                  <div>
                    <label class="block text-sm text-gray-400 mb-2">Style</label>
                    <select id="style-select">
                      <option value="professional">Professional - Polished & authoritative</option>
                      <option value="technical">Technical - Data-driven with metrics</option>
                      <option value="inspirational">Inspirational - Motivating & empowering</option>
                      <option value="thought_leadership">Thought Leadership - Bold & contrarian</option>
                      <option value="storytelling">Storytelling - Narrative with anecdotes</option>
                    </select>
                  </div>
                  
                  <!-- Admin Persona Toggle (hidden from non-admin users) -->
                  <div id="admin-persona-section" class="hidden" data-testid="admin-persona-section">
                    <label class="block text-sm text-gray-400 mb-2">Admin Persona</label>
                    <div class="inline-flex items-center gap-4 p-3 glass-card rounded-lg">
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="persona-toggle" class="sr-only peer" checked aria-checked="true" data-testid="persona-toggle" aria-label="Enable Kunal Persona" onchange="handlePersonaToggle(this)">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-violet-300/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600"></div>
                      </label>
                      <div id="persona-toggle-label">
                        <span class="text-white font-medium">Kunal Persona</span>
                        <p class="text-xs text-gray-400">Using your profile & audience insights</p>
                      </div>
                    </div>
                    <div id="persona-details" class="mt-2 text-xs text-gray-500">
                      <span>SAP PM | IT Services & Consulting | Toronto, Delhi</span>
                    </div>
                    <!-- Manual persona input (shown when toggle is OFF) -->
                    <div id="admin-manual-persona-section" class="hidden mt-3">
                      <label class="block text-sm text-gray-400 mb-2">Custom Persona (Optional)</label>
                      <input type="text" id="admin-persona-input" placeholder="e.g., AI Development Expert, Tech Blogger...">
                    </div>
                  </div>
                  
                  <!-- Regular Persona Input (for non-admin users) -->
                  <div id="regular-persona-section" data-testid="regular-persona-section">
                    <label class="block text-sm text-gray-400 mb-2">Persona (Optional)</label>
                    <input type="text" id="persona-input" placeholder="e.g., SAP Consultant with 10 years experience">
                  </div>
                </div>

                <!-- Image Generation Toggle (Premium Feature) -->
                <div class="mt-4" id="image-toggle-container">
                  <label for="generate-image-toggle" class="flex items-center gap-2 cursor-pointer" style="white-space: nowrap;" id="image-toggle-label">
                    <input type="checkbox" id="generate-image-toggle" class="rounded border-gray-600 bg-gray-800 text-violet-500 focus:ring-violet-500 cursor-pointer" style="width: 16px; height: 16px; flex-shrink: 0;" disabled>
                    <span class="text-sm text-gray-300">Generate AI Image</span>
                    <span id="image-upgrade-badge" class="ml-2 px-2 py-0.5 text-xs rounded-full bg-gradient-to-r from-cyan-500/30 to-violet-500/30 text-cyan-300 border border-cyan-500/30">
                      â­ Pro
                    </span>
                  </label>
                  <p id="image-upgrade-hint" class="text-xs text-gray-500 mt-1 ml-6">
                    <a href="#" onclick="showSection('settings'); return false;" class="text-cyan-400 hover:text-cyan-300 underline">Upgrade to Pro</a> to generate AI images with your posts
                  </p>
                  
                  <!-- Admin-only: Image Generator Selection -->
                  <div id="admin-image-generator-section" class="hidden mt-3 ml-6 p-3 glass-card rounded-lg border border-purple-500/30">
                    <label class="block text-xs text-purple-400 mb-2">Admin: Image Generator</label>
                    <select id="image-generator-select" class="w-full text-sm">
                      <option value="gemini">Gemini Nano-Banana (Dynamic)</option>
                      <option value="branded">Branded Template (Fast)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                      Gemini Nano-Banana creates unique visuals. Branded uses your GNX template.
                    </p>
                  </div>
                </div>

                <button type="submit" id="generate-btn" class="w-full mt-6 py-3 px-4 font-semibold text-white rounded-lg gradient-button flex items-center justify-center">
                  <span id="generate-btn-text">Generate Post</span>
                  <svg id="generate-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
                
                <!-- Generate status/error messages for E2E tests -->
                <div id="generate-status" class="hidden mt-4 p-3 rounded-lg bg-blue-500/20 text-blue-400 text-sm" role="status" aria-live="polite" data-testid="generate-status"></div>
                <div id="generate-error" class="hidden mt-4 p-3 rounded-lg bg-red-500/20 text-red-400 text-sm shake-error" role="alert" aria-live="assertive" data-testid="generate-error"></div>
              </form>
            </div>

            <!-- Result Preview -->
            <div id="result-panel" class="glass-card rounded-xl p-6">
              <h3 class="text-xl font-semibold text-white mb-6">Generated Post</h3>
              
              <div id="result-empty" class="text-center text-gray-400 py-12">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <p>Your generated content will appear here</p>
              </div>

              <!-- Agent Progress Indicator -->
              <div id="agent-progress" class="hidden">
                <div class="text-center mb-6">
                  <div class="inline-flex items-center gap-3 px-6 py-3 glass-card rounded-full">
                    <svg class="animate-spin h-5 w-5 text-violet-400" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="current-agent" class="text-white font-semibold">Initializing...</span>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <div id="step-content" class="flex items-center gap-3 p-3 rounded-lg bg-white/5">
                    <div id="step-content-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">1</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ContentAgent</p>
                      <p class="text-xs text-gray-400">Generating viral content...</p>
                    </div>
                    <div id="step-content-status" class="text-gray-400">â³</div>
                  </div>
                  
                  <div id="step-virality" class="flex items-center gap-3 p-3 rounded-lg bg-white/5 opacity-50">
                    <div id="step-virality-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">2</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ViralityAgent</p>
                      <p class="text-xs text-gray-400">Scoring engagement potential...</p>
                    </div>
                    <div id="step-virality-status" class="text-gray-400">â³</div>
                  </div>
                  
                  <div id="step-image" class="flex items-center gap-3 p-3 rounded-lg bg-white/5 opacity-50">
                    <div id="step-image-icon" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                      <span class="text-sm">3</span>
                    </div>
                    <div class="flex-1">
                      <p class="text-white font-medium">ImageGenerator</p>
                      <p class="text-xs text-gray-400">Creating branded visual...</p>
                    </div>
                    <div id="step-image-status" class="text-gray-400">â³</div>
                  </div>
                </div>
              </div>

              <div id="result-content" class="hidden">
                <div class="flex items-center justify-between mb-4">
                  <span class="text-sm text-gray-400">Virality Score</span>
                  <span id="result-score" class="text-2xl font-bold text-green-400">0/100</span>
                </div>
                
                <div class="bg-white/5 rounded-lg p-4 mb-4">
                  <p id="result-text" class="text-white whitespace-pre-wrap"></p>
                </div>

                <div class="mt-4">
                  <h4 class="text-sm font-semibold text-gray-400 mb-2">Suggestions</h4>
                  <ul id="result-suggestions" class="list-disc list-inside text-sm text-gray-300 space-y-1"></ul>
                </div>

                <!-- Image Container (for generated or deferred images) -->
                <div id="result-image-container"></div>

                <div class="flex gap-4 mt-6">
                  <button onclick="copyToClipboard()" class="flex-1 py-2 px-4 gradient-border-button rounded-lg text-white font-semibold">
                    Copy
                  </button>
                  <button onclick="editCurrentPost()" class="flex-1 py-2 px-4 gradient-border-button rounded-lg text-white font-semibold">
                    Edit
                  </button>
                  <button onclick="improvePost()" class="flex-1 py-2 px-4 gradient-button rounded-lg text-white font-semibold">
                    Improve
                  </button>
                </div>
                
                <!-- Admin LinkedIn Actions (only visible to admins) -->
                <div id="admin-linkedin-actions" class="hidden mt-6 pt-6 border-t border-white/10">
                  <h4 class="text-sm font-semibold text-violet-400 mb-3">Admin Actions</h4>
                  <div class="flex gap-3 flex-wrap">
                    <button onclick="publishToLinkedIn()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                      Publish Now
                    </button>
                    <button onclick="showScheduleModal()" class="px-4 py-2 bg-violet-600 hover:bg-violet-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      Schedule
                    </button>
                    <button onclick="saveAsDraft()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold text-sm transition-colors flex items-center gap-2">
                      Save Draft
                    </button>
                  </div>
                  <p id="linkedin-action-status" class="mt-3 text-sm text-gray-400 hidden"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- History Section -->
        <div id="section-history" class="hidden">
          <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
            <h1 class="text-3xl font-bold text-white">Post History</h1>
            <div class="flex flex-wrap items-center gap-3">
              <input 
                type="text" 
                id="history-search" 
                placeholder="ğŸ” Search posts..." 
                oninput="updateHistoryGrid()"
                class="px-4 py-2 rounded-lg text-sm w-48">
              <select id="history-filter-score" onchange="updateHistoryGrid()" class="px-4 py-2 rounded-lg text-sm">
                <option value="all">All Scores</option>
                <option value="90">90+ (Excellent)</option>
                <option value="70">70-89 (Good)</option>
                <option value="below">Below 70</option>
              </select>
              <select id="history-sort" onchange="updateHistoryGrid()" class="px-4 py-2 rounded-lg text-sm">
                <option value="recent">Recent First</option>
                <option value="oldest">Oldest First</option>
                <option value="highest">Highest Score</option>
                <option value="lowest">Lowest Score</option>
              </select>
            </div>
          </div>
          <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="glass-card rounded-xl p-6 text-center text-gray-400">
              <p>No posts in history yet.</p>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="section-settings" class="hidden">
          <h1 class="text-3xl font-bold text-white mb-8">Settings</h1>
          
          <!-- Subscription & Billing Section -->
          <div id="subscription-settings-section" class="glass-card rounded-xl p-6 mb-6 max-w-2xl">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              <svg class="w-6 h-6 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
              Subscription & Billing
            </h2>
            
            <div class="mb-4">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-gray-400">Current Plan:</span>
                <span id="settings-plan-badge" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-500/20 text-gray-400">FREE</span>
              </div>
              <p id="settings-plan-description" class="text-gray-500 text-sm">5 posts per month, basic features</p>
            </div>
            
            <!-- Monthly Usage -->
            <div class="mb-6 p-4 bg-white/5 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Monthly Usage</span>
                <span class="text-sm">
                  <span id="settings-posts-used" class="text-white font-semibold">0</span>
                  <span class="text-gray-500">/ <span id="settings-posts-limit">5</span> posts</span>
                </span>
              </div>
              <div class="w-full bg-white/10 rounded-full h-2">
                <div id="settings-usage-bar" class="bg-gradient-to-r from-violet-500 to-fuchsia-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
            
            <!-- Upgrade Options (for FREE users - shows Pro + Business) -->
            <div id="settings-upgrade-options">
              <p class="text-gray-400 text-sm mb-3">Upgrade your plan:</p>
              <div class="flex flex-wrap gap-3 mb-4">
                <button id="upgrade-pro-btn" onclick="upgradeToplan('pro')" class="px-5 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 rounded-lg text-white font-semibold transition-all flex items-center gap-2 shadow-lg">
                  <span>Pro - $49/mo</span>
                  <span class="text-xs opacity-75">(30 posts)</span>
                </button>
                <button id="upgrade-business-btn" onclick="upgradeToplan('business')" class="px-5 py-3 bg-gradient-to-r from-violet-500 to-fuchsia-500 hover:from-violet-600 hover:to-fuchsia-600 rounded-lg text-white font-semibold transition-all flex items-center gap-2 shadow-lg">
                  <span>Business - $199/mo</span>
                  <span class="text-xs opacity-75">(200 posts)</span>
                </button>
              </div>
            </div>
            
            <!-- Premium Active State (for PRO/BUSINESS users) -->
            <div id="settings-premium-active" class="hidden">
              <div class="flex items-center gap-3 p-4 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 rounded-lg border border-cyan-500/20 mb-4">
                <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <p class="text-white font-semibold">Premium subscription active</p>
                  <p class="text-gray-400 text-sm">Thank you for your support!</p>
                </div>
              </div>
              
              <!-- Upgrade to Business (for PRO users only) -->
              <div id="settings-upgrade-to-business" class="mb-4">
                <p class="text-gray-400 text-sm mb-2">Want more posts?</p>
                <button onclick="upgradeToplan('business')" class="px-5 py-3 bg-gradient-to-r from-violet-500 to-fuchsia-500 hover:from-violet-600 hover:to-fuchsia-600 rounded-lg text-white font-semibold transition-all flex items-center gap-2 shadow-lg">
                  <span>Upgrade to Business - $199/mo</span>
                  <span class="text-xs opacity-75">(200 posts)</span>
                </button>
              </div>
              
              <!-- Manage Subscription (for all paid users) -->
              <div id="settings-manage-subscription" class="flex gap-3">
                <a href="https://billing.stripe.com/p/login/test" target="_blank" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white text-sm font-medium transition-colors flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Manage Subscription
                </a>
                <button onclick="cancelSubscription()" class="px-4 py-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg text-sm font-medium transition-colors">
                  Cancel Subscription
                </button>
              </div>
            </div>
            
            <!-- Sync Button for Local Testing -->
            <div class="mt-4 pt-4 border-t border-white/10">
              <button onclick="syncSubscription()" id="sync-subscription-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white text-sm font-medium transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Sync from Stripe
              </button>
              <p class="text-gray-500 text-xs mt-1">Click to sync subscription status after payment</p>
            </div>
          </div>

          <!-- LinkedIn Connection (Admin-only feature) -->
          <div id="linkedin-settings-section" class="glass-card rounded-xl p-6 mb-6 max-w-2xl hidden" data-testid="linkedin-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              LinkedIn Connection
            </h2>
            
            <div id="linkedin-status-display" class="mb-4">
              <div class="flex items-center gap-3 mb-2">
                <div id="linkedin-connection-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="linkedin-connection-text" class="text-gray-300">Not Connected</span>
              </div>
            </div>
            
            <p class="text-gray-400 text-sm mb-4">
              Connect your LinkedIn account to enable direct posting from the dashboard.
            </p>
            
            <button onclick="connectLinkedIn()" id="linkedin-connect-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold transition-colors flex items-center gap-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              Connect LinkedIn Account
            </button>
            
            <div id="linkedin-connect-status" class="mt-3 text-sm hidden"></div>
          </div>
          
          <!-- Admin Status (only for admins) -->
          <div id="admin-settings-section" class="glass-card rounded-xl p-6 max-w-2xl hidden" data-testid="admin-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              ğŸ­ Admin Persona Status
            </h2>
            
            <!-- Loading State -->
            <div id="admin-persona-loading" class="flex items-center gap-3">
              <div class="w-4 h-4 border-2 border-violet-500 border-t-transparent rounded-full animate-spin"></div>
              <span class="text-gray-400">Loading persona status...</span>
            </div>
            
            <!-- Persona Status Content (hidden until loaded) -->
            <div id="admin-persona-content" class="hidden">
              <!-- Status Indicator -->
              <div class="flex items-center gap-3 mb-4">
                <div id="persona-status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
                <span id="persona-status-text" class="text-gray-400">Checking...</span>
              </div>
              
              <!-- Persona Details Card -->
              <div id="persona-details-card" class="bg-white/5 rounded-lg p-4 mb-4 hidden">
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-500">Persona ID:</span>
                    <p id="persona-id-value" class="text-white font-mono">-</p>
                  </div>
                  <div>
                    <span class="text-gray-500">Version:</span>
                    <p id="persona-version-value" class="text-white">-</p>
                  </div>
                  <div>
                    <span class="text-gray-500">Display Name:</span>
                    <p id="persona-display-name" class="text-white font-semibold">-</p>
                  </div>
                  <div>
                    <span class="text-gray-500">Role:</span>
                    <p id="persona-role-value" class="text-violet-400">-</p>
                  </div>
                </div>
                
                <!-- Identity Summary -->
                <div class="mt-4 pt-4 border-t border-white/10">
                  <span class="text-gray-500 text-sm">Identity:</span>
                  <p id="persona-identity-name" class="text-white font-semibold mt-1">-</p>
                  <p id="persona-identity-title" class="text-gray-400 text-sm">-</p>
                </div>
                
                <!-- Admin Emails -->
                <div class="mt-4 pt-4 border-t border-white/10">
                  <span class="text-gray-500 text-sm">Authorized Admin Emails:</span>
                  <div id="admin-emails-list" class="mt-2 flex flex-wrap gap-2">
                    <!-- Populated by JS -->
                  </div>
                </div>
                
                <!-- Hashtags -->
                <div class="mt-4 pt-4 border-t border-white/10">
                  <span class="text-gray-500 text-sm">Default Hashtags:</span>
                  <div id="persona-hashtags" class="mt-2 flex flex-wrap gap-2">
                    <!-- Populated by JS -->
                  </div>
                </div>
              </div>
              
              <!-- Error State -->
              <div id="persona-error-card" class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 hidden">
                <p class="text-red-400 text-sm">
                  <span class="font-semibold">âš ï¸ Persona Error:</span>
                  <span id="persona-error-message">-</span>
                </p>
              </div>
              
              <!-- Refresh Button -->
              <button onclick="fetchAdminPersonaStatus()" class="mt-4 px-4 py-2 bg-violet-600/20 hover:bg-violet-600/30 border border-violet-500/50 rounded-lg text-violet-400 text-sm transition-colors flex items-center gap-2">
                ğŸ”„ Refresh Status
              </button>
            </div>
            
            <!-- Admin Access Note -->
            <p class="text-gray-400 text-sm mt-4">
              You have access to direct LinkedIn publishing, scheduling, and drafts.
            </p>
          </div>
          
          <!-- Regular User Settings (visible when not admin) -->
          <div id="regular-settings-section" class="glass-card rounded-xl p-6 max-w-2xl hidden" data-testid="regular-settings-section">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-3">
              ğŸ‘¤ User Preferences
            </h2>
            <p class="text-gray-400 text-sm">
              Basic account settings. LinkedIn publishing features require admin access.
            </p>
            <div class="mt-4 text-gray-500 text-sm">
              <p>â€¢ Default writing style: Professional</p>
              <p class="mt-1">â€¢ Content saved to your account</p>
            </div>
          </div>
        </div>

      </div>
    </main>

    </footer>
  </div>

  <!-- Schedule Post Modal -->
  <div id="schedule-modal" role="dialog" aria-modal="true" aria-labelledby="schedule-modal-title" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center" data-testid="schedule-modal">
    <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 id="schedule-modal-title" class="text-2xl font-bold text-white mb-6">ğŸ“… Schedule Post</h3>
      
      <div class="space-y-4">
        <div>
          <label for="schedule-date" class="block text-sm text-gray-400 mb-2">Date</label>
          <input type="date" id="schedule-date" class="w-full" aria-required="true">
        </div>
        <div>
          <label for="schedule-time" class="block text-sm text-gray-400 mb-2">Time</label>
          <input type="time" id="schedule-time" class="w-full" aria-required="true">
        </div>
        <div>
          <label for="schedule-timezone" class="block text-sm text-gray-400 mb-2">Timezone</label>
          <select id="schedule-timezone" class="w-full">
            <option value="America/New_York">Eastern Time (ET)</option>
            <option value="America/Chicago">Central Time (CT)</option>
            <option value="America/Denver">Mountain Time (MT)</option>
            <option value="America/Los_Angeles">Pacific Time (PT)</option>
            <option value="UTC">UTC</option>
            <option value="Asia/Kolkata">India (IST)</option>
          </select>
        </div>
        
        <div id="schedule-preview" class="mt-4 p-3 bg-white/5 rounded-lg text-sm text-gray-300 hidden" role="status" aria-live="polite">
          Scheduled for: <span id="schedule-preview-text" class="text-white font-semibold"></span>
        </div>
        
        <div id="schedule-error" class="mt-2 text-red-400 text-sm hidden" role="alert"></div>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button id="schedule-modal-close" onclick="hideScheduleModal()" class="flex-1 py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition-colors" aria-label="Close schedule dialog">
          Cancel
        </button>
        <button onclick="confirmSchedule()" class="flex-1 py-2 px-4 gradient-button rounded-lg text-white font-semibold">
          Schedule
        </button>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RUNTIME CONFIGURATION
    // These values can be injected at build/deploy time via window.__RUNTIME_CONFIG__
    // or replaced during CI/CD build step
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const RUNTIME_CONFIG = window.__RUNTIME_CONFIG__ || {};
    
    // Production detection
    const IS_PRODUCTION = RUNTIME_CONFIG.IS_PRODUCTION || 
                          (window.location.hostname !== 'localhost' && 
                           window.location.hostname !== '127.0.0.1');
    
    // DEBUG MODE: OFF by default. Can only be enabled via browser console: window.__DEBUG__ = true; location.reload();
    // This requires dev tools access, so regular users won't see debug logs
    const DEBUG_MODE = window.__DEBUG__ === true;
    
    // Logger: Silent by default (except errors), verbose only when debug enabled via console
    const logger = {
      log: DEBUG_MODE ? console.log.bind(console) : () => {},
      warn: DEBUG_MODE ? console.warn.bind(console) : () => {},
      error: console.error.bind(console),  // Always show errors
      info: DEBUG_MODE ? console.info.bind(console) : () => {}
    };
    
    // Show clean welcome message
    if (!DEBUG_MODE) {
      console.info('%cğŸš€ GNX CIS v2.0', 'color: #8b5cf6; font-weight: bold; font-size: 14px');
    } else {
      console.info('%cğŸ”§ GNX CIS DEBUG MODE', 'color: #fbbf24; font-weight: bold');
    }
    
    // API Configuration - defaults to localhost for dev, custom domain for production
    // Using custom domain prevents ad blockers from blocking API requests
    const API_BASE = RUNTIME_CONFIG.API_BASE || 
                     (window.location.hostname === 'localhost' ? 'http://localhost:8000' : 
                      'https://api.cis.gnxautomation.com');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLERK AUTHENTICATION - PRODUCTION AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let clerkInstance = null;
    // Priority: 1) RUNTIME_CONFIG, 2) Pre-set window key, 3) Production fallback
    const CLERK_PUBLISHABLE_KEY = RUNTIME_CONFIG.CLERK_PUBLISHABLE_KEY || 
      window.__clerk_publishable_key ||
      'pk_live_Y2xlcmsuY2lzLmdueGF1dG9tYXRpb24uY29tJA';
    
    async function initializeClerk() {
      try {
        // Wait for Clerk script to load
        let attempts = 0;
        while (!window.Clerk && attempts < 50) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }
        
        if (window.Clerk) {
          await window.Clerk.load({
            publishableKey: CLERK_PUBLISHABLE_KEY
          });
          clerkInstance = window.Clerk;
          logger.log('[Auth] Clerk initialized successfully');
          
          // Check if user is already signed in from previous session
          // Skip auto-login on localhost for development testing
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          
          if (clerkInstance.user && !isLocalhost) {
            currentUser = {
              email: clerkInstance.user.emailAddresses[0]?.emailAddress,
              name: clerkInstance.user.firstName || clerkInstance.user.emailAddresses[0]?.emailAddress.split('@')[0],
              clerk_id: clerkInstance.user.id,
              image_url: clerkInstance.user.imageUrl
            };
            logger.log('[Auth] User already signed in (production auto-login):', currentUser.email);
            showDashboard();
          } else if (isLocalhost && clerkInstance.user) {
            // On localhost, show "Continue to Dashboard" option instead of auto-login
            logger.log('[Auth] Localhost - showing continue option for:', clerkInstance.user.emailAddresses[0]?.emailAddress);
            document.getElementById('already-signed-in')?.classList.remove('hidden');
          }
        } else {
          logger.error('[Auth] Clerk failed to load after timeout');
        }
      } catch (err) {
        logger.error('[Auth] Clerk initialization error:', err);
      }
    }
    
    // Continue to dashboard for existing session (localhost)
    function continueToExistingSession() {
      if (clerkInstance && clerkInstance.user) {
        currentUser = {
          email: clerkInstance.user.emailAddresses[0]?.emailAddress,
          name: clerkInstance.user.firstName || clerkInstance.user.emailAddresses[0]?.emailAddress.split('@')[0],
          clerk_id: clerkInstance.user.id,
          image_url: clerkInstance.user.imageUrl
        };
        logger.log('[Auth] Continuing with existing session:', currentUser.email);
        showDashboard();
      }
    }
    
    // State
    let currentUser = null;
    let posts = [];
    let currentPost = null;
    let selectedPostIndex = null;
    let improvingPost = null;  // Track post being improved (for hybrid history pattern)
    
    // Admin Persona Configuration
    // NOTE: Admin status is determined by server response (user.role = 'admin')
    // DO NOT hardcode admin emails in client-side code
    const ADMIN_PERSONA_ID = 'persona_admin_kunal';
    
    // Check if we're in development mode (localhost)
    const IS_DEV_MODE = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
    
    function isAdminUser() {
      // E2E test hook - ONLY available in development mode
      if (IS_DEV_MODE) {
        const testRole = localStorage.getItem('gnx_test_role');
        if (testRole) return testRole === 'admin';
      }
      
      // Primary: explicit role on user object (from server)
      if (currentUser && currentUser.role) {
        return currentUser.role.toLowerCase() === 'admin';
      }
      
      // Fallback for legacy users without role: check server-verified email
      // This should match ADMIN_EMAILS on the server, but ultimate authority is server
      if (currentUser && currentUser.email) {
        // Only the exact admin email, and only as fallback
        return currentUser.email.toLowerCase() === 'kunalsbhatt@gmail.com';
      }
      
      return false;
    }
    
    function updatePersonaUI() {
      const adminSection = document.getElementById('admin-persona-section');
      const regularSection = document.getElementById('regular-persona-section');
      const personaToggle = document.getElementById('persona-toggle');
      
      // Debug logging for E2E troubleshooting
      logger.log('[PersonaUI] updatePersonaUI called');
      logger.log('[PersonaUI] currentUser:', currentUser);
      logger.log('[PersonaUI] isAdminUser():', isAdminUser());
      logger.log('[PersonaUI] adminSection found:', !!adminSection);
      
      if (isAdminUser()) {
        logger.log('[PersonaUI] Setting admin mode');
        if (adminSection) {
          // Force visibility with multiple methods to override CSS
          adminSection.style.display = 'block';
          adminSection.classList.remove('hidden');
          adminSection.hidden = false;
        }
        if (regularSection) {
          regularSection.style.display = 'none';
          regularSection.classList.add('hidden');
          regularSection.hidden = true;
        }
        // Sync toggle state
        if (personaToggle) {
          personaToggle.checked = true;
          personaToggle.setAttribute('aria-checked', 'true');
        }
      } else {
        logger.log('[PersonaUI] Setting user mode');
        if (adminSection) {
          adminSection.style.display = 'none';
          adminSection.classList.add('hidden');
          adminSection.hidden = true;
        }
        if (regularSection) {
          regularSection.style.display = 'block';
          regularSection.classList.remove('hidden');
          regularSection.hidden = false;
        }
      }
    }
    
    function getActivePersonaId() {
      if (!isAdminUser()) return null;
      const toggle = document.getElementById('persona-toggle');
      return toggle?.checked ? ADMIN_PERSONA_ID : null;
    }
    
    // Handle admin persona toggle change
    function handlePersonaToggle(checkbox) {
      const personaDetails = document.getElementById('persona-details');
      const manualPersonaSection = document.getElementById('admin-manual-persona-section');
      const toggleLabel = document.getElementById('persona-toggle-label');
      
      if (checkbox.checked) {
        // Toggle ON: Using saved admin persona
        if (personaDetails) personaDetails.classList.remove('hidden');
        if (manualPersonaSection) manualPersonaSection.classList.add('hidden');
        if (toggleLabel) {
          toggleLabel.innerHTML = `
            <span class="text-white font-medium">Kunal Persona</span>
            <p class="text-xs text-gray-400">Using your profile & audience insights</p>
          `;
        }
        checkbox.setAttribute('aria-checked', 'true');
        logger.log('[PersonaToggle] Admin persona ENABLED');
      } else {
        // Toggle OFF: Show manual persona input
        if (personaDetails) personaDetails.classList.add('hidden');
        if (manualPersonaSection) manualPersonaSection.classList.remove('hidden');
        if (toggleLabel) {
          toggleLabel.innerHTML = `
            <span class="text-gray-300 font-medium">Custom Mode</span>
            <p class="text-xs text-gray-500">Enter your own persona below</p>
          `;
        }
        checkbox.setAttribute('aria-checked', 'false');
        logger.log('[PersonaToggle] Admin persona DISABLED - using custom mode');
      }
    }
    // Robust visibility helpers for CSS override
    function ensureVisible(el) {
      if (!el) return;
      el.hidden = false;
      el.classList.remove('hidden');
      el.style.display = 'block';
      el.setAttribute('aria-hidden', 'false');
    }
    
    function ensureHidden(el) {
      if (!el) return;
      el.hidden = true;
      el.classList.add('hidden');
      el.style.display = 'none';
      el.setAttribute('aria-hidden', 'true');
    }
    
    // Update admin LinkedIn actions visibility (called after content generation)
    function updateAdminLinkedInUI() {
      logger.log('>>> [AdminUI] updateAdminLinkedInUI STARTING <<<');
      
      const adminActionsEl = document.getElementById('admin-linkedin-actions');
      const adminSettingsEl = document.getElementById('admin-settings-section');
      const linkedinSettingsEl = document.getElementById('linkedin-settings-section');
      const regularSettingsEl = document.getElementById('regular-settings-section');
      const learningProgressEl = document.getElementById('learning-progress-card');
      
      logger.log('[AdminUI] isAdminUser():', isAdminUser());
      logger.log('[AdminUI] Elements found:', {
        adminActions: !!adminActionsEl,
        adminSettings: !!adminSettingsEl,
        linkedinSettings: !!linkedinSettingsEl,
        regularSettings: !!regularSettingsEl,
        learningProgress: !!learningProgressEl
      });
      
      if (isAdminUser()) {
        logger.log('[AdminUI] ADMIN MODE - Showing admin sections');
        if (adminActionsEl) { ensureVisible(adminActionsEl); logger.log('[AdminUI] adminActions visible'); }
        if (adminSettingsEl) { ensureVisible(adminSettingsEl); logger.log('[AdminUI] adminSettings visible'); }
        if (linkedinSettingsEl) { ensureVisible(linkedinSettingsEl); logger.log('[AdminUI] linkedinSettings visible'); }
        if (regularSettingsEl) { ensureHidden(regularSettingsEl); logger.log('[AdminUI] regularSettings hidden'); }
        // Hide learning progress for admin (they have unlimited access)
        if (learningProgressEl) { ensureHidden(learningProgressEl); logger.log('[AdminUI] learningProgress hidden for admin'); }
        
        // Update subscription display to show Admin tier
        updateAdminSubscriptionDisplay();
        
        // Enable image generation toggle for admin
        updateImageToggleForTier('admin');
        
        // Fetch admin persona status for settings page
        fetchAdminPersonaStatus();
        
        // Check LinkedIn connection status
        checkLinkedInStatus();
      } else {
        logger.log('[AdminUI] USER MODE - Showing regular section');
        if (adminActionsEl) { ensureHidden(adminActionsEl); }
        if (adminSettingsEl) { ensureHidden(adminSettingsEl); }
        if (linkedinSettingsEl) { ensureHidden(linkedinSettingsEl); }
        if (regularSettingsEl) { ensureVisible(regularSettingsEl); logger.log('[AdminUI] regularSettings visible'); }
        // Show learning progress for regular users
        if (learningProgressEl) { ensureVisible(learningProgressEl); }
      }
      
      logger.log('>>> [AdminUI] updateAdminLinkedInUI DONE <<<');
    }
    
    // Update subscription UI specifically for admin users
    function updateAdminSubscriptionDisplay() {
      // Update header badge
      const planBadgeEl = document.getElementById('current-plan-badge');
      if (planBadgeEl) {
        planBadgeEl.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gradient-to-r from-purple-500/30 to-pink-500/30 text-purple-300 border border-purple-500/50';
        planBadgeEl.textContent = 'Admin';
      }
      
      // Update settings page subscription section
      const settingsBadge = document.getElementById('settings-plan-badge');
      if (settingsBadge) {
        settingsBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-purple-500/20 text-purple-400 border border-purple-500/50';
        settingsBadge.textContent = 'ADMIN';
      }
      
      const settingsDesc = document.getElementById('settings-plan-description');
      if (settingsDesc) {
        settingsDesc.textContent = 'Unlimited posts, full feature access, admin privileges';
      }
      
      // Update usage display to show unlimited
      const usedEl = document.getElementById('settings-posts-used');
      const limitEl = document.getElementById('settings-posts-limit');
      if (limitEl) limitEl.textContent = 'âˆ';
      
      // Update progress bar to full purple gradient
      const progressBar = document.getElementById('settings-usage-bar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('from-red-500', 'to-orange-500', 'from-violet-500', 'to-fuchsia-500');
        progressBar.classList.add('from-purple-500', 'to-pink-500');
      }
      
      // Hide upgrade options for admin
      const upgradeOptions = document.getElementById('settings-upgrade-options');
      const premiumActive = document.getElementById('settings-premium-active');
      const upgradeToBusinessDiv = document.getElementById('settings-upgrade-to-business');
      
      if (upgradeOptions) upgradeOptions.classList.add('hidden');
      if (premiumActive) premiumActive.classList.remove('hidden');
      if (upgradeToBusinessDiv) upgradeToBusinessDiv.classList.add('hidden');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMIN PERSONA STATUS CHECK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function fetchAdminPersonaStatus() {
      if (!isAdminUser()) {
        logger.log('[PersonaStatus] Not admin, skipping persona status fetch');
        return;
      }
      
      const loadingEl = document.getElementById('admin-persona-loading');
      const contentEl = document.getElementById('admin-persona-content');
      const detailsCard = document.getElementById('persona-details-card');
      const errorCard = document.getElementById('persona-error-card');
      const statusIndicator = document.getElementById('persona-status-indicator');
      const statusText = document.getElementById('persona-status-text');
      
      // Show loading
      if (loadingEl) loadingEl.classList.remove('hidden');
      if (contentEl) contentEl.classList.add('hidden');
      
      try {
        // Pass user email as query param (no JWT needed, matches /api/generate pattern)
        const email = currentUser?.email || '';
        const response = await fetch(`${API_BASE}/api/admin/persona-status?user_email=${encodeURIComponent(email)}`, {
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }
        
        const data = await response.json();
        logger.log('[PersonaStatus] Received:', data);
        
        // Hide loading, show content
        if (loadingEl) loadingEl.classList.add('hidden');
        if (contentEl) contentEl.classList.remove('hidden');
        
        if (data.persona_exists) {
          // SUCCESS: Persona found
          if (statusIndicator) {
            statusIndicator.classList.remove('bg-gray-500', 'bg-red-500');
            statusIndicator.classList.add('bg-green-500');
          }
          if (statusText) {
            statusText.textContent = 'âœ… Persona Active';
            statusText.classList.remove('text-gray-400', 'text-red-400');
            statusText.classList.add('text-green-400');
          }
          
          // Show details card
          if (detailsCard) {
            detailsCard.classList.remove('hidden');
          }
          if (errorCard) {
            errorCard.classList.add('hidden');
          }
          
          // Populate values
          const setElementText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value || '-';
          };
          
          setElementText('persona-id-value', data.persona_id);
          setElementText('persona-version-value', data.version);
          setElementText('persona-display-name', data.display_name);
          setElementText('persona-role-value', data.role);
          
          // Identity
          if (data.identity) {
            setElementText('persona-identity-name', data.identity.name);
            setElementText('persona-identity-title', data.identity.title);
          }
          
          // Admin emails as badges
          const emailsContainer = document.getElementById('admin-emails-list');
          if (emailsContainer && data.admin_emails) {
            emailsContainer.innerHTML = data.admin_emails.map(email => 
              `<span class="px-2 py-1 rounded-md text-xs ${email.toLowerCase() === data.current_user_email?.toLowerCase() ? 'bg-green-500/20 text-green-400 border border-green-500/50' : 'bg-violet-500/20 text-violet-400'}">${email}</span>`
            ).join('');
          }
          
          // Hashtags as badges
          const hashtagsContainer = document.getElementById('persona-hashtags');
          if (hashtagsContainer && data.hashtags) {
            hashtagsContainer.innerHTML = data.hashtags.map(tag => 
              `<span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded-md text-xs">${tag}</span>`
            ).join('');
          }
          
        } else {
          // ERROR: Persona not found
          if (statusIndicator) {
            statusIndicator.classList.remove('bg-gray-500', 'bg-green-500');
            statusIndicator.classList.add('bg-red-500');
          }
          if (statusText) {
            statusText.textContent = 'âŒ Persona Not Found';
            statusText.classList.remove('text-gray-400', 'text-green-400');
            statusText.classList.add('text-red-400');
          }
          
          // Show error card
          if (detailsCard) {
            detailsCard.classList.add('hidden');
          }
          if (errorCard) {
            errorCard.classList.remove('hidden');
            const errorMsg = document.getElementById('persona-error-message');
            if (errorMsg) {
              errorMsg.textContent = data.error || 'Persona file not found or invalid';
            }
          }
        }
        
      } catch (error) {
        logger.error('[PersonaStatus] Fetch error:', error);
        
        // Hide loading, show content with error
        if (loadingEl) loadingEl.classList.add('hidden');
        if (contentEl) contentEl.classList.remove('hidden');
        
        if (statusIndicator) {
          statusIndicator.classList.remove('bg-gray-500', 'bg-green-500');
          statusIndicator.classList.add('bg-red-500');
        }
        if (statusText) {
          statusText.textContent = 'âš ï¸ Error Checking Status';
          statusText.classList.remove('text-gray-400', 'text-green-400');
          statusText.classList.add('text-red-400');
        }
        
        if (detailsCard) {
          detailsCard.classList.add('hidden');
        }
        if (errorCard) {
          errorCard.classList.remove('hidden');
          const errorMsg = document.getElementById('persona-error-message');
          if (errorMsg) {
            errorMsg.textContent = error.message || 'Failed to fetch persona status';
          }
        }
      }
    }

    // Image placeholders for posts (using Unsplash API for beautiful images)
    const postImages = [
      'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1504868584819-f8e8b4b6d7e3?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1518770660439-4636190af475?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?w=400&h=300&fit=crop',
      'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=400&h=300&fit=crop'
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEXTAREA AUTO-RESIZE & WORD COUNTER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const WORD_LIMIT = 2000;
    
    function autoResizeTextarea(textarea) {
      // Reset height to auto to get proper scrollHeight
      textarea.style.height = 'auto';
      
      // Set new height based on scrollHeight, respecting min/max from CSS
      const newHeight = Math.min(Math.max(textarea.scrollHeight, 100), 400);
      textarea.style.height = newHeight + 'px';
    }
    
    function updateWordCount(textarea) {
      const text = textarea.value.trim();
      const wordCount = text ? text.split(/\s+/).length : 0;
      
      const counterEl = document.getElementById('word-counter');
      if (counterEl) {
        counterEl.textContent = `${wordCount} / ${WORD_LIMIT} words`;
        
        // Update styling based on count
        counterEl.classList.remove('warning', 'limit');
        if (wordCount >= WORD_LIMIT) {
          counterEl.classList.add('limit');
        } else if (wordCount >= WORD_LIMIT * 0.8) {
          counterEl.classList.add('warning');
        }
      }
      
      // Optional: Prevent exceeding limit (soft limit - just warn)
      // To enforce hard limit, uncomment below:
      // if (wordCount > WORD_LIMIT) {
      //   const words = text.split(/\s+/).slice(0, WORD_LIMIT);
      //   textarea.value = words.join(' ');
      // }
    }
    
    // Initialize textarea on page load
    function initTextarea() {
      const textarea = document.getElementById('topic-input');
      if (textarea) {
        autoResizeTextarea(textarea);
        updateWordCount(textarea);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUPABASE CLIENT & PERSISTENCE
    // Anon key is safe for client-side use (RLS policies protect data)
    // Configure via window.__RUNTIME_CONFIG__ for different environments
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SUPABASE_URL = RUNTIME_CONFIG.SUPABASE_URL || 'https://ijwmgwirhorksepabgpj.supabase.co';
    const SUPABASE_ANON_KEY = RUNTIME_CONFIG.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlqd21nd2lyaG9ya3NlcGFiZ3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTAwMjksImV4cCI6MjA3NjM4NjAyOX0.edZFY_LyMzNhKbYSdA95lvu7hRuWu3Dqf03oy4bJnYc';
    
    // Note: Using supabaseClient to avoid conflict with window.supabase from the library
    let supabaseClient = null;
    let supabaseEnabled = false;

    // Initialize Supabase client
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      supabaseEnabled = true;
      logger.log('[OK] Supabase connected');
    } catch (error) {
      logger.warn('[WARN] Supabase not available:', error);
      supabaseEnabled = false;
    }

    // Save post to Supabase
    async function savePostToSupabase(post) {
      if (!supabaseEnabled || !currentUser) return null;
      
      try {
        // Get or create user in database
        const userEmail = currentUser.email;
        
        // Check if user exists
        let { data: existingUser } = await supabaseClient
          .from('users')
          .select('id')
          .eq('email', userEmail)
          .single();
        
        let userId;
        if (!existingUser) {
          // Create new user
          const { data: newUser, error: createError } = await supabaseClient
            .from('users')
            .insert({
              email: userEmail,
              full_name: currentUser.name,
              clerk_id: `dashboard_${Date.now()}` // Temporary clerk_id for dashboard users
            })
            .select()
            .single();
          
          if (createError) throw createError;
          userId = newUser.id;
        } else {
          userId = existingUser.id;
        }

        // Save post
        const { data, error } = await supabaseClient
          .from('posts')
          .insert({
            user_id: userId,
            content: post.content,
            topic: post.topic,
            virality_score: post.virality_score,
            suggestions: post.suggestions || [],
            image_url: post.imageUrl,
            style: post.style,
            persona: post.persona,
            status: 'draft',
            generated_at: new Date().toISOString()
          })
          .select()
          .single();

        if (error) throw error;
        
        logger.log('[OK] Post saved to Supabase:', data.id);
        return data;
      } catch (error) {
        logger.error('[X] Failed to save post to Supabase:', error);
        return null;
      }
    }

    // Load all posts for current user from Supabase
    async function loadPostsFromSupabase() {
      if (!supabaseEnabled || !currentUser) return [];
      
      try {
        // Get user
        const { data: user } = await supabaseClient
          .from('users')
          .select('id')
          .eq('email', currentUser.email)
          .single();
        
        if (!user) return [];

        // Load posts
        const { data: loadedPosts, error } = await supabaseClient
          .from('posts')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Transform to dashboard format
        const transformedPosts = loadedPosts.map(p => {
          // Fix image URL: prepend API_BASE if it's a relative path
          // Also fix old URLs that have wrong port (8080 instead of 8000)
          let imageUrl = p.image_url;
          if (imageUrl) {
            if (imageUrl.startsWith('/')) {
              imageUrl = API_BASE + imageUrl;
            } else if (imageUrl.includes('localhost:8080')) {
              // Fix old URLs with wrong port
              imageUrl = imageUrl.replace('localhost:8080', 'localhost:8000');
            }
          }
          
          return {
            id: p.id,  // Required for improve flow
            content: p.content,
            topic: p.topic,
            virality_score: p.virality_score || 0,
            suggestions: p.suggestions || [],
            imageUrl: imageUrl,
            style: p.style,
            persona: p.persona,
            timestamp: p.generated_at || p.created_at,
            // Hybrid history pattern fields
            version: p.version || 1,
            improvement_count: p.improvement_count || 0,
            previous_score: p.previous_score
          };
        });

        // Debug: Show raw scores from Supabase
        logger.log('[DATA] [Supabase] Raw scores from DB:', loadedPosts.map(p => p.virality_score));
        logger.log(`[OK] Loaded ${transformedPosts.length} posts from Supabase`);
        return transformedPosts;
      } catch (error) {
        logger.error('[X] Failed to load posts from Supabase:', error);
        return [];
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH - REAL CLERK AUTHENTICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value?.trim() || '';
      const password = document.getElementById('login-password').value || '';
      
      // Clear previous errors
      document.getElementById('login-error').classList.add('hidden');
      
      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('login-error').textContent = 'Please enter a valid email address.';
        document.getElementById('login-error').classList.remove('hidden');
        return;
      }
      
      // Validate password is provided
      if (!password || password.length < 1) {
        document.getElementById('login-error').textContent = 'Please enter your password.';
        document.getElementById('login-error').classList.remove('hidden');
        return;
      }
      
      // Show loading
      document.getElementById('login-btn').disabled = true;
      document.getElementById('login-btn-text').textContent = 'Signing In...';
      document.getElementById('login-spinner').classList.remove('hidden');
      
      try {
        if (!clerkInstance) {
          throw new Error('Authentication system loading. Please wait a moment and try again.');
        }
        
        // Real Clerk sign in
        const signInAttempt = await clerkInstance.client.signIn.create({
          identifier: email,
          password: password,
        });
        
        if (signInAttempt.status === 'complete') {
          // Set the active session
          await clerkInstance.setActive({ session: signInAttempt.createdSessionId });
          
          // Get user data
          const user = clerkInstance.user;
          currentUser = {
            email: user.emailAddresses[0]?.emailAddress || email,
            name: user.firstName || email.split('@')[0],
            clerk_id: user.id,
            image_url: user.imageUrl
          };
          
          logger.log('[Auth] Login successful:', currentUser.email);
          showDashboard();
          await loadPostsFromSupabase();
          
        } else if (signInAttempt.status === 'needs_first_factor') {
          // User needs to verify email - check what factors are available
          const emailCodeFactor = signInAttempt.supportedFirstFactors?.find(
            factor => factor.strategy === 'email_code'
          );
          
          if (emailCodeFactor) {
            // Prepare for email verification
            await signInAttempt.prepareFirstFactor({
              strategy: 'email_code',
              emailAddressId: emailCodeFactor.emailAddressId,
            });
            
            // Store for verification
            window.pendingSignIn = signInAttempt;
            window.pendingSignInEmail = email;
            
            // Show verification form
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('verify-form').classList.remove('hidden');
            document.getElementById('reset-password-form').classList.add('hidden');
            document.getElementById('auth-toggle-container').classList.add('hidden');
            document.getElementById('verify-email-display').textContent = email;
            
            logger.log('[Auth] Email verification required for:', email);
          } else {
            throw new Error('Email verification required but not available. Please contact support.');
          }
          
        } else if (signInAttempt.status === 'needs_second_factor') {
          // 2FA required - not implemented yet
          throw new Error('Two-factor authentication required. Please use the Clerk login page.');
          
        } else {
          throw new Error(`Sign in incomplete (status: ${signInAttempt.status}). Please try again.`);
        }
        
      } catch (err) {
        logger.error('[Auth] Login error:', err);
        let errorMessage = 'Invalid email or password.';
        
        if (err.errors && err.errors.length > 0) {
          errorMessage = err.errors[0].longMessage || err.errors[0].message;
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        document.getElementById('login-error').textContent = errorMessage;
        document.getElementById('login-error').classList.remove('hidden');
      } finally {
        document.getElementById('login-btn').disabled = false;
        document.getElementById('login-btn-text').textContent = 'Sign In';
        document.getElementById('login-spinner').classList.add('hidden');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FORGOT PASSWORD - Clerk Password Reset
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Store the signIn object for the reset flow
    let pendingPasswordReset = null;
    
    async function forgotPassword(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value?.trim() || '';
      
      if (!email) {
        // Prompt user to enter email
        const promptedEmail = prompt('Enter your email address to receive a password reset code:');
        if (!promptedEmail || !promptedEmail.trim()) {
          alert('Please enter a valid email address.');
          return;
        }
        document.getElementById('login-email').value = promptedEmail.trim();
      }
      
      const resetEmail = document.getElementById('login-email').value?.trim();
      
      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(resetEmail)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      try {
        if (!clerkInstance) {
          alert('Authentication system is loading. Please try again in a moment.');
          return;
        }
        
        // Use Clerk's password reset flow - this sends the email
        pendingPasswordReset = await clerkInstance.client.signIn.create({
          strategy: 'reset_password_email_code',
          identifier: resetEmail,
        });
        
        // Show the password reset form
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('signup-form').classList.add('hidden');
        document.getElementById('verify-form').classList.add('hidden');
        document.getElementById('reset-password-form').classList.remove('hidden');
        document.getElementById('auth-toggle-container').classList.add('hidden');
        
        // Display the email
        document.getElementById('reset-email-display').textContent = resetEmail;
        
        logger.log('[Auth] Password reset code sent to:', resetEmail);
        
      } catch (err) {
        console.error('Password reset error:', err);
        
        // Handle specific error cases
        if (err.errors && err.errors.length > 0) {
          const errorMessage = err.errors[0].message || 'Failed to send reset email.';
          alert(errorMessage);
        } else {
          alert('Failed to send password reset email. Please try again or contact support.');
        }
      }
    }
    
    async function handleResetPassword(event) {
      event.preventDefault();
      
      const code = document.getElementById('reset-code').value?.trim() || '';
      const newPassword = document.getElementById('reset-new-password').value || '';
      const confirmPassword = document.getElementById('reset-confirm-password').value || '';
      
      // Clear previous messages
      document.getElementById('reset-error').classList.add('hidden');
      document.getElementById('reset-success').classList.add('hidden');
      
      // Validate code
      if (!code || code.length !== 6) {
        document.getElementById('reset-error').textContent = 'Please enter the 6-digit code from your email.';
        document.getElementById('reset-error').classList.remove('hidden');
        return;
      }
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        document.getElementById('reset-error').textContent = 'Passwords do not match.';
        document.getElementById('reset-error').classList.remove('hidden');
        return;
      }
      
      // Validate password length
      if (newPassword.length < 8) {
        document.getElementById('reset-error').textContent = 'Password must be at least 8 characters.';
        document.getElementById('reset-error').classList.remove('hidden');
        return;
      }
      
      // Show loading
      document.getElementById('reset-btn').disabled = true;
      document.getElementById('reset-btn-text').textContent = 'Resetting...';
      document.getElementById('reset-spinner').classList.remove('hidden');
      
      try {
        if (!pendingPasswordReset) {
          throw new Error('Password reset session expired. Please try again.');
        }
        
        // Attempt to reset the password with the code
        const result = await pendingPasswordReset.attemptFirstFactor({
          strategy: 'reset_password_email_code',
          code: code,
          password: newPassword,
        });
        
        if (result.status === 'complete') {
          // Password reset successful
          document.getElementById('reset-success').classList.remove('hidden');
          pendingPasswordReset = null;
          
          // After 2 seconds, go back to login
          setTimeout(() => {
            backToLogin();
          }, 2000);
          
        } else {
          throw new Error('Password reset incomplete. Please try again.');
        }
        
      } catch (err) {
        console.error('Password reset error:', err);
        
        let errorMessage = 'Failed to reset password.';
        if (err.errors && err.errors.length > 0) {
          errorMessage = err.errors[0].message || err.errors[0].longMessage || errorMessage;
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        document.getElementById('reset-error').textContent = errorMessage;
        document.getElementById('reset-error').classList.remove('hidden');
        
      } finally {
        document.getElementById('reset-btn').disabled = false;
        document.getElementById('reset-btn-text').textContent = 'Reset Password';
        document.getElementById('reset-spinner').classList.add('hidden');
      }
    }
    
    function backToLogin() {
      // Hide all auth forms except login
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('signup-form').classList.add('hidden');
      document.getElementById('verify-form').classList.add('hidden');
      document.getElementById('reset-password-form').classList.add('hidden');
      document.getElementById('auth-toggle-container').classList.remove('hidden');
      
      // Clear reset form
      document.getElementById('reset-code').value = '';
      document.getElementById('reset-new-password').value = '';
      document.getElementById('reset-confirm-password').value = '';
      document.getElementById('reset-error').classList.add('hidden');
      document.getElementById('reset-success').classList.add('hidden');
      
      pendingPasswordReset = null;
    }
    
    async function handleSignup(event) {
      event.preventDefault();
      const firstName = document.getElementById('signup-firstname')?.value?.trim() || '';
      const email = document.getElementById('signup-email').value?.trim() || '';
      const password = document.getElementById('signup-password').value || '';
      
      // Clear previous errors
      document.getElementById('signup-error').classList.add('hidden');
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CLIENT-SIDE VALIDATION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Validate first name
      if (!firstName || firstName.length < 2) {
        document.getElementById('signup-error').textContent = 'Please enter your first name (at least 2 characters).';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('signup-error').textContent = 'Please enter a valid email address (e.g., name@example.com).';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Block obviously fake/test emails
      const blockedDomains = ['test.com', 'fake.com', 'example.com', 'temp.com', 'mailinator.com'];
      const emailDomain = email.split('@')[1]?.toLowerCase();
      if (blockedDomains.includes(emailDomain)) {
        document.getElementById('signup-error').textContent = 'Please use a real email address, not a test/temporary email.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Validate password strength
      if (password.length < 8) {
        document.getElementById('signup-error').textContent = 'Password must be at least 8 characters long.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      if (!hasLetter || !hasNumber) {
        document.getElementById('signup-error').textContent = 'Password must contain both letters and numbers.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // Check for common weak passwords
      const weakPasswords = ['password', '12345678', 'password1', 'qwerty123', 'letmein1'];
      if (weakPasswords.includes(password.toLowerCase())) {
        document.getElementById('signup-error').textContent = 'This password is too common. Please choose a stronger password.';
        document.getElementById('signup-error').classList.remove('hidden');
        return;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // VALIDATION PASSED - PROCEED WITH SIGNUP
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Show loading
      document.getElementById('signup-btn').disabled = true;
      document.getElementById('signup-btn-text').textContent = 'Creating Account...';
      document.getElementById('signup-spinner').classList.remove('hidden');
      
      try {
        if (!clerkInstance) {
          throw new Error('Authentication system loading. Please wait a moment and try again.');
        }
        
        // Real Clerk sign up
        logger.log('[Auth] Attempting signup for:', email);
        const signUpAttempt = await clerkInstance.client.signUp.create({
          emailAddress: email,
          password: password,
          firstName: firstName
        });
        
        logger.log('[Auth] Signup response status:', signUpAttempt.status);
        logger.log('[Auth] Signup response:', signUpAttempt);
        
        if (signUpAttempt.status === 'complete') {
          // Auto sign in after signup
          await clerkInstance.setActive({ session: signUpAttempt.createdSessionId });
          
          const user = clerkInstance.user;
          currentUser = {
            email: user.emailAddresses[0]?.emailAddress || email,
            name: user.firstName || firstName || email.split('@')[0],
            clerk_id: user.id,
            image_url: user.imageUrl,
            isFirstTimeUser: true
          };
          
          logger.log('[Auth] Signup successful:', currentUser.email);
          showDashboard();
          
        } else if (signUpAttempt.status === 'missing_requirements') {
          // Need to send email verification
          logger.log('[Auth] Email verification required, preparing verification...');
          
          // Prepare and send verification email
          await signUpAttempt.prepareEmailAddressVerification({ strategy: 'email_code' });
          logger.log('[Auth] Verification email sent!');
          
          // Store the signup attempt for later verification
          window.pendingSignUp = signUpAttempt;
          window.pendingEmail = email;
          
          // Show verification form
          document.getElementById('signup-form').classList.add('hidden');
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('verify-form').classList.remove('hidden');
          document.getElementById('auth-toggle-container').classList.add('hidden');
          document.getElementById('verify-email-display').textContent = email;
          
          // Update title
          const authTitle = document.querySelector('#login-page h2');
          if (authTitle) authTitle.textContent = 'Verify Email';
          
          logger.log('[Auth] Verification form shown');
          
        } else {
          logger.log('[Auth] Unexpected signup status:', signUpAttempt.status);
          document.getElementById('signup-error').textContent = 
            'Signup incomplete. Status: ' + signUpAttempt.status;
          document.getElementById('signup-error').classList.remove('hidden');
        }
        
      } catch (err) {
        logger.error('[Auth] Signup error:', err);
        let errorMessage = 'Error creating account. Please try again.';
        
        if (err.errors && err.errors.length > 0) {
          const error = err.errors[0];
          if (error.code === 'form_identifier_exists') {
            errorMessage = 'An account with this email already exists. Please sign in.';
          } else {
            errorMessage = error.longMessage || error.message;
          }
        }
        
        document.getElementById('signup-error').textContent = errorMessage;
        document.getElementById('signup-error').classList.remove('hidden');
      } finally {
        document.getElementById('signup-btn').disabled = false;
        document.getElementById('signup-btn-text').textContent = 'Create Account';
        document.getElementById('signup-spinner').classList.add('hidden');
      }
    }
    
    // Handle OTP verification
    async function handleVerifyCode(event) {
      event.preventDefault();
      const code = document.getElementById('verify-code').value?.trim();
      
      if (!code || code.length !== 6) {
        document.getElementById('verify-error').textContent = 'Please enter the 6-digit code from your email.';
        document.getElementById('verify-error').classList.remove('hidden');
        return;
      }
      
      // Show loading
      document.getElementById('verify-btn').disabled = true;
      document.getElementById('verify-btn-text').textContent = 'Verifying...';
      document.getElementById('verify-spinner').classList.remove('hidden');
      document.getElementById('verify-error').classList.add('hidden');
      
      try {
        // Check if this is a SignIN verification (for existing users needing email verification)
        if (window.pendingSignIn) {
          logger.log('[Auth] Verifying sign-in code:', code);
          
          const result = await window.pendingSignIn.attemptFirstFactor({
            strategy: 'email_code',
            code: code,
          });
          
          logger.log('[Auth] Sign-in verification result:', result.status);
          
          if (result.status === 'complete') {
            // Set active session
            await clerkInstance.setActive({ session: result.createdSessionId });
            
            const user = clerkInstance.user;
            currentUser = {
              email: user.emailAddresses[0]?.emailAddress || window.pendingSignInEmail,
              name: user.firstName || window.pendingSignInEmail?.split('@')[0],
              clerk_id: user.id,
              image_url: user.imageUrl
            };
            
            logger.log('[Auth] Sign-in verified! User logged in:', currentUser.email);
            
            // Clear pending state
            window.pendingSignIn = null;
            window.pendingSignInEmail = null;
            
            // Show dashboard
            showDashboard();
            await loadPostsFromSupabase();
            
          } else {
            throw new Error('Verification incomplete. Please try again.');
          }
          
        } else if (window.pendingSignUp) {
          // SignUP verification (new users)
          logger.log('[Auth] Verifying signup code:', code);
          
          const completeSignUp = await window.pendingSignUp.attemptEmailAddressVerification({
            code: code
          });
          
          logger.log('[Auth] Verification result:', completeSignUp.status);
          
          if (completeSignUp.status === 'complete') {
            // Set active session
            await clerkInstance.setActive({ session: completeSignUp.createdSessionId });
            
            const user = clerkInstance.user;
            currentUser = {
              email: user.emailAddresses[0]?.emailAddress || window.pendingEmail,
              name: user.firstName || window.pendingEmail?.split('@')[0],
              clerk_id: user.id,
              image_url: user.imageUrl,
              isFirstTimeUser: true
            };
            
            logger.log('[Auth] Email verified! User signed in:', currentUser.email);
            
            // Clear pending state
            window.pendingSignUp = null;
            window.pendingEmail = null;
            
            // Show dashboard
            showDashboard();
            
          } else {
            throw new Error('Verification incomplete. Please try again.');
          }
          
        } else {
          throw new Error('No pending verification. Please start over.');
        }
        
      } catch (err) {
        logger.error('[Auth] Verification error:', err);
        let errorMessage = 'Invalid verification code. Please try again.';
        
        if (err.errors && err.errors.length > 0) {
          errorMessage = err.errors[0].longMessage || err.errors[0].message;
        } else if (err.message) {
          errorMessage = err.message;
        }
        
        document.getElementById('verify-error').textContent = errorMessage;
        document.getElementById('verify-error').classList.remove('hidden');
      } finally {
        document.getElementById('verify-btn').disabled = false;
        document.getElementById('verify-btn-text').textContent = 'Verify & Continue';
        document.getElementById('verify-spinner').classList.add('hidden');
      }
    }
    
    // Resend verification code
    async function resendVerificationCode() {
      try {
        if (window.pendingSignIn) {
          // Resend for sign-in verification
          const emailCodeFactor = window.pendingSignIn.supportedFirstFactors?.find(
            factor => factor.strategy === 'email_code'
          );
          if (emailCodeFactor) {
            await window.pendingSignIn.prepareFirstFactor({
              strategy: 'email_code',
              emailAddressId: emailCodeFactor.emailAddressId,
            });
            alert('New verification code sent! Check your email.');
          } else {
            alert('Unable to resend code. Please try logging in again.');
          }
        } else if (window.pendingSignUp) {
          // Resend for signup verification
          await window.pendingSignUp.prepareEmailAddressVerification({ strategy: 'email_code' });
          alert('New verification code sent! Check your email.');
        } else {
          alert('Session expired. Please start over.');
          backToLogin();
        }
      } catch (err) {
        logger.error('[Auth] Resend error:', err);
        alert('Failed to resend code. Please try again.');
      }
    }

    async function handleLogout() {
      try {
        if (clerkInstance) {
          await clerkInstance.signOut();
        }
      } catch (err) {
        logger.error('[Auth] Logout error:', err);
      }
      
      currentUser = null;
      posts = [];
      currentPost = null;
      document.getElementById('dashboard-page').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
      
      // Clear forms
      if (document.getElementById('login-email')) {
        document.getElementById('login-email').value = '';
        document.getElementById('login-password').value = '';
      }
    }
    
    function toggleAuthForm() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const authTitle = document.querySelector('#login-page h2');
      const authSubtitle = document.querySelector('#login-page .text-violet-300');
      const toggleBtn = document.getElementById('auth-toggle-btn');
      
      if (signupForm.classList.contains('hidden')) {
        // Show signup
        loginForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        if (authTitle) authTitle.textContent = 'Create Account';
        if (authSubtitle) authSubtitle.textContent = 'Join GNX to start generating content';
        if (toggleBtn) toggleBtn.innerHTML = 'Already have an account? <span class="font-semibold">Sign in</span>';
      } else {
        // Show login
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        if (authTitle) authTitle.textContent = 'Welcome Back';
        if (authSubtitle) authSubtitle.textContent = 'Sign in to access your dashboard';
        if (toggleBtn) toggleBtn.innerHTML = 'Don\'t have an account? <span class="font-semibold">Sign up</span>';
      }
      
      // Clear errors
      document.getElementById('login-error')?.classList.add('hidden');
      document.getElementById('signup-error')?.classList.add('hidden');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FORGOT PASSWORD / FIRST-TIME USER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showForgotPassword() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('forgot-password-form').classList.remove('hidden');
      document.getElementById('reset-success').classList.add('hidden');
      document.getElementById('reset-error').classList.add('hidden');
      
      // Pre-fill email if entered in login form
      const loginEmail = document.getElementById('login-email').value;
      if (loginEmail) {
        document.getElementById('reset-email').value = loginEmail;
      }
    }
    
    function hideForgotPassword() {
      document.getElementById('forgot-password-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
    }
    
    async function handleForgotPassword() {
      const email = document.getElementById('reset-email').value;
      
      if (!email) {
        document.getElementById('reset-error').textContent = 'âŒ Please enter your email address.';
        document.getElementById('reset-error').classList.remove('hidden');
        return;
      }
      
      // Generate temporary password (in production, send via email)
      const tempPassword = generateTempPassword();
      
      // Store in localStorage for demo (in prod, this would be server-side + email)
      const tempUsers = JSON.parse(localStorage.getItem('temp_passwords') || '{}');
      tempUsers[email.toLowerCase()] = {
        password: tempPassword,
        created: Date.now(),
        expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
      };
      localStorage.setItem('temp_passwords', JSON.stringify(tempUsers));
      
      // Show success message with temp password (in prod, this would be hidden and sent via email)
      document.getElementById('reset-success').innerHTML = `
        âœ… Temporary password created!<br>
        <span class="text-white font-mono mt-2 block bg-white/10 p-2 rounded">${tempPassword}</span>
        <span class="text-xs mt-1 block">Valid for 24 hours. In production, this would be sent to your email.</span>
      `;
      document.getElementById('reset-success').classList.remove('hidden');
      document.getElementById('reset-error').classList.add('hidden');
      
      logger.log(`[KEY] Temporary password for ${email}: ${tempPassword}`);
    }
    
    function generateTempPassword() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
      let password = '';
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return password;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADMIN LINKEDIN ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // NOTE: updateAdminLinkedInUI() defined earlier (around line 839) - handles both admin actions AND settings visibility
    
    function showLinkedInStatus(message, isError = false) {
      const statusEl = document.getElementById('linkedin-action-status');
      if (statusEl) {
        statusEl.textContent = message;
        statusEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
        statusEl.classList.add(isError ? 'text-red-400' : 'text-green-400');
        
        // Auto-hide after 5 seconds
        setTimeout(() => statusEl.classList.add('hidden'), 5000);
      }
    }
    
    async function publishToLinkedIn() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('[X] No post to publish. Generate a post first.', true);
        return;
      }
      
      if (!isAdminUser()) {
        showLinkedInStatus('[X] Admin access required.', true);
        return;
      }
      
      showLinkedInStatus('Publishing to LinkedIn...', false);
      
      try {
        // Try to publish via API (uses saved LinkedIn token)
        const response = await fetch(`${API_BASE}/api/linkedin/publish`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: currentPost.content,
            user_email: currentUser?.email || '',
            image_url: currentPost.imageUrl || currentPost.image_url || null
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showLinkedInStatus('[OK] Published to LinkedIn!', false);
          return;
        }
        
        // If API failed, show error and fall back to copy+paste
        logger.warn('LinkedIn API publish failed:', result.error);
        
        // Fallback: Copy to clipboard and open LinkedIn
        await navigator.clipboard.writeText(currentPost.content);
        showLinkedInStatus(`[WARN] ${result.error || 'API unavailable'}. Post copied - paste it on LinkedIn.`, false);
        
        setTimeout(() => {
          window.open('https://www.linkedin.com/feed/', '_blank');
        }, 1500);
        
      } catch (err) {
        logger.error('LinkedIn publish error:', err);
        
        // Fallback: Copy to clipboard
        try {
          await navigator.clipboard.writeText(currentPost.content);
          showLinkedInStatus('[WARN] Publishing failed. Post copied - paste it on LinkedIn.', false);
          setTimeout(() => {
            window.open('https://www.linkedin.com/feed/', '_blank');
          }, 1500);
        } catch (copyErr) {
          showLinkedInStatus('[X] Publishing failed. Please copy your post manually.', true);
        }
      }
    }
    
    async function saveAsDraft() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('[X] No post to save. Generate a post first.', true);
        return;
      }
      
      showLinkedInStatus('Saving as draft...');
      
      try {
        // Save to Supabase with draft status
        const saved = await savePostToSupabase({
          ...currentPost,
          status: 'draft',
          savedAt: new Date().toISOString()
        });
        
        if (saved) {
          showLinkedInStatus('[OK] Saved as draft!');
        } else {
          // Fallback to localStorage
          const drafts = JSON.parse(localStorage.getItem('post_drafts') || '[]');
          drafts.push({
            ...currentPost,
            id: `draft_${Date.now()}`,
            status: 'draft',
            savedAt: new Date().toISOString()
          });
          localStorage.setItem('post_drafts', JSON.stringify(drafts));
          showLinkedInStatus('[OK] Saved as local draft!');
        }
      } catch (error) {
        logger.error('Save draft error:', error);
        showLinkedInStatus('[X] Failed to save draft.', true);
      }
    }
    
    function showScheduleModal() {
      if (!currentPost || !currentPost.content) {
        showLinkedInStatus('[X] No post to schedule. Generate a post first.', true);
        return;
      }
      
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('schedule-date').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('schedule-time').value = '09:00';
      document.getElementById('schedule-error').classList.add('hidden');
      document.getElementById('schedule-preview').classList.add('hidden');
      
      document.getElementById('schedule-modal').classList.remove('hidden');
      
      // Add event listeners for preview
      document.getElementById('schedule-date').addEventListener('change', updateSchedulePreview);
      document.getElementById('schedule-time').addEventListener('change', updateSchedulePreview);
      updateSchedulePreview();
    }
    
    function hideScheduleModal() {
      document.getElementById('schedule-modal').classList.add('hidden');
    }
    
    function updateSchedulePreview() {
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const timezone = document.getElementById('schedule-timezone').value;
      
      if (date && time) {
        const dateObj = new Date(`${date}T${time}`);
        const formatted = dateObj.toLocaleString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        
        document.getElementById('schedule-preview-text').textContent = `${formatted} (${timezone})`;
        document.getElementById('schedule-preview').classList.remove('hidden');
      }
    }
    
    async function confirmSchedule() {
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const timezone = document.getElementById('schedule-timezone').value;
      
      if (!date || !time) {
        document.getElementById('schedule-error').textContent = 'Please select both date and time.';
        document.getElementById('schedule-error').classList.remove('hidden');
        return;
      }
      
      const scheduledAt = new Date(`${date}T${time}`);
      const now = new Date();
      
      if (scheduledAt <= now) {
        document.getElementById('schedule-error').textContent = 'Scheduled time must be in the future.';
        document.getElementById('schedule-error').classList.remove('hidden');
        return;
      }
      
      try {
        // Save to Supabase with scheduled status
        const postData = {
          ...currentPost,
          status: 'scheduled',
          scheduled_at: scheduledAt.toISOString(),
          timezone: timezone
        };
        
        const response = await fetch(`${API_BASE}/api/posts/schedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });
        
        if (response.ok) {
          hideScheduleModal();
          showLinkedInStatus(`[OK] Post scheduled for ${scheduledAt.toLocaleDateString()}`);
          
          // Also save locally
          const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
          scheduled.push(postData);
          localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
        } else {
          // Fallback to local storage
          const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
          scheduled.push(postData);
          localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
          
          hideScheduleModal();
          showLinkedInStatus(`[OK] Post scheduled locally for ${scheduledAt.toLocaleDateString()}`);
        }
      } catch (error) {
        logger.error('Schedule error:', error);
        
        // Fallback to local storage
        const scheduled = JSON.parse(localStorage.getItem('scheduled_posts') || '[]');
        scheduled.push({
          ...currentPost,
          status: 'scheduled',
          scheduled_at: scheduledAt.toISOString(),
          timezone: timezone
        });
        localStorage.setItem('scheduled_posts', JSON.stringify(scheduled));
        
        hideScheduleModal();
        showLinkedInStatus(`[OK] Post scheduled locally for ${scheduledAt.toLocaleDateString()}`);
      }
    }
    
    async function updatePostStatus(postId, status) {
      if (!supabaseEnabled) return false;
      
      try {
        const { error } = await supabaseClient
          .from('posts')
          .update({ status: status, updated_at: new Date().toISOString() })
          .eq('id', postId);
        
        return !error;
      } catch (e) {
        logger.error('Update post status error:', e);
        return false;
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LINKEDIN CONNECTION (SETTINGS)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function checkLinkedInStatus() {
      const indicator = document.getElementById('linkedin-connection-indicator');
      const text = document.getElementById('linkedin-connection-text');
      const btn = document.getElementById('linkedin-connect-btn');
      
      if (!indicator || !text || !btn) return;
      
      try {
        const email = currentUser?.email || '';
        const response = await fetch(`${API_BASE}/auth/linkedin/status?user_email=${encodeURIComponent(email)}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.status === 'connected') {
            indicator.classList.remove('bg-red-500', 'bg-gray-500');
            indicator.classList.add('bg-green-500');
            text.textContent = 'Connected';
            text.classList.remove('text-gray-300');
            text.classList.add('text-green-400');
            // Keep the button enabled for reconnection/verification
            btn.innerHTML = `
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              âœ“ LinkedIn Connected
            `;
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.disabled = false;
            btn.title = 'Click to reconnect or verify connection';
          } else {
            // Not connected
            indicator.classList.remove('bg-green-500');
            indicator.classList.add('bg-red-500');
            text.textContent = 'Not Connected';
            text.classList.remove('text-green-400');
            text.classList.add('text-gray-300');
            btn.innerHTML = `
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              Connect LinkedIn Account
            `;
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            btn.disabled = false;
          }
        }
      } catch (e) {
        logger.log('LinkedIn status check:', e);
        // Show as not connected / unknown on error
        indicator.classList.remove('bg-green-500');
        indicator.classList.add('bg-gray-500');
        text.textContent = 'Unknown';
        text.classList.remove('text-green-400');
        text.classList.add('text-gray-300');
      }
    }
    
    async function connectLinkedIn() {
      // Show connecting status
      const statusEl = document.getElementById('linkedin-connect-status');
      statusEl.textContent = 'ğŸ”„ Getting LinkedIn authorization...';
      statusEl.classList.remove('hidden', 'text-red-400');
      statusEl.classList.add('text-blue-400');
      
      try {
        // Get the LinkedIn OAuth URL from our backend
        const email = currentUser?.email || '';
        const response = await fetch(`${API_BASE}/auth/linkedin/authorize?user_email=${encodeURIComponent(email)}`);
        const data = await response.json();
        
        if (!data.auth_url) {
          statusEl.textContent = 'âŒ Failed to get LinkedIn authorization URL';
          statusEl.classList.remove('text-blue-400');
          statusEl.classList.add('text-red-400');
          return;
        }
        
        statusEl.textContent = 'ğŸ”„ Opening LinkedIn...';
        
        // Open LinkedIn auth in new window
        const popup = window.open(data.auth_url, 'LinkedIn Connect', 'width=600,height=700,scrollbars=yes');
        
        if (!popup) {
          // Fallback to redirect if popup blocked
          window.location.href = data.auth_url;
        } else {
          // Listen for message from popup
          const messageHandler = (event) => {
            if (event.data === 'linkedin_connected') {
              window.removeEventListener('message', messageHandler);
              statusEl.textContent = '[OK] LinkedIn connected successfully!';
              statusEl.classList.remove('text-blue-400');
              statusEl.classList.add('text-green-400');
              checkLinkedInStatus();
            } else if (event.data === 'linkedin_error') {
              window.removeEventListener('message', messageHandler);
              statusEl.textContent = '[X] LinkedIn connection failed.';
              statusEl.classList.remove('text-blue-400');
              statusEl.classList.add('text-red-400');
            }
          };
          window.addEventListener('message', messageHandler);
          
          // Also poll for popup close as backup
          const checkPopup = setInterval(() => {
            try {
              if (popup.closed) {
                clearInterval(checkPopup);
                // Only update if not already handled by message
                if (!statusEl.classList.contains('text-green-400') && !statusEl.classList.contains('text-red-400')) {
                  statusEl.textContent = 'Checking connection status...';
                  checkLinkedInStatus();
                }
              }
            } catch (e) {
              // Cross-origin error, popup still open
            }
          }, 1000);
        }
      } catch (error) {
        logger.error('LinkedIn connect error:', error);
        statusEl.textContent = '[X] Error connecting to LinkedIn';
        statusEl.classList.remove('text-blue-400');
        statusEl.classList.add('text-red-400');
      }
    }
    
    // NOTE: updateAdminSettingsUI removed - now handled by updateAdminLinkedInUI()

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ONBOARDING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function checkOnboardingStatus() {
      // ADMIN BYPASS: Check admin status FIRST before any database checks
      logger.log('[Onboarding] === CHECKING ONBOARDING STATUS ===');
      logger.log('[Onboarding] currentUser:', currentUser);
      logger.log('[Onboarding] currentUser.email:', currentUser?.email);
      
      // This ensures admin users always skip onboarding even if Supabase fails
      const userEmail = (currentUser?.email || '').toLowerCase().trim();
      const adminEmails = ['kunalsbhatt@gmail.com'];
      
      logger.log('[Onboarding] Checking email:', userEmail, 'against admins:', adminEmails);
      
      if (adminEmails.includes(userEmail)) {
        logger.log('[Onboarding] âœ“ Admin email MATCHED - bypassing onboarding');
        return true; // Skip onboarding for admins
      } else {
        logger.log('[Onboarding] Email not in admin list');
      }
      
      // Secondary check via isAdminUser function
      const adminCheck = isAdminUser();
      logger.log('[Onboarding] isAdminUser() returned:', adminCheck);
      if (adminCheck) {
        logger.log('[Onboarding] âœ“ Admin role detected - bypassing onboarding');
        return true;
      }
      
      // Check if Supabase is available
      if (!supabaseEnabled || !currentUser) {
        logger.log('[Onboarding] No Supabase or no user - skipping check');
        return true; // Skip check if no Supabase
      }
      
      logger.log('[Onboarding] Proceeding with Supabase check...');
      
      try {
        // Get user ID from users table
        const { data: user, error: userError } = await supabaseClient
          .from('users')
          .select('id, onboarding_completed')
          .eq('email', currentUser.email)
          .single();
        
        if (userError || !user) {
          logger.log('[Onboarding] User not found, will show onboarding');
          return false;
        }
        
        // Check onboarding_completed flag
        if (user.onboarding_completed) {
          logger.log('[Onboarding] Already completed');
          return true;
        }
        
        // Also check user_profiles table
        const { data: profile } = await supabaseClient
          .from('user_profiles')
          .select('id')
          .eq('user_id', user.id)
          .single();
        
        if (profile) {
          logger.log('[Onboarding] Profile exists, marking as completed');
          // Update users table to mark as completed
          await supabaseClient.from('users').update({ onboarding_completed: true }).eq('id', user.id);
          return true;
        }
        
        return false;
      } catch (e) {
        logger.error('[Onboarding] Status check error:', e);
        return true; // Default to skipping onboarding on error
      }
    }
    
    function showOnboarding() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.add('hidden');
      document.getElementById('onboarding-page').classList.remove('hidden');
      logger.log('[Onboarding] Showing onboarding page');
    }
    
    async function handleOnboardingSubmit() {
      const form = document.getElementById('onboarding-form');
      const errorEl = document.getElementById('onboarding-error');
      const btnText = document.getElementById('onboarding-btn-text');
      const spinner = document.getElementById('onboarding-spinner');
      
      // Validate required fields
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Get form values
      const industry = document.getElementById('onboarding-industry').value;
      const audience = document.getElementById('onboarding-audience').value;
      const style = document.querySelector('input[name="onboarding-style"]:checked')?.value;
      const topics = document.getElementById('onboarding-topics').value;
      const goal = document.getElementById('onboarding-goal').value;
      const pastedContent = document.getElementById('onboarding-content').value;
      
      if (!style) {
        errorEl.textContent = 'Please select a content style';
        errorEl.classList.remove('hidden');
        return;
      }
      
      // Show loading
      btnText.textContent = 'Saving...';
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      
      try {
        if (supabaseEnabled) {
          // Get user ID
          const { data: user } = await supabaseClient
            .from('users')
            .select('id')
            .eq('email', currentUser.email)
            .single();
          
          if (user) {
            // Parse topics into array
            const topicsArray = topics.split(',').map(t => t.trim()).filter(t => t);
            
            // Save to user_profiles - this is the "brain data" for AI agents
            const profileData = {
              user_id: user.id,
              
              // Onboarding questionnaire fields
              industry: industry,
              target_audience: audience,
              content_style: style,
              topics: topicsArray,
              primary_goal: goal,
              
              // Legacy/derived fields (for backward compatibility)
              writing_tone: style,
              content_focus: industry,
              key_values: topicsArray,
              dominant_style: style.toLowerCase(),
              extracted_themes: topicsArray,
              
              // Voice summary for AI context
              brand_voice_summary: `Industry: ${industry}. Target audience: ${audience}. Style: ${style}. Goal: ${goal}. Topics: ${topicsArray.join(', ')}.`,
              
              updated_at: new Date().toISOString()
            };
            
            // Upsert profile
            const { error: profileError } = await supabaseClient
              .from('user_profiles')
              .upsert(profileData, { onConflict: 'user_id' });
            
            if (profileError) {
              logger.error('[Onboarding] Profile save error:', profileError);
              throw new Error('Failed to save profile: ' + profileError.message);
            }
            
            // If user pasted content, save to content_analysis for AI learning
            if (pastedContent && pastedContent.trim().length > 10) {
              const analysisData = {
                user_id: user.id,
                analyzed_posts: { 
                  raw_content: pastedContent,
                  source: 'onboarding',
                  submitted_at: new Date().toISOString()
                },
                created_at: new Date().toISOString()
              };
              
              const { error: analysisError } = await supabaseClient
                .from('content_analysis')
                .upsert(analysisData, { onConflict: 'user_id' });
              
              if (analysisError) {
                logger.warn('[Onboarding] Content analysis save warning:', analysisError);
              }
            }
            
            // Mark onboarding as completed
            await supabaseClient
              .from('users')
              .update({ 
                onboarding_completed: true,
                onboarding_path: pastedContent ? 'content_analysis' : 'questionnaire'
              })
              .eq('id', user.id);
            
            logger.log('[Onboarding] Profile saved successfully. AI agents will use this data.');
          }
        }
        
        // Store locally as backup
        localStorage.setItem('onboarding_profile', JSON.stringify({
          industry, audience, style, topics, goal, pastedContent
        }));
        
        // Hide onboarding, show dashboard
        document.getElementById('onboarding-page').classList.add('hidden');
        await showDashboardAfterOnboarding();
        
      } catch (e) {
        logger.error('[Onboarding] Submit error:', e);
        errorEl.textContent = 'Error saving profile. Please try again.';
        errorEl.classList.remove('hidden');
      } finally {
        btnText.textContent = 'âœ“ Complete Setup & Start Creating';
        spinner.classList.add('hidden');
      }
    }
    
    async function showDashboardAfterOnboarding() {
      // This is called after onboarding is complete
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('onboarding-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-email').textContent = currentUser.email;
      checkApiStatus();
      updatePersonaUI();
      updateAdminLinkedInUI();
      
      // Fetch and display user subscription tier
      await loadUserSubscriptionTier();
      
      const loadedPosts = await loadPostsFromSupabase();
      if (loadedPosts && loadedPosts.length > 0) {
        posts = loadedPosts;
      } else {
        posts = posts || [];
      }
      
      updateMetrics();
      updateRecentPosts();
      updateHistoryGrid();
      logger.log('[OK] Dashboard loaded after onboarding');
      
      // Check if user came from pricing page with checkout intent
      await handlePendingCheckout();
    }

    async function showDashboard() {
      // Check if user needs onboarding first
      const onboardingComplete = await checkOnboardingStatus();
      
      if (!onboardingComplete) {
        showOnboarding();
        return;
      }
      
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('onboarding-page')?.classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('user-email').textContent = currentUser.email;
      checkApiStatus();
      
      // Update persona UI based on admin status
      updatePersonaUI();
      updateAdminLinkedInUI();  // Show admin LinkedIn actions if admin
      
      // Fetch and display user subscription tier
      await loadUserSubscriptionTier();
      
      // Load posts from Supabase
      logger.log('[DATA] Attempting to load posts from Supabase...');
      const loadedPosts = await loadPostsFromSupabase();
      logger.log('[DATA] Loaded posts count:', loadedPosts ? loadedPosts.length : 0);
      
      if (loadedPosts && loadedPosts.length > 0) {
        posts = loadedPosts;
        logger.log(`[OK] Restored ${posts.length} posts from Supabase`);
      } else {
        logger.warn('[WARN] No posts loaded from Supabase');
        // Initialize empty posts array
        posts = posts || [];
      }
      
      logger.log('ğŸ”„ Updating metrics and UI...');
      updateMetrics();
      updateRecentPosts();
      updateHistoryGrid();
      
      // Auto-sync subscription status silently in background (no UI blocking)
      autoSyncSubscription();
      
      logger.log('âœ… Dashboard loaded');
      
      // Check if user came from pricing page with checkout intent
      await handlePendingCheckout();
    }
    
    // Auto-sync subscription silently on dashboard load
    async function autoSyncSubscription() {
      try {
        const token = await window.Clerk?.session?.getToken();
        if (!token) return;
        
        const response = await fetch(`${API_BASE}/api/sync-subscription`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success && data.plan) {
          // Update UI silently without notification
          updatePlanBadge(data.plan);
          logger.log('[SYNC] Auto-synced subscription:', data.plan);
        }
      } catch (error) {
        // Silently fail - don't block dashboard loading
        logger.warn('[SYNC] Auto-sync failed (silent):', error.message);
      }
    }
    
    // Load and display user subscription tier from Supabase
    async function loadUserSubscriptionTier() {
      try {
        // Admin users get unlimited access - check first before Supabase
        if (isAdminUser()) {
          logger.log('[TIER] Admin user detected - showing admin tier');
          updatePlanDisplay('admin');
          return;
        }
        
        if (!supabaseEnabled || !currentUser) {
          logger.warn('[TIER] Supabase not available, showing default tier');
          updatePlanDisplay('free');
          return;
        }
        
        // Get user ID from users table
        const { data: user, error: userError } = await supabaseClient
          .from('users')
          .select('id')
          .eq('email', currentUser.email)
          .single();
        
        if (userError || !user) {
          logger.warn('[TIER] User not found in database');
          updatePlanDisplay('free');
          return;
        }
        
        // Fetch subscription tier from user_profiles
        const { data: profile, error: profileError } = await supabaseClient
          .from('user_profiles')
          .select('subscription_tier')
          .eq('user_id', user.id)
          .single();
        
        if (profileError || !profile) {
          logger.log('[TIER] No profile found, defaulting to free');
          updatePlanDisplay('free');
          return;
        }
        
        const tier = (profile.subscription_tier || 'free').toLowerCase();
        logger.log('[TIER] Loaded subscription tier:', tier);
        updatePlanDisplay(tier);
        
      } catch (error) {
        logger.error('[TIER] Error loading subscription tier:', error);
        updatePlanDisplay('free');
      }
    }
    
    // Update plan display in UI
    function updatePlanDisplay(tier) {
      const planBadgeEl = document.getElementById('current-plan-badge');
      const planNameEl = document.getElementById('current-plan-name');
      
      if (!planBadgeEl || !planNameEl) {
        logger.warn('[TIER] Plan display elements not found');
        return;
      }
      
      // Map tier to display values
      const tierMap = {
        'free': { name: 'Free', class: 'bg-gray-600/30 text-gray-300', emoji: 'ğŸ†“' },
        'pro': { name: 'Pro', class: 'bg-gradient-to-r from-cyan-500/30 to-violet-500/30 text-cyan-300 border border-cyan-500/50', emoji: 'â­' },
        'business': { name: 'Business', class: 'bg-gradient-to-r from-violet-500/30 to-fuchsia-500/30 text-violet-300 border border-violet-500/50', emoji: 'ğŸ’¼' },
        'admin': { name: 'Admin', class: 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 text-purple-300 border border-purple-500/50', emoji: 'ğŸ‘‘' }
      };
      
      const tierInfo = tierMap[tier] || tierMap['free'];
      
      // Update badge
      planBadgeEl.className = `px-3 py-1 rounded-full text-sm font-semibold ${tierInfo.class}`;
      planBadgeEl.textContent = `${tierInfo.emoji} ${tierInfo.name}`;
      
      // Update plan name if separate element exists
      if (planNameEl) {
        planNameEl.textContent = tierInfo.name;
      }
      
      // Update image generation toggle based on tier
      updateImageToggleForTier(tier);
      
      logger.log('[TIER] Display updated:', tierInfo.name);
    }
    
    // Update image generation toggle based on user's subscription tier
    function updateImageToggleForTier(tier) {
      const imageToggle = document.getElementById('generate-image-toggle');
      const upgradeBadge = document.getElementById('image-upgrade-badge');
      const upgradeHint = document.getElementById('image-upgrade-hint');
      const adminImageSection = document.getElementById('admin-image-generator-section');
      
      if (!imageToggle) return;
      
      const isPremiumUser = tier === 'pro' || tier === 'business' || tier === 'admin' || isAdminUser();
      const isAdmin = tier === 'admin' || isAdminUser();
      
      if (isPremiumUser) {
        // Enable toggle for premium users
        imageToggle.disabled = false;
        imageToggle.classList.remove('opacity-50', 'cursor-not-allowed');
        imageToggle.classList.add('cursor-pointer');
        if (upgradeBadge) upgradeBadge.classList.add('hidden');
        if (upgradeHint) upgradeHint.classList.add('hidden');
        
        // Show admin image generator selector only for admin users
        if (adminImageSection) {
          if (isAdmin) {
            adminImageSection.classList.remove('hidden');
            logger.log('[IMAGE TOGGLE] Admin mode - showing generator selector');
          } else {
            adminImageSection.classList.add('hidden');
          }
        }
        
        logger.log('[IMAGE TOGGLE] Enabled for tier:', tier);
      } else {
        // Disable toggle for free users
        imageToggle.disabled = true;
        imageToggle.checked = false;
        imageToggle.classList.add('opacity-50', 'cursor-not-allowed');
        imageToggle.classList.remove('cursor-pointer');
        if (upgradeBadge) upgradeBadge.classList.remove('hidden');
        if (upgradeHint) upgradeHint.classList.remove('hidden');
        if (adminImageSection) adminImageSection.classList.add('hidden');
        logger.log('[IMAGE TOGGLE] Disabled for tier:', tier);
      }
    }


    // Handle checkout if user came from pricing page
    async function handlePendingCheckout() {
      const urlParams = new URLSearchParams(window.location.search);
      const checkoutPlan = urlParams.get('checkout') || sessionStorage.getItem('selectedPlan');
      
      // Check for success/cancelled status
      if (checkoutPlan === 'success') {
        showNotification('Payment successful! Your plan is now active.', 'success');
        // Clear the URL parameter
        window.history.replaceState({}, document.title, window.location.pathname);
        sessionStorage.removeItem('selectedPlan');
        return;
      }
      
      if (checkoutPlan === 'cancelled') {
        showNotification('Checkout cancelled. You can upgrade anytime.', 'info');
        window.history.replaceState({}, document.title, window.location.pathname);
        sessionStorage.removeItem('selectedPlan');
        return;
      }
      
      // If there's a checkout plan, trigger checkout
      if (checkoutPlan && (checkoutPlan === 'pro' || checkoutPlan === 'business')) {
        logger.log('[CHECKOUT] Detected pending checkout for plan:', checkoutPlan);
        sessionStorage.removeItem('selectedPlan');
        
        // Clear the URL parameter
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Show loading message
        showNotification('Redirecting to checkout...', 'info');
        
        try {
          // Call checkout API
          const response = await fetch(`${API_BASE}/api/create-checkout`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
            },
            body: JSON.stringify({ plan: checkoutPlan })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create checkout');
          }
          
          const data = await response.json();
          
          if (data.checkout_url) {
            // Redirect to Stripe Checkout
            window.location.href = data.checkout_url;
          } else {
            throw new Error('No checkout URL returned');
          }
        } catch (error) {
          logger.error('[CHECKOUT] Error:', error);
          showNotification('Failed to start checkout: ' + error.message, 'error');
        }
      }
    }

    // Simple notification helper
    function showNotification(message, type = 'info') {
      // Use existing toast or create simple alert
      const colors = {
        success: 'bg-green-500/20 border-green-500/30 text-green-400',
        error: 'bg-red-500/20 border-red-500/30 text-red-400',
        info: 'bg-cyan-500/20 border-cyan-500/30 text-cyan-400'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${colors[type] || colors.info} animate-fade-in-up`;
      toast.innerHTML = `<p class="font-medium">${message}</p>`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Upgrade to a plan
    async function upgradeToplan(plan) {
      showNotification('Redirecting to checkout...', 'info');
      
      try {
        const response = await fetch(`${API_BASE}/api/create-checkout`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
          },
          body: JSON.stringify({ plan: plan })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to create checkout');
        }
        
        const data = await response.json();
        
        if (data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          throw new Error('No checkout URL returned');
        }
      } catch (error) {
        logger.error('[UPGRADE] Error:', error);
        showNotification('Failed to start checkout: ' + error.message, 'error');
      }
    }

    // Update subscription UI in settings section
    async function updateSubscriptionUI() {
      try {
        const response = await fetch(`${API_BASE}/api/user/subscription`, {
          headers: {
            'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
          }
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        const plan = data.plan || 'free';
        const postsUsed = data.posts_this_month || 0;
        const postLimit = data.post_limit || 5;
        const isAdmin = data.is_admin || plan === 'admin';
        
        // Plan descriptions
        const planDescriptions = {
          'free': '5 posts per month, basic features',
          'pro': '30 posts per month, image generation, all styles',
          'business': '200 posts per month, LinkedIn publishing, priority support',
          'admin': 'Unlimited posts, full access, admin privileges'
        };
        
        // Plan colors
        const planColors = {
          'free': 'bg-gray-500/20 text-gray-400',
          'pro': 'bg-cyan-500/20 text-cyan-400',
          'business': 'bg-violet-500/20 text-violet-400',
          'admin': 'bg-purple-500/20 text-purple-400 border border-purple-500/50'
        };
        
        // Update settings section elements
        const settingsBadge = document.getElementById('settings-plan-badge');
        if (settingsBadge) {
          settingsBadge.className = `px-3 py-1 rounded-full text-sm font-semibold ${planColors[plan] || planColors.free}`;
          settingsBadge.textContent = plan.toUpperCase();
        }
        
        const settingsDesc = document.getElementById('settings-plan-description');
        if (settingsDesc) {
          settingsDesc.textContent = planDescriptions[plan] || planDescriptions.free;
        }
        
        // Update usage counts - handle unlimited for admin
        const usedEl = document.getElementById('settings-posts-used');
        const limitEl = document.getElementById('settings-posts-limit');
        if (usedEl) usedEl.textContent = postsUsed;
        if (limitEl) {
          limitEl.textContent = isAdmin ? 'âˆ' : postLimit;
        }
        
        // Update progress bar - admin gets full purple bar
        const progressBar = document.getElementById('settings-usage-bar');
        if (progressBar) {
          if (isAdmin) {
            // Admin: show a nice gradient without "limit" concept
            progressBar.style.width = '100%';
            progressBar.classList.remove('from-red-500', 'to-orange-500');
            progressBar.classList.add('from-purple-500', 'to-violet-500');
          } else {
            const percent = Math.min((postsUsed / postLimit) * 100, 100);
            progressBar.style.width = `${percent}%`;
            
            // Change color if near limit
            if (percent >= 90) {
              progressBar.classList.remove('from-violet-500', 'to-fuchsia-500');
              progressBar.classList.add('from-red-500', 'to-orange-500');
            }
          }
        }
        
        // Show/hide upgrade buttons based on plan
        const upgradeOptions = document.getElementById('settings-upgrade-options');
        const premiumActive = document.getElementById('settings-premium-active');
        const upgradeToBusinessDiv = document.getElementById('settings-upgrade-to-business');
        
        if (isAdmin || plan !== 'free') {
          if (upgradeOptions) upgradeOptions.classList.add('hidden');
          if (premiumActive) premiumActive.classList.remove('hidden');
          
          // Hide "Upgrade to Business" for Business and Admin users
          if ((plan === 'business' || isAdmin) && upgradeToBusinessDiv) {
            upgradeToBusinessDiv.classList.add('hidden');
          } else if (upgradeToBusinessDiv) {
            upgradeToBusinessDiv.classList.remove('hidden');
          }
        } else {
          if (upgradeOptions) upgradeOptions.classList.remove('hidden');
          if (premiumActive) premiumActive.classList.add('hidden');
        }
        
        // Update header badge
        updatePlanBadge(plan);
        
      } catch (error) {
        logger.error('[SUBSCRIPTION] Error updating UI:', error);
      }
    }

    // Sync subscription from Stripe
    async function syncSubscription() {
      const btn = document.getElementById('sync-subscription-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Syncing...';
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/sync-subscription`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification(`Subscription synced: ${data.plan?.toUpperCase() || 'FREE'}`, 'success');
          // Refresh the subscription UI
          await updateSubscriptionUI();
          // Update header badge
          updatePlanBadge(data.plan);
        } else {
          showNotification('Sync failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        logger.error('[SYNC] Error:', error);
        showNotification('Sync failed: ' + error.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Sync from Stripe';
        }
      }
    }

    // Update plan badge in header
    function updatePlanBadge(plan) {
      const badge = document.getElementById('user-plan-badge');
      if (badge) {
        if (plan && plan !== 'free') {
          badge.textContent = plan.toUpperCase();
          badge.classList.remove('hidden');
          // Different colors for different plans
          if (plan === 'business') {
            badge.className = 'px-2 py-0.5 text-xs font-bold rounded-full bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white';
          } else {
            badge.className = 'px-2 py-0.5 text-xs font-bold rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 text-white';
          }
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    // Cancel subscription
    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.')) {
        return;
      }
      
      showNotification('To cancel your subscription, please use the Stripe Customer Portal or contact support.', 'info');
      // Open Stripe customer portal (would need to be configured)
      window.open('https://billing.stripe.com/p/login/test', '_blank');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showSection(section) {
      document.getElementById('section-dashboard').classList.add('hidden');
      document.getElementById('section-generate').classList.add('hidden');
      document.getElementById('section-history').classList.add('hidden');
      document.getElementById('section-settings')?.classList.add('hidden');
      document.getElementById('section-' + section).classList.remove('hidden');
      
      // Update navigation active states
      const navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(link => {
        link.classList.remove('font-bold', 'text-white');
        link.classList.add('text-gray-400');
      });
      
      const activeLink = Array.from(navLinks).find(link => 
        link.getAttribute('onclick')?.includes(`'${section}'`)
      );
      if (activeLink) {
        activeLink.classList.add('font-bold', 'text-white');
        activeLink.classList.remove('text-gray-400');
      }
      
      // Update history when switching to history view
      if (section === 'history') {
        updateHistoryGrid();
      }
      
      // Update generate section with persona controls
      if (section === 'generate') {
        updatePersonaUI();  // Ensure admin controls are visible for admin users
      }
      
      // Update settings when switching to settings view
      if (section === 'settings') {
        logger.log('>>> SETTINGS BLOCK ENTERED <<<');
        logger.log('About to call updateAdminLinkedInUI...');
        updateAdminLinkedInUI();  // Show/hide admin-only settings sections FIRST
        logger.log('updateAdminLinkedInUI completed');
        
        // Update subscription UI in settings
        updateSubscriptionUI();
        
        // Fetch admin persona status if admin user
        if (isAdminUser()) {
          fetchAdminPersonaStatus();
        }
        
        try {
          if (typeof checkLinkedInStatus === 'function') {
            checkLinkedInStatus();
          }
        } catch (e) {
          logger.warn('[Settings] checkLinkedInStatus error:', e);
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function checkApiStatus() {
      const statusEl = document.getElementById('metric-api-status');
      const iconEl = document.getElementById('api-status-icon');
      const barEl = document.getElementById('api-status-bar');
      
      try {
        const response = await fetch(`${API_BASE}/health`);
        if (response.ok) {
          statusEl.textContent = 'Online';
          statusEl.classList.remove('text-red-400');
          statusEl.classList.add('text-green-400');
          barEl.style.width = '100%';
          barEl.className = 'bg-gradient-to-r from-green-500 to-emerald-500 h-2.5 rounded-full transition-all duration-500';
          
          // Update icon
          if (iconEl) {
            iconEl.classList.remove('bg-gray-500/20', 'bg-red-500/20');
            iconEl.classList.add('bg-green-500/20');
            const svg = iconEl.querySelector('svg');
            if (svg) {
              svg.classList.remove('text-gray-400', 'text-red-400');
              svg.classList.add('text-green-400');
            }
          }
        } else {
          throw new Error('API unavailable');
        }
      } catch (e) {
        statusEl.textContent = 'Offline';
        statusEl.classList.remove('text-green-400');
        statusEl.classList.add('text-red-400');
        barEl.style.width = '0%';
        
        // Update icon
        if (iconEl) {
          iconEl.classList.remove('bg-gray-500/20', 'bg-green-500/20');
          iconEl.classList.add('bg-red-500/20');
          const svg = iconEl.querySelector('svg');
          if (svg) {
            svg.classList.remove('text-gray-400', 'text-green-400');
            svg.classList.add('text-red-400');
          }
        }
      }
    }

    async function handleGenerate(event) {
      event.preventDefault();
      
      const topic = document.getElementById('topic-input').value;
      const style = document.getElementById('style-select').value;
      const generateImage = document.getElementById('generate-image-toggle').checked;
      
      // Get persona: either admin persona_id or free-text persona input
      const activePersonaId = getActivePersonaId();
      const personaInput = document.getElementById('persona-input')?.value;

      // === POST LIMIT CHECK ===
      try {
        const limitResponse = await fetch(`${API_BASE}/api/check-post-limit`, {
          headers: {
            'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
          }
        });
        
        if (limitResponse.ok) {
          const limitData = await limitResponse.json();
          
          if (!limitData.can_generate) {
            // Show upgrade message
            const errorEl = document.getElementById('generate-error');
            if (limitData.plan === 'free') {
              errorEl.innerHTML = `
                <div class="flex items-center justify-between">
                  <span>ğŸ“Š You've reached your monthly limit (${limitData.posts_used}/${limitData.posts_limit} posts).</span>
                  <button onclick="showSection('settings')" class="ml-4 px-4 py-2 bg-gradient-to-r from-cyan-500 to-violet-500 rounded-lg text-white font-semibold text-sm">
                    Upgrade to Pro
                  </button>
                </div>
              `;
            } else {
              errorEl.textContent = `ğŸ“Š Monthly limit reached (${limitData.posts_used}/${limitData.posts_limit}). Limit resets next month.`;
            }
            errorEl.classList.remove('hidden');
            return;
          }
        }
      } catch (e) {
        logger.warn('[POST LIMIT] Could not check limit:', e);
        // Continue anyway - don't block generation if check fails
      }
      // === END POST LIMIT CHECK ===

      // Show loading and agent progress
      document.getElementById('generate-btn').disabled = true;
      document.getElementById('generate-btn-text').textContent = 'Generating...';
      document.getElementById('generate-spinner').classList.remove('hidden');
      document.getElementById('result-empty').classList.add('hidden');
      document.getElementById('result-content').classList.add('hidden');
      document.getElementById('agent-progress').classList.remove('hidden');
      
      // Clear any previous error/status messages
      document.getElementById('generate-error').classList.add('hidden');
      document.getElementById('generate-status').classList.add('hidden');
      
      // Reset agent progress
      resetAgentProgress();
      
      // Start agent progress simulation
      await simulateAgentProgress('content', 'ContentAgent generating content...');

      try {
        // Build request body
        const requestBody = { 
          topic, 
          style, 
          persona: personaInput || null,
          persona_id: activePersonaId,  // Admin persona injection
          generate_image: generateImage,  // Pass the toggle value
          user_email: currentUser?.email || null,  // User identification
          // Admin-only: Image generator type selection
          image_generator_type: isAdminUser() ? (document.getElementById('image-generator-select')?.value || 'gemini') : 'gemini'
        };
        
        // If improving existing post, add post_id and version (hybrid history pattern)
        if (improvingPost && improvingPost.post_id) {
          requestBody.post_id = improvingPost.post_id;
          requestBody.expected_version = improvingPost.version;
          logger.log('ğŸ“ [Generate] Improving post:', improvingPost.post_id, 'v' + improvingPost.version);
        }
        
        const response = await fetch(`${API_BASE}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (response.ok) {
          // Mark content done, start virality
          completeAgentStep('content');
          await simulateAgentProgress('virality', 'ViralityAgent scoring post...');
          
          const data = await response.json();
          
          // Mark virality done
          completeAgentStep('virality');
          
          // Only show image progress if generating image
          if (generateImage) {
            await simulateAgentProgress('image', 'ImageGenerator creating visual...');
            
            // Use API-generated branded image if available
            if (data.image_url) {
              data.imageUrl = API_BASE + data.image_url;
            } else {
              data.imageUrl = postImages[posts.length % postImages.length];
            }
            completeAgentStep('image');
          } else {
            // Skip image step - mark as skipped
            const imageStepEl = document.getElementById('step-image');
            if (imageStepEl) {
              const statusText = imageStepEl.querySelector('.text-gray-400');
              if (statusText) statusText.textContent = 'Skipped (deferred)';
            }
            data.imageUrl = null;
            data.imageDeferred = true;  // Flag for showing "Generate Image" button later
          }
          
          
          await delay(500);
          await delay(500);
          
          // Ensure data has required fields
          data.timestamp = data.timestamp || new Date().toISOString();
          data.topic = data.topic || topic;
          
          currentPost = data;
          
          // Handle improve vs new post (hybrid history pattern)
          if (improvingPost && improvingPost.post_id) {
            // UPDATE existing post in posts array
            const postIndex = posts.findIndex(p => 
              (p.id === improvingPost.post_id) || (p.post_id === improvingPost.post_id)
            );
            if (postIndex >= 0) {
              // Update existing post with new data
              data.id = improvingPost.post_id;
              data.improvement_count = (posts[postIndex].improvement_count || 0) + 1;
              data.previous_score = improvingPost.original_score;
              data.version = (improvingPost.version || 1) + 1;
              posts[postIndex] = { ...posts[postIndex], ...data };
              logger.log('âœ… [Improve] Updated existing post in array:', postIndex);
            } else {
              // Post not found in local array - add it (shouldn't happen normally)
              posts.unshift(data);
              logger.warn('âš ï¸ [Improve] Post not found in local array, added as new');
            }
            // Clear improving state
            improvingPost = null;
          } else {
            // NEW post - add to beginning of array
            // Ensure it has ID from API response for future improvements
            data.id = data.post_id || data.id;
            data.version = data.version || 1;
            data.improvement_count = data.improvement_count || 0;
            posts.unshift(data);
            logger.log('[OK] [Generate] Added new post to array, id:', data.id);
          }
          
          // Note: Don't call savePostToSupabase - backend already saved/updated it
          
          // === INCREMENT POST COUNT ===
          try {
            await fetch(`${API_BASE}/api/increment-post-count`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${await window.Clerk?.session?.getToken()}`
              }
            });
            logger.log('[OK] Post count incremented');
          } catch (e) {
            logger.warn('[POST COUNT] Could not increment:', e);
          }
          // === END INCREMENT POST COUNT ===
          
          // Hide progress, show result
          document.getElementById('agent-progress').classList.add('hidden');
          displayResult(data);
          updateMetrics();
          updateRecentPosts();
          updateHistoryGrid();
        } else {
          document.getElementById('agent-progress').classList.add('hidden');
          const error = await response.json();
          
          // Display error in generate-error element
          const errorEl = document.getElementById('generate-error');
          const statusEl = document.getElementById('generate-status');
          
          // Check for rate limit (429)
          if (response.status === 429) {
            statusEl.textContent = 'â³ Rate limit exceeded. Please wait ' + (error.retry_after || 60) + ' seconds.';
            statusEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
          } else {
            errorEl.textContent = 'âŒ ' + (error.detail || error.error || 'Failed to generate content');
            errorEl.classList.remove('hidden');
            statusEl.classList.add('hidden');
          }
        }
      } catch (e) {
        document.getElementById('agent-progress').classList.add('hidden');
        
        // Display error in generate-error element
        const errorEl = document.getElementById('generate-error');
        errorEl.textContent = 'âŒ Error connecting to API: ' + e.message;
        errorEl.classList.remove('hidden');
        document.getElementById('generate-status').classList.add('hidden');
      }

      document.getElementById('generate-btn').disabled = false;
      document.getElementById('generate-btn-text').textContent = 'Generate Post';
      document.getElementById('generate-spinner').classList.add('hidden');
    }

    // Agent progress helper functions
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function resetAgentProgress() {
      ['content', 'virality', 'image'].forEach(step => {
        document.getElementById(`step-${step}`).classList.remove('opacity-50');
        document.getElementById(`step-${step}`).classList.add('opacity-50');
        document.getElementById(`step-${step}-icon`).classList.remove('bg-violet-500', 'bg-green-500');
        document.getElementById(`step-${step}-icon`).classList.add('bg-gray-700');
        document.getElementById(`step-${step}-status`).textContent = 'â³';
      });
      document.getElementById('step-content').classList.remove('opacity-50');
    }

    async function simulateAgentProgress(step, message) {
      document.getElementById('current-agent').textContent = message;
      document.getElementById(`step-${step}`).classList.remove('opacity-50');
      document.getElementById(`step-${step}-icon`).classList.remove('bg-gray-700');
      document.getElementById(`step-${step}-icon`).classList.add('bg-violet-500');
      document.getElementById(`step-${step}-status`).textContent = 'ğŸ”„';
      await delay(300);
    }

    function completeAgentStep(step) {
      document.getElementById(`step-${step}-icon`).classList.remove('bg-violet-500');
      document.getElementById(`step-${step}-icon`).classList.add('bg-green-500');
      document.getElementById(`step-${step}-status`).textContent = 'âœ…';
    }

    function displayResult(data) {
      document.getElementById('result-empty').classList.add('hidden');
      document.getElementById('result-content').classList.remove('hidden');
      
      document.getElementById('result-score').textContent = data.virality_score + '/100';
      document.getElementById('result-text').textContent = data.content;
      
      const scoreColor = data.virality_score >= 80 ? 'text-green-400' : 
                         data.virality_score >= 60 ? 'text-yellow-400' : 'text-red-400';
      document.getElementById('result-score').className = 'text-2xl font-bold ' + scoreColor;

      const suggestionsList = document.getElementById('result-suggestions');
      const suggestionsSection = suggestionsList?.parentElement;
      suggestionsList.innerHTML = '';
      
      logger.log('[DATA] Suggestions from API:', data.suggestions);
      
      const suggestions = data.suggestions || [];
      if (suggestions.length > 0) {
        suggestionsSection.classList.remove('hidden');
        suggestions.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          suggestionsList.appendChild(li);
        });
      } else {
        suggestionsSection.classList.add('hidden');
      }
      
      // Handle image display or deferred generation button
      const imageContainer = document.getElementById('result-image-container');
      if (imageContainer) {
        if (data.imageUrl) {
          // Show the generated image with prominent save button
          imageContainer.innerHTML = `
            <div class="mt-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-gray-300">Generated Image:</h4>
                <button onclick="saveImage('${data.imageUrl}')" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-violet-600 hover:bg-violet-700 text-white rounded-lg transition-all shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                  Save Image (PNG)
                </button>
              </div>
              <img src="${data.imageUrl}" alt="Generated post image" class="rounded-lg max-w-full h-auto shadow-lg border border-white/10">
            </div>
          `;
        } else if (data.imageDeferred) {
          // Show button to generate image later
          imageContainer.innerHTML = `
            <div class="mt-4 p-4 glass-card rounded-lg text-center">
              <p class="text-gray-400 mb-3">Image generation was deferred. Ready to create your final image?</p>
              <button onclick="generateDeferredImage()" class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
                Generate AI Image Now
              </button>
            </div>
          `;
        } else {
          imageContainer.innerHTML = '';
        }
      }
    }

    // Handle deferred image generation
    async function generateDeferredImage() {
      if (!currentPost) return;
      
      const imageContainer = document.getElementById('result-image-container');
      imageContainer.innerHTML = `
        <div class="mt-4 p-4 glass-card rounded-lg text-center">
          <p class="text-gray-400">ğŸ¨ Generating AI image...</p>
          <div class="mt-2 flex justify-center">
            <svg class="animate-spin h-8 w-8 text-violet-500" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </div>
      `;
      
      try {
        const response = await fetch(`${API_BASE}/api/generate-image`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            content: currentPost.content,
            style: currentPost.style || 'professional'
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          currentPost.imageUrl = API_BASE + result.image_url;
          currentPost.imageDeferred = false;
          
          imageContainer.innerHTML = `
            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm text-gray-400">Generated Image:</h4>
                <button onclick="saveImage('${currentPost.imageUrl}')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-violet-600/20 hover:bg-violet-600/40 text-violet-300 rounded-lg transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                  </svg>
                  Save Image
                </button>
              </div>
              <img src="${currentPost.imageUrl}" alt="Generated post image" class="rounded-lg max-w-full h-auto shadow-lg">
            </div>
          `;
        } else {
          const error = await response.json();
          imageContainer.innerHTML = `
            <div class="mt-4 p-4 glass-card rounded-lg text-center">
              <p class="text-red-400 mb-3">Failed to generate image: ${error.detail || 'Unknown error'}</p>
              <button onclick="generateDeferredImage()" class="px-4 py-2 bg-violet-600 text-white rounded-lg">
                Retry
              </button>
            </div>
          `;
        }
      } catch (error) {
        imageContainer.innerHTML = `
          <div class="mt-4 p-4 glass-card rounded-lg text-center">
            <p class="text-red-400 mb-3">Error: ${error.message}</p>
            <button onclick="generateDeferredImage()" class="px-4 py-2 bg-violet-600 text-white rounded-lg">
              Retry
            </button>
          </div>
        `;
      }
    }


    function updateMetrics() {
      document.getElementById('metric-posts').textContent = posts.length;
      
      // Filter posts with valid virality scores
      const validPosts = posts.filter(p => p.virality_score && !isNaN(p.virality_score));
      
      if (validPosts.length > 0) {
        // Use last 10 posts for average (matches sparkline), posts are newest-first
        const recentPosts = validPosts.slice(0, 10);
        const avgScore = recentPosts.reduce((sum, p) => sum + (p.virality_score || 0), 0) / recentPosts.length;
        document.getElementById('metric-avg-score').textContent = avgScore.toFixed(0);
        
        const bestScore = Math.max(...validPosts.map(p => p.virality_score || 0));
        document.getElementById('metric-best-score').textContent = bestScore;
        
        // Update sparkline
        updateSparkline();
        
        // Update trend indicator: newest post vs average of previous 9 posts
        // Posts are newest-first, so validPosts[0] is the NEWEST post
        if (recentPosts.length >= 2) {
          const newestScore = recentPosts[0].virality_score || 0;
          const prevPosts = recentPosts.slice(1); // Previous 9 (or fewer) posts
          const prevAvg = prevPosts.reduce((sum, p) => sum + (p.virality_score || 0), 0) / prevPosts.length;
          const diff = newestScore - prevAvg;
          
          logger.log('[TREND] Newest score:', newestScore, 'Previous avg:', prevAvg.toFixed(1), 'Diff:', diff.toFixed(1));
          
          const trendEl = document.getElementById('avg-trend');
          const trendValueEl = document.getElementById('avg-trend-value');
          const arrowSvg = trendEl.querySelector('svg');
          
          if (Math.abs(diff) >= 0.5) {
            trendEl.classList.remove('hidden');
            trendEl.classList.add('flex');
            
            if (diff > 0) {
              // Positive: green, arrow up
              trendEl.classList.remove('bg-red-500/20', 'text-red-400');
              trendEl.classList.add('bg-green-500/20', 'text-green-400');
              arrowSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>';
              trendValueEl.textContent = `+${diff.toFixed(0)}`;
            } else {
              // Negative: red, arrow down
              trendEl.classList.remove('bg-green-500/20', 'text-green-400');
              trendEl.classList.add('bg-red-500/20', 'text-red-400');
              arrowSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>';
              trendValueEl.textContent = diff.toFixed(0);
            }
          } else {
            trendEl.classList.add('hidden');
          }
        }
      }
      
      // Update learning progress
      updateLearningProgress(posts.length);
    }  

    // Update learning progress milestone UI
    function updateLearningProgress(postCount) {
      const MILESTONE = 20;
      const progressPercent = Math.min((postCount / MILESTONE) * 100, 100);
      
      // Update count display
      const countEl = document.getElementById('learning-post-count');
      if (countEl) countEl.textContent = postCount;
      
      // Update progress bar
      const progressBar = document.getElementById('learning-progress-bar');
      if (progressBar) progressBar.style.width = `${progressPercent}%`;
      
      // Update milestone text
      const milestoneText = document.getElementById('learning-milestone-text');
      const statusText = document.getElementById('learning-status-text');
      const unlockedBanner = document.getElementById('learning-unlocked-banner');
      const voiceProfileSection = document.getElementById('voice-profile-section');
      
      if (postCount >= MILESTONE) {
        // Unlocked state
        if (milestoneText) milestoneText.textContent = 'Personalization is active!';
        if (statusText) statusText.textContent = 'AI is optimized for your voice';
        if (unlockedBanner) unlockedBanner.classList.remove('hidden');
        if (voiceProfileSection) {
          voiceProfileSection.classList.remove('hidden');
          loadVoiceProfile(); // Load profile data
        }
        
        // Change progress bar to green
        if (progressBar) {
          progressBar.classList.remove('from-cyan-500', 'to-violet-500');
          progressBar.classList.add('from-green-500', 'to-cyan-500');
        }
      } else {
        // Still learning
        const remaining = MILESTONE - postCount;
        if (milestoneText) milestoneText.textContent = `${remaining} post${remaining !== 1 ? 's' : ''} until personalization unlocks`;
        if (statusText) statusText.textContent = 'Generate posts to unlock personalization';
        if (unlockedBanner) unlockedBanner.classList.add('hidden');
        if (voiceProfileSection) voiceProfileSection.classList.add('hidden');
      }
    }
    
    // Toggle voice profile visibility
    function toggleVoiceProfile() {
      const content = document.getElementById('voice-profile-content');
      const chevron = document.getElementById('voice-profile-chevron');
      
      if (content) {
        content.classList.toggle('hidden');
        if (chevron) {
          chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
      }
    }
    
    // Load voice profile data from user profile
    async function loadVoiceProfile() {
      try {
        const token = await window.Clerk?.session?.getToken();
        const response = await fetch(`${API_BASE}/api/user/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const profile = data.profile || data;
          
          // Update profile display
          document.getElementById('profile-industry').textContent = profile.industry || 'Not specified';
          document.getElementById('profile-audience').textContent = profile.target_audience || profile.audience || 'General';
          document.getElementById('profile-style').textContent = profile.writing_style || profile.style || 'Professional';
          document.getElementById('profile-topics').textContent = 
            (Array.isArray(profile.topics) ? profile.topics.join(', ') : profile.topics) || 'General topics';
        }
      } catch (e) {
        logger.warn('[PROFILE] Could not load voice profile:', e);
        // Set defaults
        document.getElementById('profile-industry').textContent = 'Technology';
        document.getElementById('profile-audience').textContent = 'Professionals';
        document.getElementById('profile-style').textContent = 'Thought Leadership';
        document.getElementById('profile-topics').textContent = 'Based on your generated content';
      }
    }
    
    function updateSparkline() {
      const sparklinePath = document.getElementById('sparkline-path');
      if (!sparklinePath) {
        logger.log('[CHART] [Sparkline] Element not found');
        return;
      }
      
      // Filter posts with valid virality scores
      const validPosts = posts.filter(p => p.virality_score && !isNaN(p.virality_score));
      logger.log('[CHART] [Sparkline] Total posts:', posts.length, 'Valid posts:', validPosts.length);
      
      if (validPosts.length > 0) {
        logger.log('[CHART] [Sparkline] Sample scores:', validPosts.slice(-5).map(p => p.virality_score));
      }
      
      if (validPosts.length < 2) {
        // Show flat line at average if only 1 post or no posts
        const avgScore = validPosts.length === 1 ? validPosts[0].virality_score : 50;
        const normalizedY = 20 - ((avgScore / 100) * 20);
        const flatPoints = `0,${normalizedY} 100,${normalizedY}`;
        logger.log('[CHART] [Sparkline] Flat line (< 2 posts):', flatPoints);
        sparklinePath.setAttribute('points', flatPoints);
        return;
      }
      
      // Get RECENT 10 scores (posts are newest-first, so slice first 10 and reverse for chronological order)
      const recentPosts = validPosts.slice(0, 10).reverse(); // oldest-to-newest for proper graph direction
      const scores = recentPosts.map(p => p.virality_score || 0);
      const max = Math.max(...scores);
      const min = Math.min(...scores);
      const range = max - min || 1;
      
      logger.log('[CHART] [Sparkline] Recent scores (oldest-newest):', scores);
      logger.log('[CHART] [Sparkline] Range:', min, '-', max, '(diff:', range, ')');
      
      const width = 100;
      const height = 20;
      const points = scores.map((score, i) => {
        const x = scores.length === 1 ? 50 : (i / (scores.length - 1)) * width;
        const y = height - ((score - min) / range) * (height - 2) - 1;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');
      
      logger.log('[CHART] [Sparkline] Points:', points);
      sparklinePath.setAttribute('points', points);
    }

    function updateRecentPosts() {
      const grid = document.getElementById('recent-posts-grid');
      if (posts.length === 0) return;
      
      // Posts are already newest-first from Supabase, so take first 6
      grid.innerHTML = posts.slice(0, 6).map((post, i) => {
        const postIndex = i; // Posts are already in correct order
        
        // Clean content for preview (remove "Improve this post:" prefix)
        let cleanText = (post.content || '').replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
        cleanText = cleanText.substring(0, 100);
        
        // Clean topic for display (with null check)
        let displayTopic = post.topic || 'Generated Post';
        if (displayTopic.toLowerCase().startsWith('improve this post')) {
          displayTopic = cleanText.substring(0, 50) + '...';
        }
        
        return `
        <div class="glass-card rounded-xl overflow-hidden cursor-pointer group animate-fade-in-up" 
             style="animation-delay: ${i * 80}ms"
             onclick="viewPost(${postIndex})">
          <img src="${post.imageUrl || postImages[postIndex % postImages.length]}" 
               alt="${displayTopic}" 
               class="w-full h-40 object-cover group-hover:scale-105 transition-transform duration-300"
               onerror="this.onerror=null; this.src='${postImages[postIndex % postImages.length]}'">
          <div class="p-4">
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs px-2 py-1 rounded-full ${post.virality_score >= 80 ? 'status-published' : 'status-draft'}">
                Score: ${post.virality_score}
              </span>
              <span class="text-xs text-gray-400">${new Date(post.timestamp).toLocaleTimeString()}</span>
            </div>
            <h3 class="font-semibold text-white mb-2">${displayTopic.substring(0, 50)}${displayTopic.length > 50 ? '...' : ''}</h3>
            <p class="text-gray-400 text-sm line-clamp-2">${cleanText}...</p>
          </div>
        </div>
      `}).join('');
    }

    function updateHistoryGrid() {
      const grid = document.getElementById('history-grid');
      
      if (posts.length === 0) {
        grid.innerHTML = `
          <div class="glass-card rounded-xl p-12 text-center col-span-full">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-violet-500/20 mb-4">
              <svg class="w-8 h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Ready to Create Viral Content?</h3>
            <p class="text-gray-400 mb-6">Your first post is just a click away</p>
            <button onclick="showSection('generate')" class="px-6 py-3 gradient-button rounded-lg text-white font-semibold">
              Start Generating
            </button>
          </div>
        `;
        return;
      }
      
      // Get filter and sort values
      const filterEl = document.getElementById('history-filter-score');
      const sortEl = document.getElementById('history-sort');
      const searchEl = document.getElementById('history-search');
      
      const filter = filterEl ? filterEl.value : 'all';
      const sort = sortEl ? sortEl.value : 'recent';
      const searchTerm = searchEl ? searchEl.value.toLowerCase().trim() : '';
      
      // Filter posts
      let filteredPosts = posts.map((post, idx) => ({ ...post, originalIndex: idx }));
      
      // Apply search filter
      if (searchTerm) {
        filteredPosts = filteredPosts.filter(p => {
          const content = p.content.replace(/^Improve this post[^:]*:\s*\n*/i, '').toLowerCase();
          const topic = p.topic.toLowerCase();
          return content.includes(searchTerm) || topic.includes(searchTerm);
        });
      }
      
      // Apply score filter
      if (filter === '90') {
        filteredPosts = filteredPosts.filter(p => p.virality_score >= 90);
      } else if (filter === '70') {
        filteredPosts = filteredPosts.filter(p => p.virality_score >= 70 && p.virality_score < 90);
      } else if (filter === 'below') {
        filteredPosts = filteredPosts.filter(p => p.virality_score < 70);
      }
      
      // Sort posts
      if (sort === 'recent') {
        filteredPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      } else if (sort === 'oldest') {
        filteredPosts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      } else if (sort === 'highest') {
        filteredPosts.sort((a, b) => b.virality_score - a.virality_score);
      } else if (sort === 'lowest') {
        filteredPosts.sort((a, b) => a.virality_score - b.virality_score);
      }
      
      if (filteredPosts.length === 0) {
        grid.innerHTML = `
          <div class="glass-card rounded-xl p-8 text-center col-span-full text-gray-400">
            <p class="mb-4">No posts match your filters</p>
            <button onclick="document.getElementById('history-search').value=''; document.getElementById('history-filter-score').value='all'; updateHistoryGrid();" 
                    class="px-4 py-2 gradient-border-button rounded-lg text-white text-sm">
              Clear Filters
            </button>
          </div>
        `;
        return;
      }
      
      // Compact card layout (no large images)
      grid.innerHTML = filteredPosts.map((post, i) => {
        const scoreClass = post.virality_score >= 90 ? 'bg-green-500/20 text-green-400 border-green-500/30' : 
                          post.virality_score >= 70 ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30' : 
                          'bg-red-500/20 text-red-400 border-red-500/30';
        
        // Clean content for preview (remove "Improve this post:" prefix) - with null check
        let previewContent = (post.content || '').replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
        previewContent = previewContent.replace(/\n/g, ' ').substring(0, 100);
        
        // Clean topic for display (with null check)
        let displayTopic = post.topic || 'Generated Post';
        if (displayTopic.toLowerCase().startsWith('improve this post')) {
          displayTopic = previewContent.substring(0, 50) + '...';
        }
        
        return `
        <div class="glass-card rounded-xl overflow-hidden cursor-pointer hover:border-violet-500/40 transition-all duration-300" 
             onclick="viewPost(${post.originalIndex})">
          
          <!-- Compact Header with Key Info -->
          <div class="p-4 border-b border-white/5">
            <div class="flex items-start justify-between gap-3 mb-2">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <h3 class="font-semibold text-white text-base line-clamp-1">${displayTopic}</h3>
                ${post.improvement_count > 0 ? `<span class="shrink-0 text-xs px-2 py-0.5 rounded-full bg-violet-500/20 text-violet-400 border border-violet-500/30">v${post.version}</span>` : ''}
              </div>
              <span class="text-sm px-2.5 py-1 rounded-full font-bold ${scoreClass} border backdrop-blur-sm shrink-0">
                ${post.virality_score}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <p class="text-xs text-gray-400">${new Date(post.timestamp).toLocaleDateString()} â€¢ ${new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
              ${post.improvement_count > 0 ? `<span class="text-xs text-violet-400">â€¢ ${post.improvement_count}x improved</span>` : ''}
            </div>
          </div>
          
          <!-- Content Preview (Reduced) -->
          <div class="p-4">
            <p class="text-gray-400 text-sm line-clamp-2 leading-relaxed mb-3">
              ${previewContent}...
            </p>
            
            <!-- Action Row -->
            <div class="flex items-center justify-between text-xs">
              <button onclick="event.stopPropagation(); viewPost(${post.originalIndex})" class="text-violet-400 hover:text-violet-300 transition-colors flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span class="group-hover:underline">View Full</span>
              </button>
              <button onclick="event.stopPropagation(); copyPost(${post.originalIndex})" class="text-gray-500 hover:text-gray-300 transition-colors flex items-center gap-1">
                Copy
              </button>
            </div>
          </div>
        </div>
      `}).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POST ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Helper to clean content (remove "Improve this post:" prefix)
    function cleanContent(text) {
      if (!text) return '';
      return text.replace(/^Improve this post[^:]*:\s*\n*/i, '').trim();
    }
    
    // Helper to get clean topic
    function cleanTopic(post) {
      if (!post.topic) return 'Untitled';
      if (post.topic.toLowerCase().startsWith('improve this post')) {
        return cleanContent(post.content).substring(0, 50) + '...';
      }
      return post.topic;
    }
    
    function viewPost(index) {
      const post = posts[index];
      if (!post) return;
      
      selectedPostIndex = index;
      currentPost = post;
      
      // Clean content for display
      const displayContent = cleanContent(post.content);
      const displayTopic = cleanTopic(post);
      
      const modal = document.createElement('div');
      modal.id = 'post-modal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in-up';
      modal.style.background = 'rgba(0,0,0,0.85)';
      modal.style.backdropFilter = 'blur(8px)';
      
      modal.innerHTML = `
        <div class="glass-card rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-white pr-4">${displayTopic}</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
          </div>
          
          ${post.imageUrl ? `
            <img src="${post.imageUrl}" 
                 alt="${displayTopic}" 
                 class="w-full h-48 object-cover rounded-lg mb-4"
                 onerror="this.style.display='none'">
          ` : ''}
          
          <div class="flex items-center gap-4 mb-4 flex-wrap">
            <span class="text-2xl font-bold ${post.virality_score >= 80 ? 'text-green-400' : post.virality_score >= 60 ? 'text-yellow-400' : 'text-red-400'}">
              ${post.virality_score}/100
            </span>
            <span class="text-gray-400 text-sm">${new Date(post.timestamp).toLocaleString()}</span>
            ${post.improvement_count > 0 ? `
              <span class="px-2 py-1 text-xs rounded-full bg-violet-500/20 text-violet-400 border border-violet-500/30">
                v${post.version || 2} â€¢ ${post.improvement_count}x improved
              </span>
              ${post.previous_score ? `<span class="text-xs text-gray-500">was ${post.previous_score}/100</span>` : ''}
            ` : ''}
          </div>
          
          ${post.improvement_count > 0 && post.id ? `
            <button onclick="viewPostHistory('${post.id}')" class="w-full mb-4 py-2 px-4 bg-violet-500/10 hover:bg-violet-500/20 border border-violet-500/30 rounded-lg text-violet-300 text-sm font-medium transition-all flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              View Original (Before Improvement)
            </button>
          ` : ''}
          
          <div class="bg-white/5 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto">
            <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${displayContent}</p>
          </div>
          
          ${post.suggestions && post.suggestions.length > 0 ? `
            <div class="mb-4 bg-violet-500/10 border border-violet-500/20 rounded-lg p-4">
              <h4 class="text-sm font-semibold text-violet-300 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                Suggestions to Improve Score
              </h4>
              <ul class="list-disc list-inside text-sm text-gray-300 space-y-1.5">
                ${post.suggestions.map(s => `<li class="leading-relaxed">${s}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          
          ${post.imageUrl ? `
            <div class="mb-4">
              <button onclick="saveImage('${post.imageUrl}')" class="w-full py-2.5 px-4 bg-violet-600/30 hover:bg-violet-600/50 border border-violet-500/30 rounded-lg text-white font-semibold text-sm transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Save Image (PNG)
              </button>
            </div>
          ` : ''}
          
          <div class="flex gap-3">
            <button id="copy-btn-${index}" onclick="copyPost(${index})" class="flex-1 py-2.5 px-4 gradient-border-button rounded-lg text-white font-semibold text-sm hover:scale-105 transition-transform">
              Copy to Clipboard
            </button>
            <button onclick="editPost(${index}); closeModal();" class="flex-1 py-2.5 px-4 gradient-button rounded-lg text-white font-semibold text-sm hover:scale-105 transition-transform">
              Improve Post
            </button>
          </div>
        </div>
      `;
      
      // Click backdrop to close
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      const modal = document.getElementById('post-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 200);
      }
    }
    
    // View post history (original version before improvement)
    async function viewPostHistory(postId) {
      if (!postId) return;
      
      try {
        // Fetch history from Supabase RPC
        const { data: history, error } = await supabaseClient.rpc('get_post_history', { 
          p_post_id: postId 
        });
        
        if (error) throw error;
        
        if (!history || history.length === 0) {
          alert('No history available for this post.');
          return;
        }
        
        // Get the most recent history entry (the original before improvement)
        const original = history[0];
        
        // Create history comparison modal
        const historyModal = document.createElement('div');
        historyModal.id = 'history-modal';
        historyModal.className = 'fixed inset-0 z-[60] flex items-center justify-center p-4 animate-fade-in-up';
        historyModal.style.background = 'rgba(0,0,0,0.9)';
        historyModal.style.backdropFilter = 'blur(8px)';
        
        historyModal.innerHTML = `
          <div class="glass-card rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
              <h2 class="text-2xl font-bold text-white">ğŸ“œ Post History</h2>
              <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Original Version -->
              <div class="bg-white/5 rounded-lg p-4 border border-gray-700">
                <div class="flex items-center gap-2 mb-3">
                  <span class="px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">
                    Original v${original.version}
                  </span>
                  <span class="text-xs text-gray-500">${new Date(original.created_at).toLocaleString()}</span>
                </div>
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-lg font-bold text-yellow-400">${original.previous_score}/100</span>
                  <span class="text-xs text-gray-500">score before</span>
                </div>
                <div class="max-h-64 overflow-y-auto">
                  <p class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed">${original.original_content || 'Content not available'}</p>
                </div>
              </div>
              
              <!-- Current Version -->
              <div class="bg-green-500/5 rounded-lg p-4 border border-green-500/30">
                <div class="flex items-center gap-2 mb-3">
                  <span class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                    Current v${currentPost.version || original.version + 1}
                  </span>
                  <span class="text-xs text-green-500">improved</span>
                </div>
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-lg font-bold text-green-400">${currentPost.virality_score}/100</span>
                  <span class="text-xs text-gray-500">score after</span>
                  <span class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">
                    +${currentPost.virality_score - (original.previous_score || 0)}
                  </span>
                </div>
                <div class="max-h-64 overflow-y-auto">
                  <p class="text-white whitespace-pre-wrap text-sm leading-relaxed">${cleanContent(currentPost.content)}</p>
                </div>
              </div>
            </div>
            
            <div class="mt-4 text-center">
              <button onclick="closeHistoryModal()" class="px-6 py-2 gradient-button rounded-lg text-white font-semibold">
                Close History
              </button>
            </div>
          </div>
        `;
        
        historyModal.onclick = (e) => {
          if (e.target === historyModal) closeHistoryModal();
        };
        
        document.body.appendChild(historyModal);
        
      } catch (err) {
        logger.error('Failed to load post history:', err);
        alert('Failed to load post history: ' + err.message);
      }
    }
    
    function closeHistoryModal() {
      const modal = document.getElementById('history-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => modal.remove(), 200);
      }
    }

    function copyPost(index) {
      const post = posts[index];
      if (post) {
        const cleanText = cleanContent(post.content);
        navigator.clipboard.writeText(cleanText).then(() => {
          // Visual feedback
          const btn = document.getElementById(`copy-btn-${index}`);
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… Copied!';
            btn.classList.add('bg-green-500/20');
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove('bg-green-500/20');
            }, 2000);
          } else {
            // Fallback for history cards
            alert('Copied to clipboard!');
          }
        }).catch(err => {
          alert('Failed to copy: ' + err.message);
        });
      }
    }

    function editPost(index) {
      const post = posts[index];
      if (post) {
        currentPost = post;
        showSection('generate');
        
        // Clean content - remove any existing "Improve this post:" prefix
        const cleanText = cleanContent(post.content);
        document.getElementById('topic-input').value = 'Improve this post to score 90+:\n\n' + cleanText;
        
        setTimeout(() => {
          document.getElementById('topic-input').focus();
          document.getElementById('topic-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }

    function copyToClipboard() {
      if (currentPost) {
        const cleanText = cleanContent(currentPost.content);
        navigator.clipboard.writeText(cleanText).then(() => {
          const btn = event.target;
          const originalText = btn.innerHTML;
          btn.innerHTML = 'âœ… Copied!';
          btn.disabled = true;
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        });
      }
    }

    function improvePost() {
      if (currentPost) {
        // Set the improving post context (for hybrid history pattern)
        // This tells handleGenerate to UPDATE instead of INSERT
        improvingPost = {
          post_id: currentPost.id || currentPost.post_id,
          version: currentPost.version || 1,
          original_score: currentPost.virality_score
        };
        logger.log('ğŸ“ [Improve] Setting improvingPost:', improvingPost);
        
        showSection('generate');
        
        // Clean content - remove any existing "Improve this post:" prefix
        const cleanText = cleanContent(currentPost.content);
        document.getElementById('topic-input').value = 'Improve this post to score 90+:\n\n' + cleanText;
        
        setTimeout(() => {
          document.getElementById('topic-input').focus();
          document.getElementById('topic-input').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    }
    
    // Edit the current post content directly
    function editCurrentPost() {
      if (!currentPost) return;
      
      // Create an editable modal for the post
      const modal = document.createElement('div');
      modal.id = 'edit-modal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in-up';
      modal.style.background = 'rgba(0,0,0,0.85)';
      modal.style.backdropFilter = 'blur(8px)';
      
      modal.innerHTML = `
        <div class="glass-card rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-2xl font-bold text-white">âœï¸ Edit Post</h2>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-white text-3xl leading-none shrink-0 transition-colors">&times;</button>
          </div>
          
          <textarea id="edit-post-content" class="w-full h-80 bg-white/5 border border-white/20 rounded-lg p-4 text-white resize-none focus:border-violet-500 focus:outline-none">${currentPost.content.replace(/`/g, '\\`')}</textarea>
          
          <div class="flex gap-4 mt-6">
            <button onclick="closeEditModal()" class="flex-1 py-3 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition-colors">
              Cancel
            </button>
            <button onclick="saveEditedPost()" class="flex-1 py-3 px-4 gradient-button rounded-lg text-white font-semibold">
              ğŸ’¾ Save Changes
            </button>
          </div>
        </div>
      `;
      
      // Click backdrop to close
      modal.onclick = (e) => {
        if (e.target === modal) closeEditModal();
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Focus the textarea
      setTimeout(() => document.getElementById('edit-post-content')?.focus(), 100);
    }
    
    function closeEditModal() {
      const modal = document.getElementById('edit-modal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.2s ease';
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 200);
      }
    }
    
    function saveEditedPost() {
      const textarea = document.getElementById('edit-post-content');
      if (textarea && currentPost) {
        currentPost.content = textarea.value;
        
        // Update the display
        document.getElementById('result-text').textContent = textarea.value;
        
        // Update post in posts array if it exists
        const postIndex = posts.findIndex(p => p.content === currentPost.content || p.timestamp === currentPost.timestamp);
        if (postIndex >= 0) {
          posts[postIndex].content = textarea.value;
        }
        
        // Save to Supabase
        savePostToSupabase(currentPost);
        
        closeEditModal();
        
        // Show success message
        const statusEl = document.getElementById('generate-status');
        if (statusEl) {
          statusEl.textContent = 'âœ… Post updated successfully!';
          statusEl.classList.remove('hidden');
          setTimeout(() => statusEl.classList.add('hidden'), 3000);
        }
      }
    }

    // Save/Download generated image as PNG
    // Uses direct link to backend endpoint which sets Content-Disposition header
    async function saveImage(imageUrl) {
      try {
        // Extract filename from URL
        let originalFilename;
        try {
          const url = new URL(imageUrl, window.location.origin);
          originalFilename = url.pathname.split('/').pop();
        } catch (e) {
          originalFilename = imageUrl.split('/').pop();
        }
        originalFilename = decodeURIComponent(originalFilename);
        
        // Create user-friendly download filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const downloadFilename = `gnx-post-image-${timestamp}.png`;
        
        logger.log('ğŸ“¥ Original file:', originalFilename);
        logger.log('ğŸ“¥ Download as:', downloadFilename);
        
        // Build download URL with custom filename parameter
        // The backend will set Content-Disposition: attachment; filename="gnx-post-image-xxx.png"
        const downloadUrl = `${API_BASE}/api/download-image/${encodeURIComponent(originalFilename)}?download_as=${encodeURIComponent(downloadFilename)}`;
        
        logger.log('ğŸ“¥ Download URL:', downloadUrl);
        
        // Create an invisible iframe to trigger download without leaving the page
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;
        document.body.appendChild(iframe);
        
        // Remove iframe after download starts
        setTimeout(() => {
          document.body.removeChild(iframe);
          logger.log('âœ… Download initiated:', downloadFilename);
        }, 2000);
        
        // Show success feedback
        const statusEl = document.getElementById('generate-status');
        if (statusEl) {
          statusEl.textContent = `âœ… Downloading: ${downloadFilename}`;
          statusEl.classList.remove('hidden');
          setTimeout(() => statusEl.classList.add('hidden'), 4000);
        }
        
      } catch (error) {
        logger.error('âŒ Download failed:', error);
        
        // Fallback: open image in new tab
        const fullUrl = imageUrl.startsWith('/') ? API_BASE + imageUrl : imageUrl;
        window.open(fullUrl, '_blank');
        alert('Auto-download failed. Image opened in new tab - right-click to save.');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT & KEYBOARD SHORTCUTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Session timeout configuration (30 minutes = 1800000ms)
    const SESSION_TIMEOUT_MS = 30 * 60 * 1000;
    let sessionTimeoutId = null;
    let lastActivityTime = Date.now();
    
    // Reset session timeout on user activity
    function resetSessionTimeout() {
      lastActivityTime = Date.now();
      
      if (sessionTimeoutId) {
        clearTimeout(sessionTimeoutId);
      }
      
      if (currentUser) {
        sessionTimeoutId = setTimeout(() => {
          // Check if user is still logged in and inactive
          if (currentUser && (Date.now() - lastActivityTime >= SESSION_TIMEOUT_MS)) {
            showNotification('Session expired due to inactivity. Logging out...', 'info');
            // Delay logout slightly so notification is visible
            setTimeout(() => handleLogout(), 2000);
          }
        }, SESSION_TIMEOUT_MS);
      }
    }
    
    // Track user activity for session management
    ['click', 'keypress', 'scroll', 'mousemove'].forEach(eventType => {
      document.addEventListener(eventType, () => {
        if (currentUser) {
          lastActivityTime = Date.now();
        }
      }, { passive: true });
    });
    
    document.addEventListener('DOMContentLoaded', () => {
      // SECURITY: No test logins or backdoors
      // All authentication must go through Clerk
      
      // Wire up persona toggle change listener
      const personaToggle = document.getElementById('persona-toggle');
      if (personaToggle) {
        personaToggle.addEventListener('change', () => {
          if (currentUser) {
            currentUser.role = personaToggle.checked ? 'admin' : 'user';
            updatePersonaUI();
            updateAdminLinkedInUI();
          }
        });
      }
      
      // Initialize textarea auto-resize and word counter
      initTextarea();
      
      // Start session timeout monitoring
      resetSessionTimeout();
    });

    // Keyboard shortcuts for power users
    document.addEventListener('keydown', (e) => {
      // Only if logged in
      if (!currentUser) return;
      
      if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
          case 'g':
            e.preventDefault();
            showSection('generate');
            setTimeout(() => document.getElementById('topic-input').focus(), 100);
            break;
          case 'h':
            e.preventDefault();
            showSection('history');
            break;
          case 'd':
            e.preventDefault();
            showSection('dashboard');
            break;
        }
      }
      
      // Escape to close modal
      if (e.key === 'Escape') {
        closeModal();
      }
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZE CLERK AUTH ON PAGE LOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    initializeClerk();
  </script>

</body>
</html>
