name: Auto-Merge CI/CD PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    # Only auto-merge if:
    # 1. PR author is the repo owner
    # 2. PR title starts with fix(cicd), chore(cicd), or feat(cicd)
    # 3. NOT a bug fix (contains 'bug' or 'critical')
    if: |
      github.event.pull_request.user.login == github.repository_owner &&
      (
        startsWith(github.event.pull_request.title, 'fix(cicd)') ||
        startsWith(github.event.pull_request.title, 'chore(cicd)') ||
        startsWith(github.event.pull_request.title, 'feat(cicd)')
      ) &&
      !contains(github.event.pull_request.title, 'bug') &&
      !contains(github.event.pull_request.title, 'critical') &&
      !contains(github.event.pull_request.labels.*.name, 'do-not-merge')

    steps:
      - name: Wait for PR to be ready
        run: sleep 5

      - name: Enable GitHub auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
              // Get PR node ID for GraphQL
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Enable auto-merge using GraphQL (REST API doesn't support this)
              const mutation = `
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                pullRequestId: pr.node_id,
                mergeMethod: 'SQUASH'
              });
              
              console.log('Auto-merge enabled successfully');
            } catch (error) {
              console.error('Failed to enable auto-merge:', error);
              core.setFailed(`Auto-merge failed: ${error.message}`);
            }
      - name: Comment on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– **Auto-merged successfully!**\n\nThis CI/CD PR was automatically merged because:\n- âœ… Author is repo owner\n- âœ… Title starts with `fix(cicd)`, `chore(cicd)`, or `feat(cicd)`\n- âœ… Not labeled as bug/critical\n- âœ… All checks passed\n\nDeployment will trigger automatically via Cloud Build.'
            });

      - name: Handle merge failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âš ï¸ **Auto-merge blocked**\n\nThis PR could not be auto-merged. Possible reasons:\n- âŒ Merge conflicts\n- âŒ Failed checks\n- âŒ Manual review required\n\nPlease review and merge manually.'
            });

  # Safety check - prevent auto-merge of breaking changes
  safety-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == github.repository_owner
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for breaking changes
        id: breaking-check
        run: |
          # Check if cloudbuild.yaml has major changes
          if git diff HEAD~1 cloudbuild.yaml | grep -E "^-.*substitutions:|^-.*availableSecrets:"; then
            echo "breaking=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "breaking=false" >> $GITHUB_OUTPUT

      - name: Label if breaking
        if: steps.breaking-check.outputs.breaking == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['do-not-merge', 'breaking-change']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸš¨ **Breaking Change Detected**\n\nThis PR modifies critical Cloud Build configuration.\n\n**Auto-merge disabled** - Manual review required.\n\nReview changes carefully before merging.'
            });
