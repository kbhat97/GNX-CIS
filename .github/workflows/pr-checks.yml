name: PR Quality Gates

on:
  pull_request:
    branches: [master]

jobs:
  quality-checks:
    name: Lint, Type Check & Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pyright bandit
          pip install -r requirements.txt || true

      - name: Run Ruff (Lint)
        run: ruff check . || true

      - name: Run MyPy (Type Check)
        run: mypy . || true

      - name: Run Bandit (Security)
        run: bandit -r . -ll || true

  secret-scan:
    name: Secret Scanning & Leak Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan for sensitive patterns
        run: |
          echo "Scanning for API keys and tokens..."
          ! grep -r "AIzaSy[A-Za-z0-9_-]{33}" . --exclude-dir=.git || (echo "Found Google API key!" && exit 1)
          ! grep -r "sk-proj-[A-Za-z0-9]{100,}" . --exclude-dir=.git || (echo "Found OpenAI key!" && exit 1)
          ! grep -r "sk_test_[A-Za-z0-9]{40,}" . --exclude-dir=.git || (echo "Found Clerk test key!" && exit 1)
          echo "No secrets found!"

  unit-tests:
    name: Unit Tests - Diversity System
    runs-on: ubuntu-latest
    needs: [quality-checks, secret-scan]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt || true

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short || echo "Tests not yet implemented"
