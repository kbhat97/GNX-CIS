name: Auto-Create PR

on:
  push:
    branches:
      - "fix/**"
      - "feat/**"
      - "chore/**"
      - "docs/**"

jobs:
  create-pr:
    runs-on: ubuntu-latest
    # Don't create PR if one already exists for this branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (pulls.data.length > 0) {
              console.log(`PR already exists for branch ${branch}`);
              core.setOutput('exists', 'true');
              core.setOutput('pr_number', pulls.data[0].number);
            } else {
              console.log(`No PR exists for branch ${branch}`);
              core.setOutput('exists', 'false');
            }

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');

            // Get latest commit message
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: branch,
              per_page: 1
            });

            const commitMessage = commits[0].commit.message;
            const prTitle = `PR: ${branch}`;

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: branch,
              base: 'master',
              body: `## Automated Pull Request\n\n**Branch:** \`${branch}\`\n**Latest commit:** ${commitMessage.split('\n')[0]}\n\n### Deployment Pipeline\n- âœ… Automated checks will run\n- âœ… Will auto-merge after checks pass\n- ğŸš€ Cloud Build will deploy to production\n\n---\n_This PR was created automatically by GitHub Actions._`
            });

            console.log(`Created PR #${pr.number}`);
            core.setOutput('pr_number', pr.number);

      - name: Comment on PR
        if: steps.create-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pr_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ğŸ¤– **Automated PR Created**\n\n**Next Steps:**\n1. â³ Automated checks will run\n2. âœ… PR will auto-merge when checks pass\n3. ğŸš€ Cloud Build deploys to Google Cloud Run\n4. ğŸ“§ Slack/Email notifications sent\n\n**Estimated deployment time:** 5-8 minutes from merge`
            });
