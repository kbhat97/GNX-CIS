name: Auto-Create PR and Deploy

on:
  push:
    branches:
      - "fix/**"
      - "feat/**"
      - "chore/**"
      - "docs/**"

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: master
          title: "Auto PR: ${{ github.ref_name }}"
          body: |
            ## Automated Pull Request

            **Branch:** `${{ github.ref_name }}`
            **Triggered by:** Push to branch

            ### Changes
            - See commit history for details

            ### Deployment
            - âœ… Will auto-merge after checks pass
            - ðŸš€ Cloud Build will deploy to production

            ---
            _This PR was created automatically. It will merge after all checks pass._
          labels: auto-pr
          draft: false

      - name: Enable Auto-Merge
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};

            // Enable auto-merge with squash
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });

            console.log(`Auto-merge enabled for PR #${prNumber}`);

      - name: Comment on PR
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸ¤– **Automated PR Created**\n\nâœ… This PR will merge automatically\nðŸš€ Deployment to Google Cloud Run will trigger on merge\n\n**Next Steps:**\n1. Checks will run automatically\n2. PR merges to \`master\`\n3. Cloud Build deploys to production\n4. Slack/Email notifications sent`
            });
